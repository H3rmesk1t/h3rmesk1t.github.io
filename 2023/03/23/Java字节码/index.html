<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="前言Java源文件（.java）在经过编译后会变成class文件（.class），class文件有着固定的二进制格式，即字节码。字节码是一套设计用来在Java虚拟机中执行的高度优化的指令集，由十六进制值组成，JVM以两个十六进制为一组，按照字节为单位进行读取。  Java源文件的编译解析流程如下图所示。  字节码结构JVM对于字节码有着严格规范要求，每个字节码文件都要由十部分按照规定的顺序组成，分">
<meta property="og:type" content="article">
<meta property="og:title" content="Java字节码">
<meta property="og:url" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/index.html">
<meta property="og:site_name" content="H3rmesk1t&#39;s Blog">
<meta property="og:description" content="前言Java源文件（.java）在经过编译后会变成class文件（.class），class文件有着固定的二进制格式，即字节码。字节码是一套设计用来在Java虚拟机中执行的高度优化的指令集，由十六进制值组成，JVM以两个十六进制为一组，按照字节为单位进行读取。  Java源文件的编译解析流程如下图所示。  字节码结构JVM对于字节码有着严格规范要求，每个字节码文件都要由十部分按照规定的顺序组成，分">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708089657851-8a16911f-df11-4fe2-b35f-3d97201b2ade.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708087891985-cb874858-522b-4e83-a49b-353928253c19.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708104398855-be6fc49b-6473-48c8-90ac-1e87e75832fe.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708108177749-68e6e5ad-b8df-4374-92ed-a85cff745e0f.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708108426793-9d1d20db-8791-4a18-9891-1edc53e87af0.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708109003323-093f8409-bd68-49de-b5f3-c9e565d51afd.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708156649121-ffcff39a-92b5-4fd8-8b5a-0e5f46b23817.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708156768651-49c4f078-0cd7-4373-a95f-d046b52da4e9.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708157930863-446d4ca2-4ed6-4cbf-90e1-b775eecd0288.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708157814940-47f8d0fa-1765-43ef-af6b-ddfd35e9e82e.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708156113167-50cce0f6-2e39-4816-8608-1b3f560331b0.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708090817320-6310cec4-5bb6-42ea-bf44-84bedad7d845.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708091018830-ff219ceb-0a75-4a51-b697-8e518db35159.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708169359643-841308ff-798f-4a1a-a234-8b56f3764261.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708169593678-7ea4f5c5-9ed6-4c82-b7e3-ce04da58e68a.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708177827947-652074b4-5029-4ddc-8503-7d2237c74834.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708181575896-71234150-f524-48e1-b3e3-ea7bf3e1da1e.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708185647344-9b8f473c-b33b-47ec-8c24-31b25c696af8.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708266155944-5b0f4f47-4fdb-4fa0-8418-a74bf87b985f.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708267501928-a7248c3a-2ead-477a-a047-b528fffb3822.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708273805127-1b7e0584-523e-435a-a37d-9b0a7261bb83.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708274302912-7cb8385c-1ace-41f6-a23c-cbfe95163868.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708277536181-31cea8e4-d52b-44c6-a651-4c7d36972626.png">
<meta property="article:published_time" content="2023-03-23T06:52:00.000Z">
<meta property="article:modified_time" content="2024-12-19T04:20:33.891Z">
<meta property="article:author" content="H3rmesk1t">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708089657851-8a16911f-df11-4fe2-b35f-3d97201b2ade.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/my-logo.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/my-logo-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/my-logo.png">
        
      
    
    <!-- title -->
    <title>Java字节码</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="H3rmesk1t&#39;s Blog" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/04/14/ClassLoader/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/03/13/%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&text=Java字节码"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&title=Java字节码"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&is_video=false&description=Java字节码"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Java字节码&body=Check out this article: https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&title=Java字节码"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&title=Java字节码"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&title=Java字节码"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&title=Java字节码"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&name=Java字节码&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&t=Java字节码"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">字节码结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AD%94%E6%95%B0"><span class="toc-number">2.1.</span> <span class="toc-text">魔数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="toc-number">2.2.</span> <span class="toc-text">版本号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E9%87%8F%E6%B1%A0"><span class="toc-number">2.3.</span> <span class="toc-text">常量池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%A0%87%E8%AE%B0"><span class="toc-number">2.4.</span> <span class="toc-text">访问标记</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E7%B4%A2%E5%BC%95"><span class="toc-number">2.5.</span> <span class="toc-text">类索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E7%B1%BB%E7%B4%A2%E5%BC%95"><span class="toc-number">2.6.</span> <span class="toc-text">超类索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E8%A1%A8%E7%B4%A2%E5%BC%95"><span class="toc-number">2.7.</span> <span class="toc-text">接口表索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E8%A1%A8"><span class="toc-number">2.8.</span> <span class="toc-text">字段表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E8%A1%A8"><span class="toc-number">2.9.</span> <span class="toc-text">方法表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E8%A1%A8"><span class="toc-number">2.10.</span> <span class="toc-text">属性表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">字节码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#javap"><span class="toc-number">3.1.</span> <span class="toc-text">javap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jclasslib"><span class="toc-number">3.2.</span> <span class="toc-text">jclasslib</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E5%A2%9E%E5%BC%BA"><span class="toc-number">4.</span> <span class="toc-text">字节码增强</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ASM"><span class="toc-number">4.1.</span> <span class="toc-text">ASM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ClassReader-ClassVisitor-ClassWriter"><span class="toc-number">4.1.1.</span> <span class="toc-text">ClassReader&amp;ClassVisitor&amp;ClassWriter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E5%92%8C%E8%A7%A3%E6%9E%90%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.1.2.</span> <span class="toc-text">读取和解析字节码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ClassReader%E8%AF%BB%E5%8F%96%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">ClassReader读取字节码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ClassVisitor%E8%A7%A3%E6%9E%90%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">ClassVisitor解析字节码</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.1.3.</span> <span class="toc-text">修改字节码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-%E5%88%A0%E9%99%A4Field"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">添加&amp;删除Field</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-%E5%88%A0%E9%99%A4Method"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">添加&amp;删除Method</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%96%B9%E6%B3%95%E6%8C%87%E4%BB%A4"><span class="toc-number">4.1.3.3.</span> <span class="toc-text">修改方法指令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E7%94%9F%E6%88%90%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.1.3.4.</span> <span class="toc-text">动态生成字节码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Javassist"><span class="toc-number">4.2.</span> <span class="toc-text">Javassist</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#API%E5%92%8C%E6%A0%87%E8%AF%86%E7%AC%A6"><span class="toc-number">4.2.1.</span> <span class="toc-text">API和标识符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.2.2.</span> <span class="toc-text">生成字节码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E7%B1%BB-%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F-%E6%96%B9%E6%B3%95%E4%BF%A1%E6%81%AF"><span class="toc-number">4.2.3.</span> <span class="toc-text">读取类&amp;成员变量&amp;方法信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%B1%BB%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.4.</span> <span class="toc-text">修改类方法</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Java字节码
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">H3rmesk1t</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-03-23T06:52:00.000Z" class="dt-published" itemprop="datePublished">2023-03-23</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Java/">Java</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Java/" rel="tag">Java</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><font style="color:rgb(51, 51, 51);">Java</font><font style="color:rgb(51, 51, 51);">源文件（</font><font style="color:rgb(51, 51, 51);"><em>.java</font><font style="color:rgb(51, 51, 51);">）在经过编译后会变成</font><font style="color:rgb(51, 51, 51);">class</font><font style="color:rgb(51, 51, 51);">文件（</font><font style="color:rgb(51, 51, 51);"></em>.class</font><font style="color:rgb(51, 51, 51);">），</font><font style="color:rgb(51, 51, 51);">class</font><font style="color:rgb(51, 51, 51);">文件有着固定的二进制格式，即字节码。字节码是一套设计用来在</font><font style="color:rgb(51, 51, 51);">Java</font><font style="color:rgb(51, 51, 51);">虚拟机中执行的高度优化的指令集，由十六进制值组成，</font><font style="color:rgb(51, 51, 51);">JVM</font><font style="color:rgb(51, 51, 51);">以两个十六进制为一组，按照字节为单位进行读取。</font></p>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708089657851-8a16911f-df11-4fe2-b35f-3d97201b2ade.png"></p>
<p>Java源文件的编译解析流程如下图所示。</p>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708087891985-cb874858-522b-4e83-a49b-353928253c19.png"></p>
<h2 id="字节码结构"><a href="#字节码结构" class="headerlink" title="字节码结构"></a>字节码结构</h2><p>JVM对于字节码有着严格规范要求，每个字节码文件都要由十部分按照规定的顺序组成，分别为魔数（magic）、版本号（version）、常量池（constant pool）、访问标记（access flag）、类索引（this class）、超类索引（super class）、接口表索引（interface）、字段表（fields）、方法表（methods）和属性表（attributes）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4             magic;</span><br><span class="line">    u2             minor_version;</span><br><span class="line">    u2             major_version;</span><br><span class="line">    u2             constant_pool_count;</span><br><span class="line">    cp_info        constant_pool[constant_pool_count-1];</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             this_class;</span><br><span class="line">    u2             super_class;</span><br><span class="line">    u2             interfaces_count;</span><br><span class="line">    u2             interfaces[interfaces_count];</span><br><span class="line">    u2             fields_count;</span><br><span class="line">    field_info     fields[fields_count];</span><br><span class="line">    u2             methods_count;</span><br><span class="line">    method_info    methods[methods_count];</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="魔数"><a href="#魔数" class="headerlink" title="魔数"></a>魔数</h3><p>所有的class文件的前四个字节都是魔数，固定值为0xCAFEBABE，JVM可以根据文件的开头来判断这个文件是否可能是一个class文件，判断通过后才会进行后续的操作。</p>
<h3 id="版本号"><a href="#版本号" class="headerlink" title="版本号"></a>版本号</h3><p>魔数之后的四个字节为版本号，前两个字节表示次版本号（Minor Version），后两个字节表示主版本号（Major Version）。例如00 00 00 34中次版本号转换成十进制为0，主版本号转换成十进制为52，所以编译该文件的JDK版本号为1.8。</p>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708104398855-be6fc49b-6473-48c8-90ac-1e87e75832fe.png"></p>
<h3 id="常量池"><a href="#常量池" class="headerlink" title="常量池"></a>常量池</h3><p>版本号后的字节为常量池，常量池中存储着两类常量，分别是字面量与符号引用。<font style="color:rgb(51, 51, 51);">字面量为代码中声明为</font><font style="color:rgb(51, 51, 51);">Final</font><font style="color:rgb(51, 51, 51);">的常量值，符号引用为类和接口的全局限定名、字段的名称和描述符、方法的名称和描述符。</font></p>
<p><font style="color:rgb(51, 51, 51);">常量池分为两部分，分别为常量池计数器和常量池数据区。</font></p>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708108177749-68e6e5ad-b8df-4374-92ed-a85cff745e0f.png"></p>
<ul>
<li>常量池计数器（constant_pool_count）：由于常量的数量不固定，所以需要先放置两个字节来表示常量池容量计数值。例如字节码前10个字节为CA FE BA BE 00 00 00 34 00 24，将十六进制的24转化为十进制值为36，排除掉下标0，也就是说，这个类文件中共有35个常量。</li>
<li>常量池数据区：数据区是由（constant_pool_count-1）个cp_info结构组成，一个cp_info结构对应一个常量。在字节码中共有14种类型的cp_info，每种类型的结构都是固定的。</li>
</ul>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708108426793-9d1d20db-8791-4a18-9891-1edc53e87af0.png"></p>
<h3 id="访问标记"><a href="#访问标记" class="headerlink" title="访问标记"></a>访问标记</h3><p>常量池结束之后的两个字节为访问标记，描述该Class是类还是接口，以及是否被Public、Abstract、Final等修饰符修饰。JVM并没有穷举所有的访问标志，而是使用按位或操作来进行描述，例如某个类的修饰符为Public Final，则对应的访问修饰符的值为ACC_PUBLIC|ACC_FINAL，即0x0001|0x0010&#x3D;0x0011。</p>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708109003323-093f8409-bd68-49de-b5f3-c9e565d51afd.png"></p>
<h3 id="类索引"><a href="#类索引" class="headerlink" title="类索引"></a>类索引</h3><p>访问标志后的两个字节为当前类名，描述的是当前类的全限定名。这两个字节保存的值为常量池中的索引位置，根据索引位置就能在常量池中找到这个类的全限定名。</p>
<h3 id="超类索引"><a href="#超类索引" class="headerlink" title="超类索引"></a>超类索引</h3><p>类索引后的两个字节为超类索引，描述父类的全限定名，与类索引一样，超类索引保存的也是常量池中的索引值。</p>
<h3 id="接口表索引"><a href="#接口表索引" class="headerlink" title="接口表索引"></a>接口表索引</h3><p>超类索引后的两个字节为的接口索引表，描述了该类或父类实现的接口数量，紧接着的n个字节是所有接口名称的字符串常量的索引值。</p>
<h3 id="字段表"><a href="#字段表" class="headerlink" title="字段表"></a>字段表</h3><p>字段表用于描述类和接口中声明的变量，包含类级别的变量以及实例变量，但是不包含方法内部声明的局部变量。字段表也分为两部分，第一部分为两个字节，描述字段个数；第二部分是每个字段的详细信息fields_info。</p>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708156649121-ffcff39a-92b5-4fd8-8b5a-0e5f46b23817.png"></p>
<p>字段的访问标记共有9种，例如public static final int DEFAULT_NUM &#x3D; 0，其访问标记的值为0x0019，由ACC_PUBLIC|ACC_STATIC|ACC_FINAL组成。</p>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708156768651-49c4f078-0cd7-4373-a95f-d046b52da4e9.png"></p>
<p>对于第三部分的字段描述符，其用来表示某个字段的类型，在JVM中，根据字段类型的不同，字段描述符主要分为以下几种：</p>
<ul>
<li>基本数据类型：byte-B、char-C、double-D、float-F、int-I、long-J、short-S、boolean-Z</li>
<li>特殊类型：void-V</li>
<li>对象类型：描述符用字符L;加上对象的全限定名来表示，为了防止多个连续的引用类型描述符出现混淆，引用类型描述符最后都加了一个;作为结束，比如字符串类型String的描述符为Ljava&#x2F;lang&#x2F;String;</li>
<li>数组类型：JVM使用一个前置的[来表示数组类型，例如，int[]类型的描述符为[I，字符串数组String[]的描述符为[Ljava&#x2F;lang&#x2F;String;，每增加一个维度则在对应的字段描述符前增加一个[，比如，Object[][][]类型的描述符为[[[Ljava&#x2F;lang&#x2F;Object;</li>
</ul>
<h3 id="方法表"><a href="#方法表" class="headerlink" title="方法表"></a>方法表</h3><p>字段表结束后的为方法表，方法表也是由两部分组成，第一部分为两个字节，描述方法的个数；第二部分为每个方法的详细信息methods_info。方法的详细信息较为复杂，包括访问标记、方法名索引、方法描述符索引以及方法的属性。</p>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708157930863-446d4ca2-4ed6-4cbf-90e1-b775eecd0288.png"></p>
<p>方法的访问标记共有12种，例如private static synchronized void demo，其访问标记的值为0x002a，由ACC_PRIVATE|ACC_STATIC|ACC_SYNCHRONIZED组成。</p>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708157814940-47f8d0fa-1765-43ef-af6b-ddfd35e9e82e.png"></p>
<p>对于第三部分的字段描述符，其格式如下：(参数1类型 参数2类型 参数3类型 … )返回值类型，例如，方法Object demo(int i, double d, String s)的描述符为(IDLjava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;Object;。</p>
<h3 id="属性表"><a href="#属性表" class="headerlink" title="属性表"></a>属性表</h3><p>属性表是class文件的最后一部分内容，属性出现的地方比较广泛，除了字段和方法中，在顶层的class文件中也会出现，该项存放了在该文件中类或接口所定义属性的基本信息。</p>
<h2 id="字节码解析"><a href="#字节码解析" class="headerlink" title="字节码解析"></a>字节码解析</h2><h3 id="javap"><a href="#javap" class="headerlink" title="javap"></a>javap</h3><p>在Java中内置一个反编译命令javap，使用javap可以反编译class文件，将二进制格式的字节码转换成易于理解的格式，从而来查看一个类的结构，包括构造方法、方法、字段等。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javap &lt;options&gt; &lt;classes&gt;</span><br><span class="line"><span class="comment"># 常用方法</span></span><br><span class="line">javap -c -l -v Bytecode.class</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">❯ javap -<span class="built_in">help</span></span><br><span class="line">用法: javap &lt;options&gt; &lt;classes&gt;</span><br><span class="line">其中, 可能的选项包括:</span><br><span class="line">  -<span class="built_in">help</span>  --<span class="built_in">help</span>  -?        输出此用法消息</span><br><span class="line">  -version                 版本信息</span><br><span class="line">  -v  -verbose             输出附加信息</span><br><span class="line">  -l                       输出行号和本地变量表</span><br><span class="line">  -public                  仅显示公共类和成员</span><br><span class="line">  -protected               显示受保护的/公共类和成员</span><br><span class="line">  -package                 显示程序包/受保护的/公共类</span><br><span class="line">                           和成员 (默认)</span><br><span class="line">  -p  -private             显示所有类和成员</span><br><span class="line">  -c                       对代码进行反汇编</span><br><span class="line">  -s                       输出内部类型签名</span><br><span class="line">  -sysinfo                 显示正在处理的类的</span><br><span class="line">                           系统信息 (路径, 大小, 日期, MD5 散列)</span><br><span class="line">  -constants               显示最终常量</span><br><span class="line">  -classpath &lt;path&gt;        指定查找用户类文件的位置</span><br><span class="line">  -<span class="built_in">cp</span> &lt;path&gt;               指定查找用户类文件的位置</span><br><span class="line">  -bootclasspath &lt;path&gt;    覆盖引导类文件的位置</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708156113167-50cce0f6-2e39-4816-8608-1b3f560331b0.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">❯ javap -c -l -v Bytecode.class</span><br><span class="line">Classfile /Users/alphag0/Desktop/Bytecode.class</span><br><span class="line">  Last modified 2024-2-16; size 487 bytes</span><br><span class="line">  MD5 checksum f48d6d0524598aa13585226cdb2ff798</span><br><span class="line">  Compiled from <span class="string">&quot;Bytecode.java&quot;</span></span><br><span class="line">public class Bytecode</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   <span class="comment">#1 = Methodref          #8.#21         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   <span class="comment">#2 = String             #22            // H3rmesk1t</span></span><br><span class="line">   <span class="comment">#3 = Fieldref           #7.#23         // Bytecode.name:Ljava/lang/String;</span></span><br><span class="line">   <span class="comment">#4 = Fieldref           #7.#24         // Bytecode.age:I</span></span><br><span class="line">   <span class="comment">#5 = Fieldref           #25.#26        // java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">   <span class="comment">#6 = Methodref          #27.#28        // java/io/PrintStream.println:(I)V</span></span><br><span class="line">   <span class="comment">#7 = Class              #29            // Bytecode</span></span><br><span class="line">   <span class="comment">#8 = Class              #30            // java/lang/Object</span></span><br><span class="line">   <span class="comment">#9 = Utf8               name</span></span><br><span class="line">  <span class="comment">#10 = Utf8               Ljava/lang/String;</span></span><br><span class="line">  <span class="comment">#11 = Utf8               age</span></span><br><span class="line">  <span class="comment">#12 = Utf8               I</span></span><br><span class="line">  <span class="comment">#13 = Utf8               &lt;init&gt;</span></span><br><span class="line">  <span class="comment">#14 = Utf8               ()V</span></span><br><span class="line">  <span class="comment">#15 = Utf8               Code</span></span><br><span class="line">  <span class="comment">#16 = Utf8               LineNumberTable</span></span><br><span class="line">  <span class="comment">#17 = Utf8               add</span></span><br><span class="line">  <span class="comment">#18 = Utf8               ()I</span></span><br><span class="line">  <span class="comment">#19 = Utf8               SourceFile</span></span><br><span class="line">  <span class="comment">#20 = Utf8               Bytecode.java</span></span><br><span class="line">  <span class="comment">#21 = NameAndType        #13:#14        // &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  <span class="comment">#22 = Utf8               H3rmesk1t</span></span><br><span class="line">  <span class="comment">#23 = NameAndType        #9:#10         // name:Ljava/lang/String;</span></span><br><span class="line">  <span class="comment">#24 = NameAndType        #11:#12        // age:I</span></span><br><span class="line">  <span class="comment">#25 = Class              #31            // java/lang/System</span></span><br><span class="line">  <span class="comment">#26 = NameAndType        #32:#33        // out:Ljava/io/PrintStream;</span></span><br><span class="line">  <span class="comment">#27 = Class              #34            // java/io/PrintStream</span></span><br><span class="line">  <span class="comment">#28 = NameAndType        #35:#36        // println:(I)V</span></span><br><span class="line">  <span class="comment">#29 = Utf8               Bytecode</span></span><br><span class="line">  <span class="comment">#30 = Utf8               java/lang/Object</span></span><br><span class="line">  <span class="comment">#31 = Utf8               java/lang/System</span></span><br><span class="line">  <span class="comment">#32 = Utf8               out</span></span><br><span class="line">  <span class="comment">#33 = Utf8               Ljava/io/PrintStream;</span></span><br><span class="line">  <span class="comment">#34 = Utf8               java/io/PrintStream</span></span><br><span class="line">  <span class="comment">#35 = Utf8               println</span></span><br><span class="line">  <span class="comment">#36 = Utf8               (I)V</span></span><br><span class="line">&#123;</span><br><span class="line">  public int age;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line"></span><br><span class="line">  public Bytecode();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial <span class="comment">#1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         4: aload_0</span><br><span class="line">         5: ldc           <span class="comment">#2                  // String H3rmesk1t</span></span><br><span class="line">         7: putfield      <span class="comment">#3                  // Field name:Ljava/lang/String;</span></span><br><span class="line">        10: aload_0</span><br><span class="line">        11: bipush        21</span><br><span class="line">        13: putfield      <span class="comment">#4                  // Field age:I</span></span><br><span class="line">        16: <span class="built_in">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line">        line 2: 4</span><br><span class="line">        line 3: 10</span><br><span class="line"></span><br><span class="line">  public int add();</span><br><span class="line">    descriptor: ()I</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=2, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: getfield      <span class="comment">#4                  // Field age:I</span></span><br><span class="line">         4: iconst_1</span><br><span class="line">         5: iadd</span><br><span class="line">         6: istore_1</span><br><span class="line">         7: getstatic     <span class="comment">#5                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">        10: iload_1</span><br><span class="line">        11: invokevirtual <span class="comment">#6                  // Method java/io/PrintStream.println:(I)V</span></span><br><span class="line">        14: iload_1</span><br><span class="line">        15: ireturn</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 6: 0</span><br><span class="line">        line 7: 7</span><br><span class="line">        line 8: 14</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: <span class="string">&quot;Bytecode.java&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="jclasslib"><a href="#jclasslib" class="headerlink" title="jclasslib"></a>jclasslib</h3><p>相较于javap命令，jclasslib作为一个插件，能够可视化呈现反编译结果，同时还提供了修改jar包中的class文件的API。</p>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708090817320-6310cec4-5bb6-42ea-bf44-84bedad7d845.png"></p>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708091018830-ff219ceb-0a75-4a51-b697-8e518db35159.png"></p>
<h2 id="字节码增强"><a href="#字节码增强" class="headerlink" title="字节码增强"></a>字节码增强</h2><h3 id="ASM"><a href="#ASM" class="headerlink" title="ASM"></a>ASM</h3><p>Java字节码库允许我们通过字节码库的API动态创建或修改Java类、方法、变量等操作而被广泛使用。ASM是一种通用Java字节码操作和分析框架，它可以直接以二进制形式修改一个现有的类或动态生成类文件。</p>
<p>ASM字节码处理流程：目标类class bytes-&gt;ClassReader解析-&gt;ClassVisitor增强修改字节码-&gt;ClassWriter生成增强后的class bytes-&gt;通过Instrumentation解析加载为新的字节码。</p>
<p>ASM框架提供了三个基于ClassVisitor API的核心API，用于生成和转换类：</p>
<ul>
<li>ClassReader：用于解析class文件或二进制流，并将所有字节码传递给ClassWriter</li>
<li>ClassVisitor：抽象类，负责访问class文件的各个元素，可以解析或者修改class文件的内容，自定义ClassVisitor重写visitXXX方法，可获取捕获ASM类结构访问的所有事件</li>
<li>ClassWriter：是ClassVisitor的子类，用于生成类二进制</li>
</ul>
<h4 id="ClassReader-ClassVisitor-ClassWriter"><a href="#ClassReader-ClassVisitor-ClassWriter" class="headerlink" title="ClassReader&amp;ClassVisitor&amp;ClassWriter"></a>ClassReader&amp;ClassVisitor&amp;ClassWriter</h4><p>ClassReader类用于解析类字节码，创建ClassReader对象可传入类名、类字节码数组或者类输入流对象。创建完ClassReader对象会触发字节码解析（解析class基础信息，如常量池、接口信息等），可以直接通过ClassReader对象获取类的基础信息。</p>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708169359643-841308ff-798f-4a1a-a234-8b56f3764261.png"></p>
<p>调用ClassReader类的accpet方法需要传入自定义的ClassVisitor对象，ClassReader会按照如下顺序，依次调用该ClassVisitor的类方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">visit</span><br><span class="line">        [ visitSource ] [ visitModule ][ visitNestHost ][ visitPermittedclass ][ visitOuterClass ]</span><br><span class="line">        ( visitAnnotation | visitTypeAnnotation | visitAttribute )*</span><br><span class="line">        ( visitNestMember | visitInnerClass | visitRecordComponent | visitField | visitMethod )*</span><br><span class="line">visitEnd</span><br></pre></td></tr></table></figure>

<p>ClassWriter直接以二进制形式生成编译后的类，他会生成一个字节数组形式的输出，其中包含了已编译的类，可以调用toByteArray方法来提取。</p>
<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708169593678-7ea4f5c5-9ed6-4c82-b7e3-ce04da58e68a.png"></p>
<h4 id="读取和解析字节码"><a href="#读取和解析字节码" class="headerlink" title="读取和解析字节码"></a>读取和解析字节码</h4><h5 id="ClassReader读取字节码"><a href="#ClassReader读取字节码" class="headerlink" title="ClassReader读取字节码"></a>ClassReader读取字节码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从文件系统中加载字节码</span></span><br><span class="line"><span class="type">byte</span>[] bytecode = Files.readAllBytes(Paths.get(<span class="string">&quot;path/to/MyClass.class&quot;</span>));</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"> <span class="type">FileInputStream</span> <span class="variable">bytecode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;path/to/MyClass.class&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从类加载器中加载字节码</span></span><br><span class="line"><span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> getClass().getClassLoader().getResourceAsStream(<span class="string">&quot;com/example/MyClass.class&quot;</span>);</span><br><span class="line"><span class="type">byte</span>[] bytecode = is.readAllBytes();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建ClassReader实例</span></span><br><span class="line"><span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(bytecode);</span><br></pre></td></tr></table></figure>

<h5 id="ClassVisitor解析字节码"><a href="#ClassVisitor解析字节码" class="headerlink" title="ClassVisitor解析字节码"></a>ClassVisitor解析字节码</h5><ul>
<li>实验类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.asm.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BytecodeTest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;H3rmesk1t&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">22</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Name: &quot;</span> + name);</span><br><span class="line">        System.out.println(<span class="string">&quot;Age: &quot;</span> + age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>访问者类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.asm.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ASMClassVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="comment">// 调用父类构造方法, 使用ASM Opcodes版本</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">ASMClassVisitor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(Opcodes.ASM5);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重写visit方法, 输出类名</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(<span class="type">int</span> version, <span class="type">int</span> access, String name, String signature, String superName, String[] interfaces)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;变量修饰符: &quot;</span> + access + <span class="string">&quot;\t 类名: &quot;</span> + name + <span class="string">&quot;\t 父类名: &quot;</span> + superName + <span class="string">&quot;\t 实现的接口: &quot;</span> + Arrays.toString(interfaces));</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------------------------------------------------------&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.visit(version, access, name, signature, superName, interfaces);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重写visitMethod方法, 输出方法名</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access, String name, String descriptor, String signature, String[] exceptions)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;变量修饰符: &quot;</span> + access + <span class="string">&quot;\t 变量名称: &quot;</span> + name + <span class="string">&quot;\t 描述符: &quot;</span> + descriptor + <span class="string">&quot;\t 抛出的异常: &quot;</span> + Arrays.toString(exceptions));</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.visitMethod(access, name, descriptor, signature, exceptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重写visitField, 输出变量名</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FieldVisitor <span class="title function_">visitField</span><span class="params">(<span class="type">int</span> access, String name, String descriptor, String signature, Object value)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;变量修饰符：&quot;</span> + access + <span class="string">&quot;\t 变量名称：&quot;</span> + name + <span class="string">&quot;\t 描述符：&quot;</span> + descriptor + <span class="string">&quot;\t 默认值：&quot;</span> + value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.visitField(access, name, descriptor, signature, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>主类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.asm.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ASMMain</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 实例化自定义Visitor</span></span><br><span class="line">        <span class="type">ASMClassVisitor</span> <span class="variable">asmClassVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ASMClassVisitor</span>();</span><br><span class="line">        <span class="comment">// 加载字节码</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/Users/alphag0/Desktop/Code/Java/JavaSecCode/src/main/java/org/example/asm/demo/BytecodeTest.class&quot;</span>);</span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(inputStream);</span><br><span class="line">        System.out.println(<span class="string">&quot;解析类名: &quot;</span> + classReader.getClassName() + <span class="string">&quot;，父类: &quot;</span> + classReader.getSuperName() + <span class="string">&quot;，实现接口: &quot;</span> + Arrays.toString(classReader.getInterfaces()));</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------------------------------------------------------&quot;</span>);</span><br><span class="line">        classReader.accept(asmClassVisitor, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708177827947-652074b4-5029-4ddc-8503-7d2237c74834.png"></p>
<h4 id="修改字节码"><a href="#修改字节码" class="headerlink" title="修改字节码"></a>修改字节码</h4><p><font style="color:rgb(51, 51, 51);">使用</font><font style="color:rgb(51, 51, 51);">ClassWriter</font><font style="color:rgb(51, 51, 51);">可以实现类修改功能，使用</font><font style="color:rgb(51, 51, 51);">ASM</font><font style="color:rgb(51, 51, 51);">修改类字节码时如果插入了新的局部变量、字节码，需要重新计算</font><font style="color:rgb(51, 51, 51);">max_stack</font><font style="color:rgb(51, 51, 51);">和</font><font style="color:rgb(51, 51, 51);">max_locals</font><font style="color:rgb(51, 51, 51);">，否则会导致修改后的类文件无法通过</font><font style="color:rgb(51, 51, 51);">JVM</font><font style="color:rgb(51, 51, 51);">校验。</font><font style="color:rgb(51, 51, 51);">ASM</font><font style="color:rgb(51, 51, 51);">提供了内置的自动计算方式，只需在创建</font><font style="color:rgb(51, 51, 51);">ClassWriter</font><font style="color:rgb(51, 51, 51);">的时候传入</font><font style="color:rgb(51, 51, 51);">COMPUTE_FRAMES</font><font style="color:rgb(51, 51, 51);">即可：</font><font style="color:rgb(51, 51, 51);">new ClassWriter(cr, ClassWriter.COMPUTE_FRAMES);</font><font style="color:rgb(51, 51, 51);">。</font></p>
<h5 id="添加-删除Field"><a href="#添加-删除Field" class="headerlink" title="添加&amp;删除Field"></a>添加&amp;删除Field</h5><ul>
<li>访问者类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.asm.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.FieldVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ASMUpdateFieldClassVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String deleteFieldName;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> addFieldAccess;</span><br><span class="line">    <span class="keyword">private</span> String addFieldName;</span><br><span class="line">    <span class="keyword">private</span> String addFieldDesc;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">ASMUpdateFieldClassVisitor</span><span class="params">(ClassVisitor classVisitor, String deleteFieldName, <span class="type">int</span> addFieldAccess, String addFieldName, String addFieldDesc)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(Opcodes.ASM5, classVisitor);</span><br><span class="line">        <span class="built_in">this</span>.deleteFieldName = deleteFieldName;</span><br><span class="line">        <span class="built_in">this</span>.addFieldAccess = addFieldAccess;</span><br><span class="line">        <span class="built_in">this</span>.addFieldName = addFieldName;</span><br><span class="line">        <span class="built_in">this</span>.addFieldDesc = addFieldDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FieldVisitor <span class="title function_">visitField</span><span class="params">(<span class="type">int</span> access, String name, String descriptor, String signature, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(deleteFieldName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(addFieldName)) &#123;</span><br><span class="line">            flag = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.visitField(access, name, descriptor, signature, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitEnd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">            <span class="type">FieldVisitor</span> <span class="variable">fieldVisitor</span> <span class="operator">=</span> <span class="built_in">super</span>.visitField(addFieldAccess, addFieldName, addFieldDesc, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (fieldVisitor != <span class="literal">null</span>) &#123;</span><br><span class="line">                fieldVisitor.visitEnd();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">super</span>.visitEnd();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>主类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.asm.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ASMUpdateFieldMain</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/Users/alphag0/Desktop/Code/Java/JavaSecCode/src/main/java/org/example/asm/demo/BytecodeTest.class&quot;</span>);</span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(inputStream);</span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">classWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(classReader, ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="type">ASMUpdateFieldClassVisitor</span> <span class="variable">asmUpdateFieldClassVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ASMUpdateFieldClassVisitor</span>(classWriter, <span class="string">&quot;age&quot;</span>, Opcodes.ACC_PRIVATE, <span class="string">&quot;sex&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">        classReader.accept(asmUpdateFieldClassVisitor, ClassReader.EXPAND_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;/Users/alphag0/Desktop/Code/Java/JavaSecCode/src/main/java/org/example/asm/demo/BytecodeUpdateFieldTest.class&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] updateByte = classWriter.toByteArray();</span><br><span class="line">        fileOutputStream.write(updateByte);</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">ASMClassVisitor</span> <span class="variable">asmClassVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ASMClassVisitor</span>();</span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(updateByte);</span><br><span class="line">        System.out.println(<span class="string">&quot;解析类名: &quot;</span> + reader.getClassName() + <span class="string">&quot;，父类: &quot;</span> + reader.getSuperName() + <span class="string">&quot;，实现接口: &quot;</span> + Arrays.toString(reader.getInterfaces()));</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------------------------------------------------------&quot;</span>);</span><br><span class="line">        reader.accept(asmClassVisitor, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708181575896-71234150-f524-48e1-b3e3-ea7bf3e1da1e.png"></p>
<h5 id="添加-删除Method"><a href="#添加-删除Method" class="headerlink" title="添加&amp;删除Method"></a>添加&amp;删除Method</h5><ul>
<li>访问者类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.asm.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ASMUpdateMethodClassVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String deleteMethodName;</span><br><span class="line">    <span class="keyword">private</span> String deleteMethodDesc;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> addMethodAccess;</span><br><span class="line">    <span class="keyword">private</span> String addMethodName;</span><br><span class="line">    <span class="keyword">private</span> String addMethodDesc;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">ASMUpdateMethodClassVisitor</span><span class="params">(ClassVisitor classVisitor, String deleteMethodName, String deleteMethodDesc, <span class="type">int</span> addMethodAccess, String addMethodName, String addMethodDesc)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(Opcodes.ASM5, classVisitor);</span><br><span class="line">        <span class="built_in">this</span>.deleteMethodName = deleteMethodName;</span><br><span class="line">        <span class="built_in">this</span>.deleteMethodDesc = deleteMethodDesc;</span><br><span class="line">        <span class="built_in">this</span>.addMethodAccess = addMethodAccess;</span><br><span class="line">        <span class="built_in">this</span>.addMethodName = addMethodName;</span><br><span class="line">        <span class="built_in">this</span>.addMethodDesc = addMethodDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access, String name, String descriptor, String signature, String[] exceptions)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(deleteMethodName) &amp;&amp; descriptor.equals(deleteMethodDesc)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(addMethodName) &amp;&amp; name.equals(addMethodDesc)) &#123;</span><br><span class="line">            flag = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.visitMethod(access, name, descriptor, signature, exceptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitEnd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">methodVisitor</span> <span class="operator">=</span> <span class="built_in">super</span>.visitMethod(addMethodAccess, addMethodName, addMethodDesc, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (methodVisitor != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 访问方法的字节码</span></span><br><span class="line">                methodVisitor.visitCode();</span><br><span class="line">                <span class="comment">// 添加return指令</span></span><br><span class="line">                methodVisitor.visitInsn(Opcodes.RETURN);</span><br><span class="line">                <span class="comment">// 设置方法的最大操作数栈深度和最大局部变量表大小，空方法设置00即可</span></span><br><span class="line">                methodVisitor.visitMaxs(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                methodVisitor.visitEnd();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">super</span>.visitEnd();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>主类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.asm.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ASMUpdateMethodMain</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/Users/alphag0/Desktop/Code/Java/JavaSecCode/src/main/java/org/example/asm/demo/BytecodeTest.class&quot;</span>);</span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(inputStream);</span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">classWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(classReader, ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="type">ASMUpdateMethodClassVisitor</span> <span class="variable">asmUpdateMethodClassVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ASMUpdateMethodClassVisitor</span>(classWriter, <span class="string">&quot;process&quot;</span>, <span class="string">&quot;()V&quot;</span>, Opcodes.ACC_PUBLIC, <span class="string">&quot;newMethod&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">        classReader.accept(asmUpdateMethodClassVisitor, ClassReader.EXPAND_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;/Users/alphag0/Desktop/Code/Java/JavaSecCode/src/main/java/org/example/asm/demo/BytecodeUpdateMethodTest.class&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] updateByte = classWriter.toByteArray();</span><br><span class="line">        fileOutputStream.write(updateByte);</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">ASMClassVisitor</span> <span class="variable">asmClassVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ASMClassVisitor</span>();</span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(updateByte);</span><br><span class="line">        System.out.println(<span class="string">&quot;解析类名: &quot;</span> + reader.getClassName() + <span class="string">&quot;，父类: &quot;</span> + reader.getSuperName() + <span class="string">&quot;，实现接口: &quot;</span> + Arrays.toString(reader.getInterfaces()));</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------------------------------------------------------&quot;</span>);</span><br><span class="line">        reader.accept(asmClassVisitor, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708185647344-9b8f473c-b33b-47ec-8c24-31b25c696af8.png"></p>
<h5 id="修改方法指令"><a href="#修改方法指令" class="headerlink" title="修改方法指令"></a>修改方法指令</h5><p><font style="color:rgb(51, 51, 51);">大多数使用</font><font style="color:rgb(51, 51, 51);">ASM</font><font style="color:rgb(51, 51, 51);">库的目的其实是修改类方法的字节码，在原方法执行的前后动态插入新的</font><font style="color:rgb(51, 51, 51);">Java</font><font style="color:rgb(51, 51, 51);">代码，从而实现类似于</font><font style="color:rgb(51, 51, 51);">AOP</font><font style="color:rgb(51, 51, 51);">的功能。修改类方法字节码的典型应用场景如：</font><font style="color:rgb(51, 51, 51);">APM</font><font style="color:rgb(51, 51, 51);">和</font><font style="color:rgb(51, 51, 51);">RASP</font><font style="color:rgb(51, 51, 51);">；</font><font style="color:rgb(51, 51, 51);">APM</font><font style="color:rgb(51, 51, 51);">需要统计和分析每个类方法的执行时间，而</font><font style="color:rgb(51, 51, 51);">RASP</font><font style="color:rgb(51, 51, 51);">需要在</font><font style="color:rgb(51, 51, 51);">Java</font><font style="color:rgb(51, 51, 51);">底层</font><font style="color:rgb(51, 51, 51);">API</font><font style="color:rgb(51, 51, 51);">方法执行之前插入自身的检测代码，从而实现动态拦截恶意攻击。</font></p>
<p><font style="color:rgb(51, 51, 51);">假设我们需要修改</font><font style="color:#080808;">org.example.asm.demo</font>.<font style="color:#080808;">BytecodeTest</font><font style="color:rgb(51, 51, 51);">类的</font><font style="color:rgb(51, 51, 51);">process</font><font style="color:rgb(51, 51, 51);">方法，实现以下两个需求：</font></p>
<ol>
<li><font style="color:rgb(51, 51, 51);">在原业务逻辑执行前打印出该方法的参数值</font></li>
<li><font style="color:rgb(51, 51, 51);">修改该方法的返回值</font></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改前业务逻辑</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">process</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> str + name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改后业务逻辑</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">process</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    System.out.println(var1);</span><br><span class="line">    <span class="type">String</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="string">&quot;RASP is so cool!&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">var4</span> <span class="operator">=</span> str + name;</span><br><span class="line">    System.out.println(var4);</span><br><span class="line">    <span class="keyword">return</span> var2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.asm.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.commons.AdviceAdapter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ASMModMethodAdapterMain</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/Users/alphag0/Desktop/Code/Java/JavaSecCode/src/main/java/org/example/asm/demo/BytecodeTest.class&quot;</span>);</span><br><span class="line">            <span class="comment">// 创建ClassReader对象, 用于解析类对象，可以根据类名、二进制、输入流的方式创建</span></span><br><span class="line">            <span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(inputStream);</span><br><span class="line">            <span class="comment">// 创建ClassWriter对象, COMPUTE_FRAMES会自动计算max_stack和max_locals</span></span><br><span class="line">            <span class="type">ClassWriter</span> <span class="variable">classWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(classReader, ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用自定义的ClassVisitor访问者对象, 访问该类文件的结构</span></span><br><span class="line">            classReader.accept(<span class="keyword">new</span> <span class="title class_">ClassVisitor</span>(Opcodes.ASM9, classWriter) &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access, String name, String desc, String signature, String[] exceptions)</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (name.equals(<span class="string">&quot;process&quot;</span>)) &#123;</span><br><span class="line">                        <span class="type">MethodVisitor</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="built_in">super</span>.visitMethod(access, name, desc, signature, exceptions);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 创建自定义的MethodVisitor, 修改原方法的字节码</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AdviceAdapter</span>(api, mv, access, name, desc) &#123;</span><br><span class="line">                            <span class="type">int</span> newArgIndex;</span><br><span class="line">                            <span class="comment">// 获取String的ASM Type对象</span></span><br><span class="line">                            <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Type</span> <span class="variable">stringType</span> <span class="operator">=</span> Type.getType(String.class);</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMethodEnter</span><span class="params">()</span> &#123;</span><br><span class="line">                                <span class="comment">// 输出process方法的第一个参数, 因为process是非static方法, 所以0是this, 第一个参数的下标应该是1</span></span><br><span class="line">                                mv.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">                                mv.visitVarInsn(ALOAD, <span class="number">1</span>);</span><br><span class="line">                                mv.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 创建一个新的局部变量, newLocal会计算出这个新局部对象的索引位置</span></span><br><span class="line">                                newArgIndex = newLocal(stringType);</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 压入字符串到栈顶</span></span><br><span class="line">                                mv.visitLdcInsn(<span class="string">&quot;RASP is so cool!&quot;</span>);</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 将&quot;RASP is so cool!&quot;字符串压入到新生成的局部变量中, String var2 = &quot;RASP is so cool!&quot;;</span></span><br><span class="line">                                storeLocal(newArgIndex, stringType);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMethodExit</span><span class="params">(<span class="type">int</span> opcode)</span> &#123;</span><br><span class="line">                                <span class="comment">// 复制栈顶的返回值</span></span><br><span class="line">                                dup();</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 创建一个新的局部变量, 并获取索引位置</span></span><br><span class="line">                                <span class="type">int</span> <span class="variable">returnValueIndex</span> <span class="operator">=</span> newLocal(stringType);</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 将栈顶的返回值压入新生成的局部变量中</span></span><br><span class="line">                                storeLocal(returnValueIndex, stringType);</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 输出process方法的返回值</span></span><br><span class="line">                                mv.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">                                mv.visitVarInsn(ALOAD, returnValueIndex);</span><br><span class="line">                                mv.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 压入方法进入(onMethodEnter)时存入到局部变量的var2值到栈顶</span></span><br><span class="line">                                loadLocal(newArgIndex);</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 返回一个引用类型, 即栈顶的var2字符串, return var2;</span></span><br><span class="line">                                <span class="comment">// 需要特别注意, 不同数据类型应当使用不同的RETURN指令</span></span><br><span class="line">                                mv.visitInsn(ARETURN);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.visitMethod(access, name, desc, signature, exceptions);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;, ClassReader.EXPAND_FRAMES);</span><br><span class="line"></span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;/Users/alphag0/Desktop/Code/Java/JavaSecCode/src/main/java/org/example/asm/demo/BytecodeModMethodAdapterTest.class&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] updateByte = classWriter.toByteArray();</span><br><span class="line">            fileOutputStream.write(updateByte);</span><br><span class="line">            fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">ASMClassVisitor</span> <span class="variable">asmClassVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ASMClassVisitor</span>();</span><br><span class="line">            <span class="type">ClassReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(updateByte);</span><br><span class="line">            System.out.println(<span class="string">&quot;解析类名: &quot;</span> + reader.getClassName() + <span class="string">&quot;，父类: &quot;</span> + reader.getSuperName() + <span class="string">&quot;，实现接口: &quot;</span> + Arrays.toString(reader.getInterfaces()));</span><br><span class="line">            System.out.println(<span class="string">&quot;-----------------------------------------------------------------------------&quot;</span>);</span><br><span class="line">            reader.accept(asmClassVisitor, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708266155944-5b0f4f47-4fdb-4fa0-8418-a74bf87b985f.png"></p>
<h5 id="动态生成字节码"><a href="#动态生成字节码" class="headerlink" title="动态生成字节码"></a>动态生成字节码</h5><p><font style="color:rgb(51, 51, 51);">可以使用</font><font style="color:rgb(51, 51, 51);">ClassWriter</font><font style="color:rgb(51, 51, 51);">来动态创建出一个</font><font style="color:rgb(51, 51, 51);">Java</font><font style="color:rgb(51, 51, 51);">类的二进制文件，然后通过自定义的类加载器就可以将动态生成的类加载到</font><font style="color:rgb(51, 51, 51);">JVM</font><font style="color:rgb(51, 51, 51);">中。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要动态生成的示例代码</span></span><br><span class="line"><span class="keyword">package</span> org.example.asm.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BytecodeCalculatorTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;open -a Calculator&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用ClassWriter生成类字节码</span></span><br><span class="line"><span class="keyword">package</span> org.example.asm.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ASMBytecodeCalculatorMain</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CLASS_NAME</span> <span class="operator">=</span> <span class="string">&quot;org.example.asm.demo.BytecodeCalculatorTest&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CLASS_NAME_ASM</span> <span class="operator">=</span> <span class="string">&quot;org/example/asm/demo/BytecodeCalculatorTest&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] dump() &#123;</span><br><span class="line">        <span class="comment">// 创建ClassWriter用于生成类字节码</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 创建MethodVisitor</span></span><br><span class="line">        MethodVisitor mv;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个字节码版本为JDK1.8的org.example.asm.demo.BytecodeCalculatorTest类</span></span><br><span class="line">        cw.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC + Opcodes.ACC_SUPER, CLASS_NAME_ASM, <span class="literal">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 设置源码文件名</span></span><br><span class="line">        cw.visitSource(<span class="string">&quot;BytecodeCalculatorTest.java&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建默认的构造函数</span></span><br><span class="line">        <span class="type">MethodVisitor</span> <span class="variable">constructor</span> <span class="operator">=</span> cw.visitMethod(Opcodes.ACC_PUBLIC, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        constructor.visitCode();</span><br><span class="line">        constructor.visitVarInsn(Opcodes.ALOAD, <span class="number">0</span>);</span><br><span class="line">        constructor.visitMethodInsn(Opcodes.INVOKESPECIAL, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        constructor.visitInsn(Opcodes.RETURN);</span><br><span class="line">        constructor.visitMaxs(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        constructor.visitEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建execute方法</span></span><br><span class="line">        <span class="type">MethodVisitor</span> <span class="variable">executeMethod</span> <span class="operator">=</span> cw.visitMethod(Opcodes.ACC_PUBLIC + Opcodes.ACC_STATIC, <span class="string">&quot;execute&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        executeMethod.visitCode();</span><br><span class="line">        executeMethod.visitMethodInsn(Opcodes.INVOKESTATIC, <span class="string">&quot;java/lang/Runtime&quot;</span>, <span class="string">&quot;getRuntime&quot;</span>, <span class="string">&quot;()Ljava/lang/Runtime;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        executeMethod.visitLdcInsn(<span class="string">&quot;open -a Calculator&quot;</span>);</span><br><span class="line">        executeMethod.visitMethodInsn(Opcodes.INVOKEVIRTUAL, <span class="string">&quot;java/lang/Runtime&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)Ljava/lang/Process;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        executeMethod.visitInsn(Opcodes.POP);</span><br><span class="line">        executeMethod.visitInsn(Opcodes.RETURN);</span><br><span class="line">        executeMethod.visitMaxs(<span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">        executeMethod.visitEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 完成类的构造</span></span><br><span class="line">        cw.visitEnd();</span><br><span class="line">        <span class="comment">// 获取生成的类的字节码数组</span></span><br><span class="line">        <span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = dump();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建自定义类加载器, 加载ASM创建的类字节码到JVM</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>(ASMBytecodeCalculatorMain.class.getClassLoader()) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.findClass(name);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    <span class="keyword">return</span> defineClass(CLASS_NAME, classBytes, <span class="number">0</span>, classBytes.length);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反射调用通过ASM生成的BytecodeCalculatorTest类的execute方法</span></span><br><span class="line">        classLoader.loadClass(CLASS_NAME).getMethod(<span class="string">&quot;execute&quot;</span>).invoke(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708267501928-a7248c3a-2ead-477a-a047-b528fffb3822.png"></p>
<h3 id="Javassist"><a href="#Javassist" class="headerlink" title="Javassist"></a>Javassist</h3><p>Javassist是一个开源的分析、编辑和创建Java字节码的类库；相比ASM，Javassist提供了更加简单便捷的API，使用Javassist可以像写Java代码一样直接插入Java代码片段，不再需要关注Java底层的字节码的和栈操作，仅需要学会如何使用Javassist的API即可实现字节码编辑。官方教程：<a target="_blank" rel="noopener" href="https://www.javassist.org/tutorial/tutorial.html">Getting Started with Javassist</a>。</p>
<h4 id="API和标识符"><a href="#API和标识符" class="headerlink" title="API和标识符"></a>API和标识符</h4><p>Javassist中提供了很多类似于Java反射机制的API。</p>
<table>
<thead>
<tr>
<th><strong><font style="color:rgb(51, 51, 51);">类</font></strong></th>
<th><strong><font style="color:rgb(51, 51, 51);">描述</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td><font style="color:rgb(51, 51, 51);">ClassPool</font></td>
<td><font style="color:rgb(51, 51, 51);">ClassPool是一个存储CtClass的容器，如果调用</font><font style="background-color:rgb(247, 247, 247);">get</font><font style="color:rgb(51, 51, 51);">方法会搜索并创建一个表示该类的CtClass对象</font></td>
</tr>
<tr>
<td><font style="color:rgb(51, 51, 51);">CtClass</font></td>
<td><font style="color:rgb(51, 51, 51);">CtClass表示的是从ClassPool获取的类对象，可对该类就行读写编辑等操作</font></td>
</tr>
<tr>
<td><font style="color:rgb(51, 51, 51);">CtMethod</font></td>
<td><font style="color:rgb(51, 51, 51);">可读写的类方法对象</font></td>
</tr>
<tr>
<td><font style="color:rgb(51, 51, 51);">CtConstructor</font></td>
<td><font style="color:rgb(51, 51, 51);">可读写的类构造方法对象</font></td>
</tr>
<tr>
<td><font style="color:rgb(51, 51, 51);">CtField</font></td>
<td><font style="color:rgb(51, 51, 51);">可读写的类成员变量对象</font></td>
</tr>
</tbody></table>
<p><font style="color:rgb(51, 51, 51);">Javassist</font><font style="color:rgb(51, 51, 51);">使用了内置的标识符来表示一些特定的含义，例如，</font><font style="color:rgb(51, 51, 51);">$_</font><font style="color:rgb(51, 51, 51);">表示返回值，可以在动态插入类代码的时候使用这些特殊的标识符来表示对应的对象。</font></p>
<table>
<thead>
<tr>
<th><strong><font style="color:rgb(51, 51, 51);">表达式</font></strong></th>
<th><strong><font style="color:rgb(51, 51, 51);">描述</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td>$0, $1, $2, …</td>
<td>this<font style="color:rgb(51, 51, 51);">和方法参数</font></td>
</tr>
<tr>
<td>$args</td>
<td>Object[]<font style="color:rgb(51, 51, 51);">类型的参数数组</font></td>
</tr>
<tr>
<td>$$</td>
<td><font style="color:rgb(51, 51, 51);">所有的参数，如</font>m($$)<font style="color:rgb(51, 51, 51);">等价于</font>m($1,$2,…)</td>
</tr>
<tr>
<td>$cflow(…)</td>
<td><font style="color:rgb(51, 51, 51);">cflow变量</font></td>
</tr>
<tr>
<td>$r</td>
<td><font style="color:rgb(51, 51, 51);">返回类型，用于类型转换</font></td>
</tr>
<tr>
<td>$w</td>
<td><font style="color:rgb(51, 51, 51);">包装类型，用于类型转换</font></td>
</tr>
<tr>
<td>$_</td>
<td><font style="color:rgb(51, 51, 51);">方法返回值</font></td>
</tr>
<tr>
<td>$sig</td>
<td><font style="color:rgb(51, 51, 51);">方法签名，返回</font>java.lang.Class[]<font style="color:rgb(51, 51, 51);">数组类型</font></td>
</tr>
<tr>
<td>$type</td>
<td><font style="color:rgb(51, 51, 51);">返回值类型，</font>java.lang.Class<font style="color:rgb(51, 51, 51);">类型</font></td>
</tr>
<tr>
<td>$class</td>
<td><font style="color:rgb(51, 51, 51);">当前类，</font>java.lang.Class<font style="color:rgb(51, 51, 51);">类型</font></td>
</tr>
</tbody></table>
<h4 id="生成字节码"><a href="#生成字节码" class="headerlink" title="生成字节码"></a>生成字节码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bytecode.javassist.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavassistTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;org.example.bytecode.javassist.demo.JavassistCalculatorTest&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 给ctClass类添加一个string类型的字段为name并初始化该字段</span></span><br><span class="line">            <span class="type">CtField</span> <span class="variable">ctField</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtField</span>(classPool.get(<span class="string">&quot;java.lang.String&quot;</span>), <span class="string">&quot;name&quot;</span>, ctClass);</span><br><span class="line">            ctField.setModifiers(Modifier.PRIVATE);</span><br><span class="line">            ctClass.addField(ctField, CtField.Initializer.constant(<span class="string">&quot;H3rmesk1t&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 生成对应的get/set方法</span></span><br><span class="line">            ctClass.addMethod(CtNewMethod.getter(<span class="string">&quot;getName&quot;</span>, ctField));</span><br><span class="line">            ctClass.addMethod(CtNewMethod.setter(<span class="string">&quot;setName&quot;</span>, ctField));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加无参构造函数</span></span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">ctConstructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, ctClass);</span><br><span class="line">            ctConstructor.setBody(<span class="string">&quot;&#123;name = \&quot;AlphaG0\&quot;;&#125;&quot;</span>);</span><br><span class="line">            ctClass.addConstructor(ctConstructor);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加有参构造函数</span></span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">ctConstructor1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;classPool.get(<span class="string">&quot;java.lang.String&quot;</span>)&#125;, ctClass);</span><br><span class="line">            ctConstructor1.setBody(<span class="string">&quot;&#123;$0.name = $1;&#125;&quot;</span>);</span><br><span class="line">            ctClass.addConstructor(ctConstructor1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加Main函数</span></span><br><span class="line">            <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> CtMethod.make(<span class="string">&quot;public static void main(String[] args) &#123; Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&#125;&quot;</span>, ctClass);</span><br><span class="line">            ctClass.addMethod(ctMethod);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 写入class文件</span></span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;/Users/alphag0/Desktop/Code/Java/JavaSecCode/src/main/java/org/example/bytecode/javassist/JavassistCalculatorTest.class&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] updateByte = ctClass.toBytecode();</span><br><span class="line">            fileOutputStream.write(updateByte);</span><br><span class="line">            fileOutputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708273805127-1b7e0584-523e-435a-a37d-9b0a7261bb83.png"></p>
<h4 id="读取类-成员变量-方法信息"><a href="#读取类-成员变量-方法信息" class="headerlink" title="读取类&amp;成员变量&amp;方法信息"></a>读取类&amp;成员变量&amp;方法信息</h4><p><font style="color:rgb(51, 51, 51);">Javassist</font><font style="color:rgb(51, 51, 51);">读取类信息非常简单，使用</font><font style="color:rgb(51, 51, 51);">ClassPool</font><font style="color:rgb(51, 51, 51);">对象获取到</font><font style="color:rgb(51, 51, 51);">CtClass</font><font style="color:rgb(51, 51, 51);">对象后就可以像使用</font><font style="color:rgb(51, 51, 51);">Java</font><font style="color:rgb(51, 51, 51);">反射</font><font style="color:rgb(51, 51, 51);">API</font><font style="color:rgb(51, 51, 51);">一样去读取类信息。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bytecode.javassist.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavassistClassAccessTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建ClassPool对象</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.get(<span class="string">&quot;org.example.bytecode.javassist.demo.JavassistCalculatorTest&quot;</span>);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;解析类名: &quot;</span> + ctClass.getName() + <span class="string">&quot;\t 父类: &quot;</span> + ctClass.getSuperclass().getName() + <span class="string">&quot;\t 实现接口: &quot;</span> + Arrays.toString(ctClass.getInterfaces()));</span><br><span class="line">            System.out.println(<span class="string">&quot;-----------------------------------------------------------------------------&quot;</span>);</span><br><span class="line">            <span class="comment">// 获取所有的构造方法</span></span><br><span class="line">            CtConstructor[] ctConstructors = ctClass.getDeclaredConstructors();</span><br><span class="line">            <span class="comment">// 获取所有的成员变量</span></span><br><span class="line">            CtField[] ctFields = ctClass.getDeclaredFields();</span><br><span class="line">            <span class="comment">// 获取所有的成员方法</span></span><br><span class="line">            CtMethod[] ctMethods = ctClass.getDeclaredMethods();</span><br><span class="line">            <span class="comment">// 输出所有的构造方法</span></span><br><span class="line">            <span class="keyword">for</span> (CtConstructor ctConstructor : ctConstructors) &#123;</span><br><span class="line">                System.out.println(ctConstructor.getMethodInfo());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;-----------------------------------------------------------------------------&quot;</span>);</span><br><span class="line">            <span class="comment">// 输出所有成员变量</span></span><br><span class="line">            <span class="keyword">for</span> (CtField ctField : ctFields) &#123;</span><br><span class="line">                System.out.println(ctField);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;-----------------------------------------------------------------------------&quot;</span>);</span><br><span class="line">            <span class="comment">// 输出所有的成员方法</span></span><br><span class="line">            <span class="keyword">for</span> (CtMethod ctMethod : ctMethods) &#123;</span><br><span class="line">                System.out.println(ctMethod);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708274302912-7cb8385c-1ace-41f6-a23c-cbfe95163868.png"></p>
<h4 id="修改类方法"><a href="#修改类方法" class="headerlink" title="修改类方法"></a>修改类方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bytecode.javassist.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavassistClassModifyTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.get(<span class="string">&quot;org.example.bytecode.javassist.demo.JavassistCalculatorTest&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">CtMethod</span> <span class="variable">mainMethod</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;main&quot;</span>, <span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;classPool.get(<span class="string">&quot;java.lang.String[]&quot;</span>)&#125;);</span><br><span class="line">            mainMethod.insertBefore(<span class="string">&quot;System.out.println(\&quot;Start...\&quot;);&quot;</span>);</span><br><span class="line">            mainMethod.insertAfter(<span class="string">&quot;System.out.println(\&quot;End...\&quot;);&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> ctClass.toClass().newInstance();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">main</span> <span class="operator">=</span> o.getClass().getMethod(<span class="string">&quot;main&quot;</span>, String[].class);</span><br><span class="line">            main.invoke(o, (Object) <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/1708277536181-31cea8e4-d52b-44c6-a651-4c7d36972626.png"></p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">字节码结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AD%94%E6%95%B0"><span class="toc-number">2.1.</span> <span class="toc-text">魔数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="toc-number">2.2.</span> <span class="toc-text">版本号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E9%87%8F%E6%B1%A0"><span class="toc-number">2.3.</span> <span class="toc-text">常量池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%A0%87%E8%AE%B0"><span class="toc-number">2.4.</span> <span class="toc-text">访问标记</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E7%B4%A2%E5%BC%95"><span class="toc-number">2.5.</span> <span class="toc-text">类索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E7%B1%BB%E7%B4%A2%E5%BC%95"><span class="toc-number">2.6.</span> <span class="toc-text">超类索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E8%A1%A8%E7%B4%A2%E5%BC%95"><span class="toc-number">2.7.</span> <span class="toc-text">接口表索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E8%A1%A8"><span class="toc-number">2.8.</span> <span class="toc-text">字段表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E8%A1%A8"><span class="toc-number">2.9.</span> <span class="toc-text">方法表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E8%A1%A8"><span class="toc-number">2.10.</span> <span class="toc-text">属性表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">字节码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#javap"><span class="toc-number">3.1.</span> <span class="toc-text">javap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jclasslib"><span class="toc-number">3.2.</span> <span class="toc-text">jclasslib</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E5%A2%9E%E5%BC%BA"><span class="toc-number">4.</span> <span class="toc-text">字节码增强</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ASM"><span class="toc-number">4.1.</span> <span class="toc-text">ASM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ClassReader-ClassVisitor-ClassWriter"><span class="toc-number">4.1.1.</span> <span class="toc-text">ClassReader&amp;ClassVisitor&amp;ClassWriter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E5%92%8C%E8%A7%A3%E6%9E%90%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.1.2.</span> <span class="toc-text">读取和解析字节码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ClassReader%E8%AF%BB%E5%8F%96%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">ClassReader读取字节码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ClassVisitor%E8%A7%A3%E6%9E%90%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">ClassVisitor解析字节码</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.1.3.</span> <span class="toc-text">修改字节码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-%E5%88%A0%E9%99%A4Field"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">添加&amp;删除Field</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-%E5%88%A0%E9%99%A4Method"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">添加&amp;删除Method</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%96%B9%E6%B3%95%E6%8C%87%E4%BB%A4"><span class="toc-number">4.1.3.3.</span> <span class="toc-text">修改方法指令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E7%94%9F%E6%88%90%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.1.3.4.</span> <span class="toc-text">动态生成字节码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Javassist"><span class="toc-number">4.2.</span> <span class="toc-text">Javassist</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#API%E5%92%8C%E6%A0%87%E8%AF%86%E7%AC%A6"><span class="toc-number">4.2.1.</span> <span class="toc-text">API和标识符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.2.2.</span> <span class="toc-text">生成字节码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E7%B1%BB-%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F-%E6%96%B9%E6%B3%95%E4%BF%A1%E6%81%AF"><span class="toc-number">4.2.3.</span> <span class="toc-text">读取类&amp;成员变量&amp;方法信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%B1%BB%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.4.</span> <span class="toc-text">修改类方法</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&text=Java字节码"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&title=Java字节码"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&is_video=false&description=Java字节码"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Java字节码&body=Check out this article: https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&title=Java字节码"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&title=Java字节码"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&title=Java字节码"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&title=Java字节码"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&name=Java字节码&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://h3rmesk1t.github.io/2023/03/23/Java%E5%AD%97%E8%8A%82%E7%A0%81/&t=Java字节码"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    H3rmesk1t
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'H3rmesk1t/h3rmesk1t.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = '💬';
      var utterances_theme = 'github-light';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
