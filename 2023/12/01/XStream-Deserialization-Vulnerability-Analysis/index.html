<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="简介XStream是Java类库，提供了所有的基础类型、数组、集合等类型直接转换的支持，用来将对象序列化成XML或反序列化为对象。 基本使用XStream反序列化分析采用依赖版本如下： 12345&lt;dependency&gt;  &lt;groupId&gt;com.thoughtworks.xstream&lt;&#x2F;groupId&gt;  &lt;artifactId&gt;xstream">
<meta property="og:type" content="article">
<meta property="og:title" content="Cursory Analysis Of XStream">
<meta property="og:url" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/index.html">
<meta property="og:site_name" content="H3rmesk1t&#39;s Blog">
<meta property="og:description" content="简介XStream是Java类库，提供了所有的基础类型、数组、集合等类型直接转换的支持，用来将对象序列化成XML或反序列化为对象。 基本使用XStream反序列化分析采用依赖版本如下： 12345&lt;dependency&gt;  &lt;groupId&gt;com.thoughtworks.xstream&lt;&#x2F;groupId&gt;  &lt;artifactId&gt;xstream">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715220294460-c1887009-4025-4a8c-8238-e0d9d65673f3.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715238900107-c3b128a9-46c5-463a-9161-67a5edcec47e.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715239000494-2e1cb6ef-6a07-4751-b193-63c028701d7d.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715239888366-e664fa2d-30a2-443b-912c-17e422d246a4.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715239917287-4ea81b5f-1920-41aa-8340-873002524056.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715242038274-21572b05-29af-4f28-9000-e871e3f16d4b.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715242230026-77a2b16c-44d7-4ef6-93d4-52bea1200c82.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715242684422-39fad4f9-0beb-4420-9c53-b320e515d323.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715242616882-291c961a-b4b0-4fa6-ad39-971ef75488a7.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715243067217-2985c99a-a8c4-4e2d-a4c7-8c8b7ec1a2d7.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715243877083-81835d8b-eb68-440e-b928-501ec63eb141.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715248046557-41cf658f-b4c0-4dfd-9ec2-7c020e077166.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715325950620-35620fc3-e27e-41a5-a901-1f08dfbaf13f.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715326043499-f61a74df-9f00-4672-aab8-f3cf5f382633.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715326216632-0fc62418-56d5-480c-a878-2f735a8f1128.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715326440132-3c441ed8-6f4d-4554-9414-860493274958.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715326572101-f4ec0019-0424-4895-8fb9-879ce177ae4b.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715327281392-f31aee91-79ab-4175-8f4a-287f47962860.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715327340236-299b65c9-d453-4998-af6c-83564b47a77e.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715394277936-feb8616e-6cb7-464f-b93e-a8ad96efa650.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715394806948-9461c9b7-48e5-4754-a194-7e2aa19d2ce7.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395108295-5020629f-2a53-433a-9ad5-40f67a0258c1.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395163947-81a924f3-5a2e-424d-9970-e56608f5c8b3.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395192558-053e2bec-d3c1-4af7-a524-9acc65a2626b.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395516180-1ab2e059-4e68-476c-b1df-ecd328374627.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395596973-2683177b-897c-4ba9-83e2-6892a512cc58.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395749077-17227f7c-0ab3-40fa-b08d-eb8cbf8dbc9b.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395863158-0f57cfc5-8bfb-47a3-a9bc-e0cac98e94ef.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715396049436-1ff0de58-dcbb-442c-86c5-cde77eb31fc2.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715396196890-929e7be9-0eec-4147-a676-fe5b78dacc80.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715396405233-d5213e90-77be-43da-b65a-99442b0c5417.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715396511083-5d41797a-41b6-447f-b7e6-7014d2b39c7d.png">
<meta property="article:published_time" content="2023-12-01T06:52:00.000Z">
<meta property="article:modified_time" content="2024-12-19T04:38:23.651Z">
<meta property="article:author" content="H3rmesk1t">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="反序列化">
<meta property="article:tag" content="组件安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715220294460-c1887009-4025-4a8c-8238-e0d9d65673f3.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/my-logo.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/my-logo-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/my-logo.png">
        
      
    
    <!-- title -->
    <title>Cursory Analysis Of XStream</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="H3rmesk1t&#39;s Blog" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/03/14/JNDI%E6%B3%A8%E5%85%A5/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/11/06/Hessian/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&text=Cursory Analysis Of XStream"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&title=Cursory Analysis Of XStream"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&is_video=false&description=Cursory Analysis Of XStream"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Cursory Analysis Of XStream&body=Check out this article: https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&title=Cursory Analysis Of XStream"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&title=Cursory Analysis Of XStream"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&title=Cursory Analysis Of XStream"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&title=Cursory Analysis Of XStream"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&name=Cursory Analysis Of XStream&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&t=Cursory Analysis Of XStream"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">3.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Converter"><span class="toc-number">3.1.</span> <span class="toc-text">Converter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MapConverter"><span class="toc-number">3.1.1.</span> <span class="toc-text">MapConverter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TreeSetConverter-TreeMapConverter"><span class="toc-number">3.1.2.</span> <span class="toc-text">TreeSetConverter&amp;TreeMapConverter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DynamicProxyConverter"><span class="toc-number">3.1.3.</span> <span class="toc-text">DynamicProxyConverter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EventHandler"><span class="toc-number">3.2.</span> <span class="toc-text">EventHandler</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">利用手法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConvertedClosure"><span class="toc-number">5.1.</span> <span class="toc-text">ConvertedClosure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Expando"><span class="toc-number">5.2.</span> <span class="toc-text">Expando</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ImageIO-ContainsFilter"><span class="toc-number">5.3.</span> <span class="toc-text">ImageIO$ContainsFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ServiceFinder-LazyIterator"><span class="toc-number">5.4.</span> <span class="toc-text">ServiceFinder$LazyIterator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP"><span class="toc-number">6.</span> <span class="toc-text">EXP</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Cursory Analysis Of XStream
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">H3rmesk1t</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-12-01T06:52:00.000Z" class="dt-published" itemprop="datePublished">2023-12-01</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Java/">Java</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Java/" rel="tag">Java</a>, <a class="p-category" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a>, <a class="p-category" href="/tags/%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8/" rel="tag">组件安全</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>XStream是Java类库，提供了所有的基础类型、数组、集合等类型直接转换的支持，用来将对象序列化成XML或反序列化为对象。</p>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><p>XStream反序列化分析采用依赖版本如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.thoughtworks.xstream<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xstream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>定义接口类IndexInterface如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.deserialize.xstream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IndexInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">output</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>定义类Index实现IndexInterface接口如下：
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.deserialize.xstream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">implements</span> <span class="title class_">IndexInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    String name;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">output</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello, &quot;</span> + <span class="built_in">this</span>.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>定义类IndexXML实现XStream序列化与反序列化如下：
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.deserialize.xstream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.thoughtworks.xstream.XStream;</span><br><span class="line"><span class="keyword">import</span> com.thoughtworks.xstream.io.xml.DomDriver;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexXML</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        serialize();</span><br><span class="line">        deserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Index</span> <span class="variable">index</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Index</span>();</span><br><span class="line">        index.name = <span class="string">&quot;XStream&quot;</span>;</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>(<span class="keyword">new</span> <span class="title class_">DomDriver</span>());</span><br><span class="line">        <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> xStream.toXML(index);</span><br><span class="line">        System.out.println(xml);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/Users/alphag0/Desktop/Code/Java/JavaSecCode/src/main/java/org/example/deserialize/xstream/index.xml&quot;</span>);</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>(<span class="keyword">new</span> <span class="title class_">DomDriver</span>());</span><br><span class="line">        <span class="type">Index</span> <span class="variable">index</span> <span class="operator">=</span> (Index) xStream.fromXML(fileInputStream);</span><br><span class="line">        index.output();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715220294460-c1887009-4025-4a8c-8238-e0d9d65673f3.png"></p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a><font style="color:rgb(31, 35, 40);">Converter</font></h3><p>Converter的职责是提供一种策略，用于在对象图中找到的特定类型的对象与XML之间的转换，XStream为Java的常见类型（原始类型、字符串、文件、集合、数组和日期等）提供了Converter转换器。简而言之，就是输入XML后它能识别其中的标签字段并转换为相应的对象，反之亦然。</p>
<p>转换器需要实现的三个方法：</p>
<ul>
<li>canConvert方法：告诉XStream对象，它能够转换的对象</li>
<li>marshal方法：将对象转换为XML时候的具体操作</li>
<li>unmarshal方法：将XML转换为对象时的具体操作</li>
</ul>
<h4 id="MapConverter"><a href="#MapConverter" class="headerlink" title="MapConverter"></a>MapConverter</h4><p>MapConverter是针对Map类型还原的Converter，跟进com.thoughtworks.xstream.converters.collections#unmarshal方法，依次调用unmarshal方法、populateMap方法和putCurrentEntryIntoMap方法，在putCurrentEntryIntoMap方法中会调用Map#put方法，后续就是对key调用hashCode函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">populateMap</span><span class="params">(HierarchicalStreamReader reader, UnmarshallingContext context, Map map)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.populateMap(reader, context, map, map);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">populateMap</span><span class="params">(HierarchicalStreamReader reader, UnmarshallingContext context, Map map, Map target)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(reader.hasMoreChildren()) &#123;</span><br><span class="line">        reader.moveDown();</span><br><span class="line">        <span class="built_in">this</span>.putCurrentEntryIntoMap(reader, context, map, target);</span><br><span class="line">        reader.moveUp();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">putCurrentEntryIntoMap</span><span class="params">(HierarchicalStreamReader reader, UnmarshallingContext context, Map map, Map target)</span> &#123;</span><br><span class="line">    reader.moveDown();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">key</span> <span class="operator">=</span> <span class="built_in">this</span>.readItem(reader, context, map);</span><br><span class="line">    reader.moveUp();</span><br><span class="line">    reader.moveDown();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.readItem(reader, context, map);</span><br><span class="line">    reader.moveUp();</span><br><span class="line">    target.put(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="TreeSetConverter-TreeMapConverter"><a href="#TreeSetConverter-TreeMapConverter" class="headerlink" title="TreeSetConverter&amp;TreeMapConverter"></a><font style="color:#080808;background-color:#ffffff;">TreeSetConverter&amp;</font><font style="color:#080808;background-color:#ffffff;">TreeMapConverter</font></h4><p><font style="color:#080808;">TreeSetConverter</font><font style="color:#080808;">的反序列化处理方式为先转化为</font><font style="color:#080808;">TreeMapConverter</font><font style="color:#080808;">的方式，优先还原</font><font style="color:#080808;">TreeSet</font><font style="color:#080808;">里的</font><font style="color:#080808;">TreeMap</font><font style="color:#080808;">，再填充到</font><font style="color:#080808;">TreeSet</font><font style="color:#080808;">中。</font></p>
<p><font style="color:#080808;">从</font><font style="color:#080808;">TreeSetConverter</font><font style="color:#080808;">的调用来看看整个的调用过程，先从</font><font style="color:#080808;">TreeSet</font><font style="color:#080808;">中提取出</font><font style="color:#080808;">TreeMap</font><font style="color:#080808;">，接着调用</font><font style="color:#080808;">TreeMapConverter</font><font style="color:#080808;">来还原</font><font style="color:#080808;">TreeMap</font><font style="color:#080808;">。在</font><font style="color:#080808;">TreeMapConverter</font><font style="color:#080808;">中利用</font><font style="color:#080808;">sortedMap</font><font style="color:#080808;">来填充需要还原的</font><font style="color:#080808;">Entry</font><font style="color:#080808;">，这里会回到上文提到的</font><font style="color:#080808;">MapConverter</font><font style="color:#080808;">类中的</font><font style="color:#080808;">populateMap</font><font style="color:#080808;">和</font><font style="color:#080808;">putCurrentEntryIntoMap</font><font style="color:#080808;">方法，最后调用</font><font style="color:#080808;">TreeMap#putAll</font><font style="color:#080808;">方法，调用到</font><font style="color:#080808;">java.util.AbstractMap#putAll</font><font style="color:#080808;">方法。 </font></p>
<p> <img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715238900107-c3b128a9-46c5-463a-9161-67a5edcec47e.png"></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715239000494-2e1cb6ef-6a07-4751-b193-63c028701d7d.png"></p>
<h4 id="DynamicProxyConverter"><a href="#DynamicProxyConverter" class="headerlink" title="DynamicProxyConverter"></a><font style="color:#080808;background-color:#ffffff;">DynamicProxyConverter</font></h4><p> 	DynamicProxyConverter，即动态代理转换器，支持对动态代理的方式进行还原，使得XStream能够把XML内容反序列化转换为动态代理类对象，使用Proxy动态代理，可以扩展前面两种Converter自动调用函数的攻击面。</p>
<h3 id="EventHandler"><a href="#EventHandler" class="headerlink" title="EventHandler"></a><font style="color:rgb(31, 35, 40);">EventHandler</font></h3><p>EventHandler类是一个实现了InvocationHandler的类，EventHandler类定义的代码如下：其含有target和action属性，函数调用链为EventHandler.invoke-&gt;EventHandler.invokeInternal-&gt;MethodUtil.invoke。</p>
<p>在invokeInternal方法中，首先会判断调用的函数名是否为hashCode、equals和toString，由于需要利用到后续部分的MethodUtil#invoke方法，因此上文提到的Map相关的Converter无法利用，但是可以利用TreeSet去触发compareTo函数。</p>
<p>后面就是利用Java反射机制来实现函数调用，并且变量target和action都是可控的，对于参数action需要满足：</p>
<ul>
<li>无参数类型函数（ProcessBuilder#start、JdbcRowSetImpl#getDatabaseMetaData等）</li>
<li>单个参数类型函数，且参数类型为Comparable，并且这个函数是可利用的</li>
</ul>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715239888366-e664fa2d-30a2-443b-912c-17e422d246a4.png"></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715239917287-4ea81b5f-1920-41aa-8340-873002524056.png"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">string</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dynamic-proxy</span>&gt;</span> <span class="comment">&lt;!-- Proxy 动态代理，handler使用EventHandler --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span>&gt;</span>java.lang.Comparable<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">handler</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.EventHandler&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>open<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>/System/Applications/Calculator.app<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">action</span>&gt;</span>start<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.deserialize.xstream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.thoughtworks.xstream.XStream;</span><br><span class="line"><span class="keyword">import</span> com.thoughtworks.xstream.io.xml.DomDriver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VulnXML</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;src/main/java/org/example/deserialize/xstream/CVE-2013-7285.xml&quot;</span>);</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>(<span class="keyword">new</span> <span class="title class_">DomDriver</span>());</span><br><span class="line">        <span class="type">Index</span> <span class="variable">index</span> <span class="operator">=</span> (Index) xStream.fromXML(fileInputStream);</span><br><span class="line">        index.output();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在xStream.fromXML处下断点，<font style="color:rgb(32, 32, 32);">同时在</font><font style="color:rgb(32, 32, 32);">EventHandler#invoke</font><font style="color:rgb(32, 32, 32);">方法和</font><font style="color:rgb(32, 32, 32);">EventHandler#invokeInternal</font><font style="color:rgb(32, 32, 32);">方法上也添加断点。</font></p>
<p>在多次调用<font style="color:#080808;">unmarshal</font><font style="color:#080808;">方法后，进入</font><font style="color:#080808;">com.thoughtworks.xstream.core.AbstractTreeMarshallingStrategy#unmarshal</font><font style="color:#080808;">方法，调用</font><font style="color:#080808;">TreeUnmarshaller#start</font><font style="color:#080808;">方法解析</font><font style="color:#080808;">XML</font><font style="color:#080808;">内容。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715242038274-21572b05-29af-4f28-9000-e871e3f16d4b.png"></p>
<p>跟进<font style="color:#080808;">TreeUnmarshaller#start</font><font style="color:#080808;">方法，调用</font><font style="color:#080808;">HierarchicalStreams#readClassType</font><font style="color:#080808;">方法来获取</font><font style="color:#080808;">XML</font><font style="color:#080808;">中根标签的类型。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715242230026-77a2b16c-44d7-4ef6-93d4-52bea1200c82.png"></p>
<p><font style="color:rgb(32, 32, 32);">接着调用</font><font style="color:#080808;">TreeUnmarshaller#</font><font style="color:rgb(32, 32, 32);">convertAnother</font><font style="color:rgb(32, 32, 32);">方法对</font><font style="color:rgb(32, 32, 32);">java.util.SortedSet</font><font style="color:rgb(32, 32, 32);">类型进行转换，跟进</font><font style="color:#080808;">TreeUnmarshaller#</font><font style="color:rgb(32, 32, 32);">convertAnother</font><font style="color:rgb(32, 32, 32);">方法，调用</font><font style="color:#080808;">com.thoughtworks.xstream.mapper.AnnotationMapper</font><font style="color:rgb(32, 32, 32);">#defaultImplementationOf</font><font style="color:rgb(32, 32, 32);">方法来寻找</font><font style="color:rgb(32, 32, 32);">java.util.SortedSet</font><font style="color:rgb(32, 32, 32);">类型的默认实现类型进行替换，替换为</font><font style="color:rgb(32, 32, 32);">java.util.TreeSet</font><font style="color:rgb(32, 32, 32);">类型。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715242684422-39fad4f9-0beb-4420-9c53-b320e515d323.png"></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715242616882-291c961a-b4b0-4fa6-ad39-971ef75488a7.png"></p>
<p><font style="color:rgb(32, 32, 32);">接着调用</font><font style="color:#080808;">com.thoughtworks.xstream.core.DefaultConverterLookup</font><font style="color:rgb(32, 32, 32);">#lookupConverterForType</font><font style="color:rgb(32, 32, 32);">方法来寻找</font><font style="color:rgb(32, 32, 32);">TreeSet</font><font style="color:rgb(32, 32, 32);">对应类型的转换器。跟进</font><font style="color:#080808;">DefaultConverterLookup</font><font style="color:rgb(32, 32, 32);">#lookupConverterForType</font><font style="color:rgb(32, 32, 32);">方法方法，通过调用</font><font style="color:rgb(32, 32, 32);">Converter#canConvert</font><font style="color:rgb(32, 32, 32);">方法来判断该转换器是否能够转换出</font><font style="color:rgb(32, 32, 32);">TreeSet</font><font style="color:rgb(32, 32, 32);">类型，这里找到满足条件的</font><font style="color:rgb(32, 32, 32);">TreeSetConverter</font><font style="color:rgb(32, 32, 32);">转换器，接着调用</font><font style="color:rgb(32, 32, 32);">typeToConverterMap#put</font><font style="color:rgb(32, 32, 32);">方法将类型和转换器的对应关系放入</font><font style="color:rgb(32, 32, 32);">Map</font><font style="color:rgb(32, 32, 32);">表中，再返回转换器。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715243067217-2985c99a-a8c4-4e2d-a4c7-8c8b7ec1a2d7.png"></p>
<p>接着回到<font style="color:rgb(32, 32, 32);">AbstractReferenceUnmarshaller#convert</font><font style="color:rgb(32, 32, 32);">方法，调用</font><font style="color:rgb(32, 32, 32);">getCurrentReferenceKey</font><font style="color:rgb(32, 32, 32);">方法来获取当前的</font><font style="color:rgb(32, 32, 32);">Reference</font><font style="color:rgb(32, 32, 32);">键，即标签名，并将当前标签名压入</font><font style="color:rgb(32, 32, 32);">parentStack</font><font style="color:rgb(32, 32, 32);">栈中。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715243877083-81835d8b-eb68-440e-b928-501ec63eb141.png"></p>
<p>接着调用父类的convert方法，将类型压入栈，<font style="color:rgb(32, 32, 32);">然后调用转换器</font><font style="color:rgb(32, 32, 32);">TreeSetConverter</font><font style="color:rgb(32, 32, 32);">的</font><font style="color:rgb(32, 32, 32);">unmarshal</font><font style="color:rgb(32, 32, 32);">方法。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715248046557-41cf658f-b4c0-4dfd-9ec2-7c020e077166.png"></p>
<p>跟进<font style="color:rgb(32, 32, 32);">TreeSetConverter#unmarshal</font><font style="color:rgb(32, 32, 32);">方法，这里就回到了上文分析</font><font style="color:rgb(32, 32, 32);">TreeSetConverter</font><font style="color:rgb(32, 32, 32);">时的逻辑了，调用</font><font style="color:rgb(32, 32, 32);">TreeMapConverter#</font><font style="color:#080808;">populateTreeMap</font><font style="color:#080808;">方法。</font></p>
<p><font style="color:rgb(32, 32, 32);">跟进</font><font style="color:rgb(32, 32, 32);">TreeMapConverter#</font><font style="color:#080808;">populateTreeMap</font><font style="color:#080808;">方法，先判断是否是第一个元素，是的话调用</font><font style="color:#080808;">putCurrentEntryIntoMap</font><font style="color:#080808;">方法，跟进，调用</font><font style="color:#080808;">readItem</font><font style="color:#080808;">方法读取标签内容，并将当前内容缓存到</font><font style="color:#080808;">Map</font><font style="color:#080808;">中。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715325950620-35620fc3-e27e-41a5-a901-1f08dfbaf13f.png"></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715326043499-f61a74df-9f00-4672-aab8-f3cf5f382633.png"></p>
<p>接着调用<font style="color:#080808;">com.thoughtworks.xstream.io.xml.AbstractDocumentReader#moveUp</font><font style="color:#080808;">方法，往下继续读取其他元素，然后调用</font><font style="color:#080808;">populateMap</font><font style="color:#080808;">方法。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715326216632-0fc62418-56d5-480c-a878-2f735a8f1128.png"></p>
<p>跟进<font style="color:#080808;">populateMap</font><font style="color:#080808;">方法，</font><font style="color:rgb(32, 32, 32);">调用</font><font style="color:rgb(32, 32, 32);">populateCollection</font><font style="color:rgb(32, 32, 32);">方法，用来循环遍历子标签中的元素并添加到集合中，先将动态代理标签添加进集合中，接着调用</font><font style="color:rgb(32, 32, 32);">readItem</font><font style="color:rgb(32, 32, 32);">方法读取标签内容，成功获取到了动态代理类并添加到</font><font style="color:rgb(32, 32, 32);">Map</font><font style="color:rgb(32, 32, 32);">中缓存起来。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715326440132-3c441ed8-6f4d-4554-9414-860493274958.png"></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715326572101-f4ec0019-0424-4895-8fb9-879ce177ae4b.png"></p>
<p><font style="color:rgb(32, 32, 32);">调用完</font><font style="color:rgb(32, 32, 32);">populateMap</font><font style="color:rgb(32, 32, 32);">方法后，会判断</font><font style="color:rgb(32, 32, 32);">JVM</font><font style="color:rgb(32, 32, 32);">是否已充分将</font><font style="color:rgb(32, 32, 32);">TreeMap</font><font style="color:rgb(32, 32, 32);">都缓存起来了，然后调用</font><font style="color:rgb(32, 32, 32);">TreeMap</font><font style="color:rgb(32, 32, 32);">类的</font><font style="color:rgb(32, 32, 32);">putAll</font><font style="color:rgb(32, 32, 32);">方法，可看到参数中包含动态代理类，该代理类指向</font><font style="color:rgb(32, 32, 32);">EventHandler</font><font style="color:rgb(32, 32, 32);">类，而该类正如上文介绍时说的那样通过传入</font><font style="color:rgb(32, 32, 32);">target</font><font style="color:rgb(32, 32, 32);">和</font><font style="color:rgb(32, 32, 32);">action</font><font style="color:rgb(32, 32, 32);">参数值来利用反射机制调用了</font><font style="color:rgb(32, 32, 32);">ProcessBuilder(cmd).start()</font><font style="color:rgb(32, 32, 32);">来执行任意命令。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715327281392-f31aee91-79ab-4175-8f4a-287f47962860.png"></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715327340236-299b65c9-d453-4998-af6c-83564b47a77e.png"></p>
<p>由于动态代理类的机制，接着会调用到<font style="color:rgb(32, 32, 32);">EventHandler#invoke</font><font style="color:rgb(32, 32, 32);">方法，通过安全管理器获得权限来执行</font><font style="color:rgb(32, 32, 32);">EventHandler#invokeInternal</font><font style="color:rgb(32, 32, 32);">方法，在</font><font style="color:rgb(32, 32, 32);">EventHandler#invokeInternal</font><font style="color:rgb(32, 32, 32);">方法中，当获取到目标动态代理类对象的实际方法后，就直接通过反射机制调用，实现命令执行。</font></p>
<h2 id="利用手法"><a href="#利用手法" class="headerlink" title="利用手法"></a>利用手法</h2><p>除了上文提到的<font style="color:rgb(32, 32, 32);">EventHandler#invokeInternal</font><font style="color:rgb(32, 32, 32);">方法的反射机制调用实现命令执行，还有几种其它的利用姿势实现命令执行。</font></p>
<h3 id="ConvertedClosure"><a href="#ConvertedClosure" class="headerlink" title="ConvertedClosure"></a><font style="color:rgba(0, 0, 0, 0.87);">ConvertedClosure</font></h3><p>在Groovy 2.4.3版本之前，MethodClosure方法支持被反序列化调用，可以利用MethodClosure方法封装需要执行的对象，例如new MethodClosure(Runtime.getRuntime(), “exec”);。</p>
<p>ConvertedClosure方法继承了InvocationHandler，会调用父类org.codehaus.groovy.runtime.ConversionHandler的invoke方法，接着再调用ConvertedClosure#invokeCustom方法，此时属性均可控，可以去调用去调用前面构造好的MethodClosure，结合TreeSetConverter实现命令执行。</p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715394277936-feb8616e-6cb7-464f-b93e-a8ad96efa650.png"></p>
<h3 id="Expando"><a href="#Expando" class="headerlink" title="Expando"></a><font style="color:rgba(0, 0, 0, 0.87);">Expando</font></h3><p>在groovy.util.Expando#hashCode方法中，<font style="color:rgba(0, 0, 0, 0.87);">如果在类属性</font>expandoProperties<font style="color:rgba(0, 0, 0, 0.87);">中存在</font>hashCode:methodclosure<font style="color:rgba(0, 0, 0, 0.87);">的内容，便可以直接调用</font>MethodClosure<font style="color:rgba(0, 0, 0, 0.87);">的</font>call<font style="color:rgba(0, 0, 0, 0.87);">函数，跟上文</font>ConvertedClosure<font style="color:rgba(0, 0, 0, 0.87);">后续的调用一样，但是这里调用时没有函数参数进来，因此这里的思路可以是</font>ProcessBuilder.start<font style="color:rgba(0, 0, 0, 0.87);">或者</font><font style="color:rgba(0, 0, 0, 0.87);">fastjson</font><font style="color:rgba(0, 0, 0, 0.87);">那种</font><font style="color:rgba(0, 0, 0, 0.87);">getters</font><font style="color:rgba(0, 0, 0, 0.87);">的利用，结合</font><font style="color:rgba(0, 0, 0, 0.87);">Map</font><font style="color:rgba(0, 0, 0, 0.87);">类型触发</font><font style="color:rgba(0, 0, 0, 0.87);">hashCode</font><font style="color:rgba(0, 0, 0, 0.87);">实现命令执行。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715394806948-9461c9b7-48e5-4754-a194-7e2aa19d2ce7.png"></p>
<h3 id="ImageIO-ContainsFilter"><a href="#ImageIO-ContainsFilter" class="headerlink" title="ImageIO$ContainsFilter"></a>ImageIO$ContainsFilter</h3><p>在jdk.nashorn.internal.objects.NativeString#hashCode方法中会调用getStringValue方法，而getStringValue方法中的value类型为CharSequence。因此，接下来要找可以利用的CharSequence的实现类，这里用到的是com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data#toString方法。</p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395108295-5020629f-2a53-433a-9ad5-40f67a0258c1.png"></p>
<p>跟进com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data#toString方法，先调用get方法，接着<font style="color:rgba(0, 0, 0, 0.87);">会去调用</font>ByteArrayOutputStreamEx#readFrom方法<font style="color:rgba(0, 0, 0, 0.87);">。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395163947-81a924f3-5a2e-424d-9970-e56608f5c8b3.png"></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395192558-053e2bec-d3c1-4af7-a524-9acc65a2626b.png"></p>
<p>跟进ByteArrayOutputStreamEx#readFrom方法，这里的is是可控的，<font style="color:rgba(0, 0, 0, 0.87);">因为这里调用的</font>this.dataHandler.getDataSource().getInputStream()<font style="color:rgba(0, 0, 0, 0.87);">，他的值传递都可以用类属性的方式把他构建出来。</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. this.dataHandler == 构造好的DataHandler</span><br><span class="line">2. DataHandler的dataSource属性 == 构造好的XmlDataSource</span><br><span class="line">3. XmlDataSource调用getInputStream()函数返回构造好的inputStream</span><br><span class="line"></span><br><span class="line">// com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource</span><br></pre></td></tr></table></figure>

<p><font style="color:rgba(0, 0, 0, 0.87);">用这种方法就可以获取一个可控的</font>inputStream<font style="color:rgba(0, 0, 0, 0.87);">，并且后续会继续调用</font>javax.crypto.CipherInputStream#read方法，跟进javax.crypto.CipherInputStream#read方法，调用getMoreData方法，<font style="color:rgba(0, 0, 0, 0.87);">此时需要构造一个</font>Cipher<font style="color:rgba(0, 0, 0, 0.87);">类型，并且后续调用</font>Cipher.update<font style="color:rgba(0, 0, 0, 0.87);">方法，这里可以用</font>javax.crypto.NullCipher<font style="color:rgba(0, 0, 0, 0.87);">来填充，因为最终用到的是父类</font>Cipher.update<font style="color:rgba(0, 0, 0, 0.87);">，只要不重载</font>update<font style="color:rgba(0, 0, 0, 0.87);">，其他的子类也可以。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395516180-1ab2e059-4e68-476c-b1df-ecd328374627.png"><br><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395596973-2683177b-897c-4ba9-83e2-6892a512cc58.png"></p>
<p>跟进Cipher#update方法，最终调用到serviceIterator#next<font style="color:rgba(0, 0, 0, 0.87);">方法。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395749077-17227f7c-0ab3-40fa-b08d-eb8cbf8dbc9b.png"></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715395863158-0f57cfc5-8bfb-47a3-a9bc-e0cac98e94ef.png"></p>
<p>跟进javax.imageio.spi.FilterIterator#next方法，调用advance方法。</p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715396049436-1ff0de58-dcbb-442c-86c5-cde77eb31fc2.png"></p>
<p>跟进advance方法，<font style="color:rgba(0, 0, 0, 0.87);">ImageIO</font><font style="color:rgba(0, 0, 0, 0.87);">存在一个有趣的</font><font style="color:rgba(0, 0, 0, 0.87);">filter</font><font style="color:rgba(0, 0, 0, 0.87);">，</font>javax.imageio.ImageIO.ContainsFilter#filter，这里调用该filter方法，跟进发现<font style="color:rgba(0, 0, 0, 0.87);">可以指定一个</font><font style="color:rgba(0, 0, 0, 0.87);">Method</font><font style="color:rgba(0, 0, 0, 0.87);">对象去</font><font style="color:rgba(0, 0, 0, 0.87);">invoke</font><font style="color:rgba(0, 0, 0, 0.87);">，利用</font><font style="color:rgba(0, 0, 0, 0.87);">Java</font><font style="color:rgba(0, 0, 0, 0.87);">反射机制了，提前构造好</font><font style="color:rgba(0, 0, 0, 0.87);">method</font><font style="color:rgba(0, 0, 0, 0.87);">对象，就可以调用任意的函数。</font></p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715396196890-929e7be9-0eec-4147-a676-fe5b78dacc80.png"></p>
<h3 id="ServiceFinder-LazyIterator"><a href="#ServiceFinder-LazyIterator" class="headerlink" title="ServiceFinder$LazyIterator"></a>ServiceFinder$LazyIterator</h3><p>在上文ImageIO$ContainsFilter的构造方式的核心是在于可以去触发Iterator.next，因此寻找其它触发Iterator.next的方式也可以实现命令执行的目的，这里选择java.util.ServiceLoader.LazyIterator#next方法。</p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715396405233-d5213e90-77be-43da-b65a-99442b0c5417.png"></p>
<p>当类属性acc为空时，会去调用nextService函数，而在该函数里面，存在Class.forName的调用，并且去实例化的classname、loader，都是类属性，属于可以控制的东西，到了这里自然而然的就想到了使用BCEL的ClassLoader来载入classname里的字节码。</p>
<p><img src="/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/1715396511083-5d41797a-41b6-447f-b7e6-7014d2b39c7d.png"></p>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>XStream的POC在官方的安全通告中都给出来了，<a target="_blank" rel="noopener" href="https://x-stream.github.io/security.html">https://x-stream.github.io/security.html</a>。</p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">3.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Converter"><span class="toc-number">3.1.</span> <span class="toc-text">Converter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MapConverter"><span class="toc-number">3.1.1.</span> <span class="toc-text">MapConverter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TreeSetConverter-TreeMapConverter"><span class="toc-number">3.1.2.</span> <span class="toc-text">TreeSetConverter&amp;TreeMapConverter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DynamicProxyConverter"><span class="toc-number">3.1.3.</span> <span class="toc-text">DynamicProxyConverter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EventHandler"><span class="toc-number">3.2.</span> <span class="toc-text">EventHandler</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">利用手法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConvertedClosure"><span class="toc-number">5.1.</span> <span class="toc-text">ConvertedClosure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Expando"><span class="toc-number">5.2.</span> <span class="toc-text">Expando</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ImageIO-ContainsFilter"><span class="toc-number">5.3.</span> <span class="toc-text">ImageIO$ContainsFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ServiceFinder-LazyIterator"><span class="toc-number">5.4.</span> <span class="toc-text">ServiceFinder$LazyIterator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP"><span class="toc-number">6.</span> <span class="toc-text">EXP</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&text=Cursory Analysis Of XStream"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&title=Cursory Analysis Of XStream"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&is_video=false&description=Cursory Analysis Of XStream"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Cursory Analysis Of XStream&body=Check out this article: https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&title=Cursory Analysis Of XStream"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&title=Cursory Analysis Of XStream"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&title=Cursory Analysis Of XStream"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&title=Cursory Analysis Of XStream"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&name=Cursory Analysis Of XStream&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://h3rmesk1t.github.io/2023/12/01/XStream-Deserialization-Vulnerability-Analysis/&t=Cursory Analysis Of XStream"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    H3rmesk1t
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'H3rmesk1t/h3rmesk1t.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = '💬';
      var utterances_theme = 'github-light';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
